# E2E Test Debug

失敗したE2Eテストの詳細なデバッグと修正を行うコマンドです。

## 概要

E2Eテストの失敗を詳細に分析し、根本原因を特定して修正案を提示します。

## 実行内容

```
Task(
  description="E2Eテストデバッグ",
  subagent_type="e2e-test-runner",
  prompt="""
  失敗したE2Eテストの詳細デバッグを実行してください：
  
  1. **環境診断**
     - Ghostプロセスの状態確認
     - サーバーのヘルスチェック（curl でエンドポイント確認）
     - データベース接続確認
     - ログファイルの確認
  
  2. **UIモードでの実行**
     - `pnpm run test:e2e:ui`を使用
     - ステップバイステップで問題箇所を特定
     - スクリーンショットとビデオの確認
  
  3. **詳細分析**
     - セレクタの検証（要素が存在するか）
     - ネットワークリクエストの確認
     - コンソールエラーの収集
     - タイミング問題の検出
  
  4. **コード検証**
     - テストコードの確認
     - 実装コードとの整合性チェック
     - 最近の変更履歴の確認（git log）
  
  5. **修正提案**
     - 具体的な修正コード
     - 代替アプローチの提示
     - 予防策の提案
  
  6. **検証手順**
     - 修正後のテスト手順
     - 回帰テストの必要性
  
  すべての情報を詳細に記録し、問題解決のための完全なレポートを作成してください。
  """
)
```

## 使用例

```bash
# 特定のテストをデバッグ
/e2e-debug "支出登録テスト"

# 最後に失敗したテストをデバッグ
/e2e-debug --last-failed

# verboseモードで実行
/e2e-debug --verbose
```

## デバッグチェックリスト

- [ ] サーバーは正常に起動しているか
- [ ] APIエンドポイントは応答しているか
- [ ] データベースにテストデータは存在するか
- [ ] ブラウザコンソールにエラーはないか
- [ ] ネットワークタブで失敗したリクエストはないか
- [ ] セレクタは正しく要素を選択できているか
- [ ] 非同期処理は適切に待機されているか
- [ ] 環境変数は正しく設定されているか

## トラブルシューティングマトリックス

| 症状 | 可能性のある原因 | 対処法 |
|------|-----------------|--------|
| タイムアウト | サーバー未起動、遅いレスポンス | Ghost確認、waitFor調整 |
| セレクタエラー | DOM変更、要素未レンダリング | data-testid追加、wait追加 |
| 認証エラー | セッション切れ、Cookie問題 | テストユーザー再作成 |
| データ不整合 | DB状態、シードデータ | DB再セットアップ |
| ランダム失敗 | レースコンディション | 適切な待機処理追加 |