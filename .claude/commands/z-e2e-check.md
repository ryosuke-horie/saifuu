# E2E Test Check Workflow

E2Eテストの実行、エラー解決、実装の検証を行うワークフローです。

## ワークフロー概要

このコマンドは以下の手順でE2Eテストを包括的にチェックします：

1. **事前準備**: 開発サーバーの起動状態確認
2. **E2Eテスト実行**: e2e-test-runnerエージェントによる実行
3. **結果分析**: エラーや失敗の詳細分析
4. **修正提案**: 問題がある場合の修正方針提示
5. **再実行**: 修正後の再テスト

## 実行手順

### Step 1: 環境準備の確認

まず、現在の開発環境の状態を確認します：

```bash
# Ghostプロセスの確認
ghost list

# 必要に応じてサーバーを起動
ghost run pnpm run dev
ghost run "cd api && pnpm run dev"
```

### Step 2: E2Eテスト実行

e2e-test-runnerエージェントを使用してE2Eテストを実行：

```
Task(
  description="E2Eテスト実行と検証",
  subagent_type="e2e-test-runner",
  prompt="""
  以下の手順でE2Eテストを実行してください：
  
  1. 開発サーバーの起動確認
     - フロントエンド（http://localhost:3000）
     - API（http://localhost:5173）
  
  2. E2Eテストの実行
     - `pnpm run test:e2e`を実行
     - すべてのテストケースの結果を記録
  
  3. エラー分析
     - 失敗したテストケースの詳細を分析
     - スクリーンショットやエラーログを確認
     - 根本原因を特定
  
  4. 実装の検証
     - テストコードと実装コードの整合性確認
     - セレクタやデータの不一致を検出
  
  5. 報告
     - テスト結果のサマリー
     - 失敗の原因と修正提案
     - 実装の問題点の指摘
  """
)
```

### Step 3: エラー修正（必要な場合）

テストが失敗した場合、適切なエージェントで修正：

#### フロントエンドのエラーの場合：
```
Task(
  description="フロントエンドエラー修正",
  subagent_type="frontend-developer",
  prompt="""
  E2Eテストで検出された以下のエラーを修正してください：
  [エラー内容をここに記載]
  
  修正後は必ずGhostでサーバーを再起動してください。
  """
)
```

#### バックエンドのエラーの場合：
```
Task(
  description="バックエンドエラー修正",
  subagent_type="backend-developer",
  prompt="""
  E2Eテストで検出された以下のAPIエラーを修正してください：
  [エラー内容をここに記載]
  
  修正後は必ずGhostでAPIサーバーを再起動してください。
  """
)
```

### Step 4: 修正後の再テスト

```
Task(
  description="修正後のE2E再テスト",
  subagent_type="e2e-test-runner",
  prompt="""
  修正が完了したので、以下を実行してください：
  
  1. サーバーの再起動確認
     - Ghostプロセスを確認し、必要なら再起動
  
  2. E2Eテストの再実行
     - 特に修正した箇所に関連するテストを重点的に確認
  
  3. 全体のテスト実行
     - すべてのE2Eテストが通ることを確認
  
  4. 最終報告
     - すべてのテストが成功したことを報告
  """
)
```

## 使用例

### 基本的な使用方法
```
/e2e-check
```

### 特定の機能のテスト
```
/e2e-check 支出登録機能
```

### デバッグモードでの実行
```
/e2e-check --debug
```

## チェックリスト

E2Eテスト実行時の確認事項：

- [ ] Ghostで開発サーバーが起動している
- [ ] APIサーバーが起動している
- [ ] データベースが正しくセットアップされている
- [ ] テスト用のシードデータが投入されている
- [ ] ブラウザが正しく起動できる
- [ ] ネットワーク接続が安定している

## トラブルシューティング

### よくある問題と対処法

1. **サーバーが起動していない**
   ```bash
   ghost run pnpm run dev
   ghost run "cd api && pnpm run dev"
   ```

2. **ポートが既に使用されている**
   ```bash
   ghost list
   ghost stop <task-id>
   # 再起動
   ```

3. **データベースエラー**
   ```bash
   cd api && pnpm run db:setup:dev
   ```

4. **タイムアウトエラー**
   - テストのタイムアウト値を調整
   - ネットワーク状態を確認
   - サーバーのレスポンス時間を確認

## 実装検証のポイント

e2e-test-runnerが確認する実装の問題：

1. **セレクタの不一致**
   - data-testid属性の有無
   - クラス名やID の変更
   - DOM構造の変更

2. **データの不整合**
   - APIレスポンスとUIの表示の不一致
   - バリデーションエラー
   - 型定義の不一致

3. **非同期処理の問題**
   - 適切なwaitの不足
   - Promise処理のエラー
   - レースコンディション

4. **状態管理の問題**
   - グローバル状態の不整合
   - キャッシュの問題
   - セッション管理のエラー

## 報告フォーマット

E2Eテスト結果の報告形式：

```
## E2Eテスト実行結果

### サマリー
- 実行テスト数: X件
- 成功: Y件
- 失敗: Z件
- スキップ: W件

### 失敗したテスト
1. テスト名: [テスト名]
   - エラー内容: [詳細]
   - 原因: [分析結果]
   - 修正提案: [具体的な修正方法]

### 実装の問題点
- [検出された問題と改善提案]

### 次のアクション
- [推奨される対応]
```

## 注意事項

- 必ずGhostを使用してサーバーを管理すること
- コード修正後は必ずサーバーを再起動すること
- E2Eテストのシナリオ変更時はユーザーに確認を取ること
- テスト環境と開発環境のデータベースを混同しないこと