---
description: サブエージェントを使用してPRレビューに自動対応（ブランチ名検証付き）
argument-hint: <owner> <repo> <pull_number>
---

# レビューコメント自動対応（ブランチ検証版）

## 概要
プルリクエストのレビューコメントを専門エージェントのチェーンで対応します。
各エージェントは前のエージェントの出力を受け取り、専門的な処理を実行します。
**重要**: 現在のGitブランチ名と対象PRの整合性を検証し、誤ったPRへの操作を防ぎます。

## ブランチ検証の仕組み
- Gitブランチ名の形式: `feat/issue-{番号}`, `fix/issue-{番号}`, `docs/issue-{番号}` など
- PR番号とIssue番号の関連性を確認
- 不一致の場合は処理を中断し、明確なエラーメッセージを表示

## エージェントチェーンと依存関係

### 0. `branch-validator` - ブランチとPRの整合性確認
**入力**: PR番号（owner, repo, pull_number）
**処理**:
- 現在のGitブランチ名を取得（`git branch --show-current`）
- ブランチ名からIssue番号を抽出（例: `feat/issue-123` → `123`）
- GitHub APIでPRの関連Issue番号を取得
- ブランチのIssue番号とPRの関連Issue番号が一致するか確認
- 不一致の場合は処理を中断
**出力**: 検証結果（続行可否の判定）

### 1. `review-reader` - コメント取得と分析
**入力**: PR番号（owner, repo, pull_number）と検証結果
**処理**:
- MCPツールでレビューコメント取得
- GraphQL APIでリゾルブ状態確認
- 未解決コメントのみをフィルタリング
- 現在のブランチ名も出力に含める
**出力**: 構造化されたコメント情報（JSON形式）とブランチ情報

### 2. 専門エージェント - 修正実装
**選択される専門エージェント**:
- `frontend-developer`: UI/UXコンポーネント、クライアントサイドロジックの修正時
- `backend-developer`: API、データベース、サーバーサイドロジックの修正時

**入力**: review-readerの出力（コメント分析結果とブランチ情報）
**処理**:
- 指摘内容に基づく修正実装
- 既存コードパターンの踏襲
- TDDサイクル（Red→Green→Refactor）での実装
- テスト・リント・型チェックの実行
- **重要**: ブランチ情報を常に意識し、対象ファイルの修正のみ実施
**出力**: 修正完了ファイルリストと変更内容の要約

### 3. `review-responder` - レビューへの返信
**入力**: 
- review-readerの出力（コメントIDとthread_ID、ブランチ情報）
- フレームワーク専門エージェントの出力（修正内容）
**処理**:
- 修正内容を簡潔に説明する返信文作成
- GitHub APIで各コメントに返信
- **重要**: 返信前に再度PR番号とブランチの整合性を確認
**出力**: 返信完了の確認

### 4. `git-operations` - コミットとプッシュ
**入力**: 
- 修正されたファイルの状態
- コメント対応の要約
- ブランチ情報
**処理**:
- 現在のブランチ名を再確認
- 変更のステージング
- 意味のあるコミットメッセージ作成（Issue番号を含める）
- 正しいブランチへのプッシュ
**出力**: プッシュ完了の確認

## 実行例
```
引数: owner=myorg repo=myrepo pr=123
現在のブランチ: feat/issue-123
→ 検証OK、処理続行

引数: owner=myorg repo=myrepo pr=456
現在のブランチ: feat/issue-123
→ エラー: ブランチ issue-123 と PR #456 が一致しません
```

## セーフティネット
1. **初期検証**: 処理開始前にブランチとPRの整合性を確認
2. **継続的確認**: 各エージェントでブランチ情報を引き継ぎ
3. **最終確認**: GitHub API操作前に再度検証
4. **エラーハンドリング**: 不一致時は即座に停止し、詳細なエラー情報を提供

## 注意事項
- 各エージェントは独立したコンテキストで動作
- エラー発生時は該当エージェントで停止し、詳細を報告
- 専門エージェントは対象ファイルに基づいて自動選択
  - フロントエンド: `frontend-developer`（UI、コンポーネント、ページ）
  - バックエンド: `backend-developer`（API、データベース、ビジネスロジック）
- 両エージェントともt-wadaのTDDとMatt Pocock氏の型定義方針に従う
- **並列作業時の安全性**: 複数のPRを並行して作業する場合でも、ブランチ検証により誤った操作を防止