# ビジュアルテストベースライン管理ガイド

## 概要

このガイドでは、Saifuuプロジェクトにおけるビジュアルテストのベースライン画像管理について詳しく説明します。ビジュアルテストは、UIコンポーネントの視覚的な変更を自動的に検出し、品質を保証するための重要な仕組みです。

## アーキテクチャ

### 構成要素

```
frontend/
├── __vis__/                          # ベースライン画像（Git管理対象）
├── __vis_backup__/                   # バックアップ画像
├── scripts/
│   ├── baseline-manager.sh           # ベースライン管理スクリプト
│   ├── ci-baseline-manager.sh        # CI環境用スクリプト
│   └── visual-test.sh                # 既存のビジュアルテストヘルパー
├── visual-test.config.json           # ビジュアルテスト設定
├── visual-test-artifacts/            # CI生成アーティファクト（Git除外）
└── visual-test-reports/              # レポート出力ディレクトリ
```

### 技術スタック

- **ビジュアルテスト**: storybook-addon-vis + Vitest
- **ベースライン管理**: カスタムBashスクリプト
- **CI/CD**: GitHub Actions (セルフホストランナー)
- **画像形式**: PNG
- **バージョン管理**: Git + 特別な.gitattributes設定

## 基本的な使用方法

### 1. ベースライン管理スクリプトの使用

```bash
# 実行権限の付与
chmod +x scripts/baseline-manager.sh

# 基本的なコマンド
./scripts/baseline-manager.sh status          # 現在の状態確認
./scripts/baseline-manager.sh create          # 新規ベースライン作成
./scripts/baseline-manager.sh update --backup # バックアップ付きで更新
./scripts/baseline-manager.sh validate        # 整合性の検証
```

### 2. 日常的なワークフロー

#### 新しいコンポーネントの追加
```bash
# 1. Storybookストーリーの作成
# 2. visual-testタグの追加
# 3. ベースライン画像の作成
./scripts/baseline-manager.sh create

# 4. 結果の確認
./scripts/baseline-manager.sh status

# 5. Git コミット
git add __vis__/
git commit -m "feat: 新しいコンポーネントのベースライン画像を追加"
```

#### 既存コンポーネントの修正
```bash
# 1. コンポーネントの修正
# 2. ビジュアルテストの実行
npm run test:visual

# 3. 差分の確認
./scripts/baseline-manager.sh diff

# 4. 意図した変更の場合、ベースラインを更新
./scripts/baseline-manager.sh update --backup

# 5. Git コミット
git add __vis__/
git commit -m "fix: コンポーネントの視覚的修正をベースラインに反映"
```

## 詳細コマンドリファレンス

### baseline-manager.sh

#### 基本コマンド

```bash
# ベースライン画像の作成
./scripts/baseline-manager.sh create [オプション]

# ベースライン画像の更新
./scripts/baseline-manager.sh update [オプション]

# 不要なベースライン画像の削除
./scripts/baseline-manager.sh clean [オプション]

# ベースライン画像の状態確認
./scripts/baseline-manager.sh status

# ベースライン画像の整合性検証
./scripts/baseline-manager.sh validate

# 差分画像の確認
./scripts/baseline-manager.sh diff
```

#### バックアップ・復元

```bash
# バックアップの作成
./scripts/baseline-manager.sh backup

# バックアップ一覧の表示
./scripts/baseline-manager.sh restore

# 特定のバックアップから復元
./scripts/baseline-manager.sh restore backup_20231201_120000
```

#### 高度な操作

```bash
# 旧形式からの移行
./scripts/baseline-manager.sh migrate

# 乾燥実行（実際の変更なしで実行内容を確認）
./scripts/baseline-manager.sh create --dry-run

# 強制実行（確認なしで実行）
./scripts/baseline-manager.sh update --force

# バックアップ付きで更新
./scripts/baseline-manager.sh update --backup

# 特定のコンポーネントのみ対象
./scripts/baseline-manager.sh clean --component Dialog
```

### オプション詳細

| オプション | 説明 | 適用コマンド |
|-----------|------|-------------|
| `--force` | 確認なしで実行 | create, update, clean |
| `--backup` | 実行前にバックアップを作成 | update, clean |
| `--dry-run` | 実際の変更なしで実行内容を表示 | create, update, clean |
| `--component` | 特定のコンポーネントのみ対象 | clean |
| `--story` | 特定のストーリーのみ対象 | clean |
| `--viewport` | 特定のビューポートのみ対象 | clean |

## CI/CD統合

### GitHub Actions設定

現在のプロジェクトでは、`.github/workflows/visual-tests.yml`でビジュアルテストが自動実行されています。

#### CI環境での動作

```yaml
# プルリクエスト時の自動実行
on:
  pull_request:
    paths:
      - 'frontend/**'
      - '**/*.stories.*'

# 環境変数での制御
env:
  ENABLE_VISUAL_TESTS: true
  FAIL_ON_CHANGES: true
```

#### CI専用スクリプト

```bash
# CI環境でのテスト実行
./scripts/ci-baseline-manager.sh test

# CI環境でのベースライン作成
./scripts/ci-baseline-manager.sh create

# CI環境でのベースライン更新
./scripts/ci-baseline-manager.sh update
```

### アーティファクトの取り扱い

#### 自動生成されるアーティファクト

1. **visual-test-results-{run-number}**
   - 差分画像
   - 新規ベースライン画像
   - サマリーレポート

2. **visual-test-logs-{run-number}**
   - 詳細なテストログ
   - Storybookビルド成果物

#### アーティファクトの利用方法

```bash
# 1. GitHub Actionsからアーティファクトをダウンロード
# 2. 差分画像を確認
# 3. 必要に応じてベースライン更新
./scripts/baseline-manager.sh update --backup
```

## 設定ファイル

### visual-test.config.json

プロジェクトの設定は`visual-test.config.json`で管理されています。

#### 主要な設定項目

```json
{
  "thresholds": {
    "default": {
      "threshold": 0.1,
      "diffThreshold": 0.15
    },
    "strict": {
      "threshold": 0.05,
      "diffThreshold": 0.1
    },
    "animation": {
      "threshold": 0.25,
      "diffThreshold": 0.3
    }
  },
  "viewports": {
    "mobile": { "width": 375, "height": 667 },
    "tablet": { "width": 768, "height": 1024 },
    "desktop": { "width": 1280, "height": 800 }
  },
  "delays": {
    "default": 200,
    "animation": 500,
    "interaction": 100
  }
}
```

#### コンポーネント分類

```json
{
  "componentCategories": {
    "ui": {
      "thresholds": "strict",
      "viewports": ["mobile", "desktop"],
      "delay": 200
    },
    "modals": {
      "thresholds": "animation",
      "viewports": ["mobile", "tablet", "desktop"],
      "delay": 500
    }
  }
}
```

## Git統合

### .gitattributes設定

ベースライン画像は適切にGitで管理されるよう、`.gitattributes`で設定されています：

```gitattributes
# ベースライン画像をバイナリファイルとして扱う
**/__vis__/**/*.png binary

# 差分画像は管理対象外
**/__vis__/**/*-diff.png linguist-generated
**/__vis__/**/*-actual.png linguist-generated
```

### 推奨されるGitワークフロー

#### 1. ベースライン画像の追加

```bash
# ベースライン作成
./scripts/baseline-manager.sh create

# ステージング
git add __vis__/

# コミット
git commit -m "feat: 新しいコンポーネントのベースライン画像を追加"
```

#### 2. ベースライン画像の更新

```bash
# バックアップ付きで更新
./scripts/baseline-manager.sh update --backup

# 差分の確認
git diff --stat

# コミット
git add __vis__/
git commit -m "fix: コンポーネントの視覚的修正をベースラインに反映"
```

#### 3. 大きな変更の場合

```bash
# 事前バックアップ
./scripts/baseline-manager.sh backup

# 段階的な更新
./scripts/baseline-manager.sh update --component Dialog
git add __vis__/
git commit -m "fix: Dialogコンポーネントのベースライン更新"

# 他のコンポーネントも同様に更新
```

## トラブルシューティング

### よくある問題と解決方法

#### 1. ベースライン画像の差分が大きすぎる

**原因**: しきい値設定が厳しすぎる

**解決方法**:
```bash
# 設定の確認
./scripts/baseline-manager.sh validate

# 緩い設定での再テスト
# visual-test.config.jsonのthresholdを調整
```

#### 2. 孤立したベースライン画像

**原因**: 対応するストーリーファイルが削除された

**解決方法**:
```bash
# 孤立ファイルの確認
./scripts/baseline-manager.sh validate

# 孤立ファイルの削除
./scripts/baseline-manager.sh clean
```

#### 3. CI環境でのテスト失敗

**原因**: 環境固有の差異（フォント、レンダリング等）

**解決方法**:
```bash
# CI環境の設定確認
./scripts/ci-baseline-manager.sh check

# 環境固有の設定調整
# visual-test.config.jsonのci.environmentsを調整
```

#### 4. 大量の差分画像

**原因**: 大きなUI変更やライブラリ更新

**解決方法**:
```bash
# 段階的な更新
./scripts/baseline-manager.sh backup
./scripts/baseline-manager.sh update --component Header
./scripts/baseline-manager.sh update --component Dialog
# 各コンポーネントごとに確認してコミット
```

#### 5. バックアップからの復元

**原因**: 意図しない変更をロールバック

**解決方法**:
```bash
# 利用可能なバックアップの確認
./scripts/baseline-manager.sh restore

# 特定のバックアップから復元
./scripts/baseline-manager.sh restore backup_20231201_120000
```

### デバッグ方法

#### 1. 詳細ログの確認

```bash
# 詳細モードでの実行
DEBUG=true ./scripts/baseline-manager.sh status

# CIログの確認
./scripts/ci-baseline-manager.sh check
```

#### 2. 手動でのテスト実行

```bash
# 個別のストーリーテスト
npm run test:visual -- --testNamePattern="Dialog"

# 特定のビューポートのみ
npm run test:visual -- --testNamePattern="mobile"
```

#### 3. 設定の検証

```bash
# 設定ファイルの検証
node -e "console.log(JSON.parse(require('fs').readFileSync('visual-test.config.json', 'utf8')))"

# 整合性の確認
./scripts/baseline-manager.sh validate
```

## パフォーマンスの最適化

### 1. 並列実行の調整

```json
{
  "performance": {
    "parallelJobs": 4,
    "timeout": 30000,
    "maxMemory": "4gb"
  }
}
```

### 2. 選択的テスト実行

```bash
# 変更があったコンポーネントのみ
./scripts/baseline-manager.sh update --component ChangedComponent

# 特定のビューポートのみ
./scripts/baseline-manager.sh create --viewport mobile
```

### 3. バックアップの効率化

```bash
# 自動バックアップの設定
./scripts/baseline-manager.sh update --backup

# 古いバックアップの削除
find __vis_backup__ -name "backup_*" -mtime +30 -exec rm -rf {} \;
```

## セキュリティ考慮事項

### 1. 機密情報の除去

- ベースライン画像に機密情報が含まれていないか確認
- テストデータはモックデータを使用
- 実際のユーザーデータは使用しない

### 2. アクセス制御

- ベースライン画像のGit管理権限を適切に設定
- CI環境でのアーティファクト保持期間を制限
- バックアップファイルの適切な管理

## ベストプラクティス

### 1. 定期的なメンテナンス

```bash
# 週次で実行
./scripts/baseline-manager.sh validate
./scripts/baseline-manager.sh clean

# 月次で実行
./scripts/baseline-manager.sh backup
```

### 2. チーム開発での協調

- ベースライン画像の変更は必ずレビューを経る
- 大きな変更は段階的に実施
- CI失敗時は速やかに対応

### 3. ドキュメント更新

- 新しいコンポーネント追加時はこのガイドを更新
- 設定変更時は理由と影響を記録
- トラブルシューティング情報を蓄積

## 今後の拡張計画

### 1. 自動化の強化

- PRで自動的にベースライン画像を更新
- 定期的なベースライン健全性チェック
- 自動的な古いバックアップの削除

### 2. 新機能の追加

- 複数ブランチ間での差分比較
- より詳細なレポート生成
- Slack通知との連携

### 3. パフォーマンスの向上

- 増分ベースライン更新
- 並列処理の最適化
- キャッシュ機能の追加

## 関連資料

- [Storybookビジュアルテスト設定ガイド](./Storybookビジュアルテスト設定ガイド.md)
- [ビジュアルテスト実装サマリー](./ビジュアルテスト実装サマリー.md)
- [visual-test.config.json設定リファレンス](../visual-test.config.json)
- [GitHub Actions Visual Test Workflow](../../.github/workflows/visual-tests.yml)

---

*最終更新: 2025-01-07*
*メンテナー: ryosuke-horie*