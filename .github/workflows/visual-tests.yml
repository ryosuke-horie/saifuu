name: Visual Regression Tests (Self-hosted)

on:
  pull_request:
    paths:
      - 'frontend/**'
      - '.github/workflows/visual-tests.yml'
      - '.storybook/**'
      - '**/*.stories.*'
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - '.github/workflows/visual-tests.yml'
      - '.storybook/**'
      - '**/*.stories.*'

# GitHub Actionsç„¡æ–™æž ç¯€ç´„ã®ãŸã‚ã€åŒä¸€PRã§è¤‡æ•°å®Ÿè¡Œæ™‚ã¯å‰ã®å®Ÿè¡Œã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  visual-tests:
    name: Visual Regression Tests
    runs-on: self-hosted
    timeout-minutes: 30
    
    # PRã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã¨ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜æ¨©é™ã‚’è¿½åŠ 
    permissions:
      contents: read
      pull-requests: write
      actions: write
    
    defaults:
      run:
        working-directory: frontend
    
    # ç’°å¢ƒå¤‰æ•°ã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰ã‚’åˆ¶å¾¡
    env:
      NODE_ENV: test
      CI: true
      # ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒ†ã‚¹ãƒˆç”¨ã®è¨­å®š
      ENABLE_VISUAL_TESTS: true
      VITEST_SEGFAULT_RETRY: 3
      # ã‚»ãƒ«ãƒ•ãƒ›ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼å‘ã‘ã®æœ€é©åŒ–è¨­å®š
      FORCE_COLOR: 1
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '22'
          # ã‚»ãƒ«ãƒ•ãƒ›ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼ã®åˆ¶ç´„ã«ã‚ˆã‚Šã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯ç„¡åŠ¹
          # cache: 'npm'
          # cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build Storybook
        run: |
          echo "Building Storybook for visual testing..."
          npm run build-storybook
      
      # ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå‰ã®ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ç¢ºèª
      - name: Check existing visual baselines
        run: |
          if [ -d "__vis__" ]; then
            echo "Visual baselines found:"
            find __vis__ -name "*.png" | head -10
            echo "Total baseline images: $(find __vis__ -name "*.png" | wc -l)"
          else
            echo "No visual baselines found. This may be the first run."
          fi
      
      # ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      - name: Run visual regression tests
        run: |
          echo "Running visual regression tests..."
          npm run test:visual -- --run --reporter=verbose
        continue-on-error: true
        id: visual-test
      
      # ãƒ†ã‚¹ãƒˆçµæžœã®ç¢ºèªã¨ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆæº–å‚™
      - name: Collect visual test results
        run: |
          echo "Collecting visual test results..."
          
          # å·®åˆ†ç”»åƒã®ç¢ºèª
          if [ -d "__vis__" ]; then
            echo "Visual test artifacts found:"
            find __vis__ -type f -name "*.png" | head -20
            
            # å·®åˆ†ç”»åƒã®ç‰¹å®š
            DIFF_COUNT=$(find __vis__ -name "*diff*.png" 2>/dev/null | wc -l)
            echo "DIFF_COUNT=${DIFF_COUNT}" >> $GITHUB_ENV
            
            # æ–°ã—ã„ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ç”»åƒã®ç¢ºèª
            NEW_BASELINE_COUNT=$(find __vis__ -name "*actual*.png" 2>/dev/null | wc -l)
            echo "NEW_BASELINE_COUNT=${NEW_BASELINE_COUNT}" >> $GITHUB_ENV
            
            # çµæžœã‚µãƒžãƒªãƒ¼æº–å‚™
            echo "Visual test summary:" > visual-test-summary.txt
            echo "- Diff images: ${DIFF_COUNT}" >> visual-test-summary.txt
            echo "- New baseline images: ${NEW_BASELINE_COUNT}" >> visual-test-summary.txt
            echo "- Total test artifacts: $(find __vis__ -name "*.png" | wc -l)" >> visual-test-summary.txt
          else
            echo "No visual test artifacts found"
            echo "DIFF_COUNT=0" >> $GITHUB_ENV
            echo "NEW_BASELINE_COUNT=0" >> $GITHUB_ENV
          fi
        
      # å·®åˆ†ç”»åƒãŒã‚ã‚‹å ´åˆã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜
      - name: Upload visual test artifacts
        if: always() && (env.DIFF_COUNT > 0 || env.NEW_BASELINE_COUNT > 0)
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: visual-test-results-${{ github.run_number }}
          path: |
            frontend/__vis__/**/*.png
            frontend/visual-test-summary.txt
          retention-days: 30
          if-no-files-found: warn
      
      # å®Œå…¨ãªãƒ†ã‚¹ãƒˆçµæžœãƒ­ã‚°ã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜
      - name: Upload detailed test logs
        if: always()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: visual-test-logs-${{ github.run_number }}
          path: |
            frontend/test-results/**/*
            frontend/storybook-static/**/*
          retention-days: 7
          if-no-files-found: ignore
      
      # PRã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ï¼ˆãƒ†ã‚¹ãƒˆçµæžœã®è¦ç´„ï¼‰
      - name: Comment PR with visual test results
        if: github.event_name == 'pull_request' && always()
        run: |
          # ãƒ†ã‚¹ãƒˆçµæžœã®åˆ¤å®š
          if [ "${{ steps.visual-test.outcome }}" = "success" ]; then
            STATUS="âœ… PASSED"
            STATUS_COLOR="28a745"
          else
            STATUS="âŒ FAILED"
            STATUS_COLOR="d73a49"
          fi
          
          # ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ã®ä½œæˆ
          cat > visual_test_comment.md << 'EOF'
          ## ðŸŽ¨ Visual Regression Test Results
          
          **Status**: $STATUS
          
          ### ðŸ“Š Test Summary
          
          | Metric | Count |
          |--------|-------|
          | **Diff Images** | ${{ env.DIFF_COUNT }} |
          | **New Baselines** | ${{ env.NEW_BASELINE_COUNT }} |
          | **Workflow Run** | [${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |
          
          ### ðŸ” Review Guidelines
          
          EOF
          
          # å·®åˆ†ãŒã‚ã‚‹å ´åˆã®è¿½åŠ æƒ…å ±
          if [ "${{ env.DIFF_COUNT }}" -gt 0 ]; then
            cat >> visual_test_comment.md << 'EOF'
          
          âš ï¸ **Visual differences detected!**
          
          1. Download the `visual-test-results-${{ github.run_number }}` artifact from the workflow run
          2. Review the diff images in the `__vis__` folder
          3. If changes are intentional, update baselines by running:
             ```bash
             cd frontend
             npm run test:visual -- --update-snapshots
             ```
          4. Commit the updated baseline images
          
          EOF
          elif [ "${{ env.NEW_BASELINE_COUNT }}" -gt 0 ]; then
            cat >> visual_test_comment.md << 'EOF'
          
          ðŸ†• **New visual baselines created!**
          
          New components or stories detected. Please review the generated baseline images:
          
          1. Download the `visual-test-results-${{ github.run_number }}` artifact
          2. Review the new baseline images
          3. If they look correct, commit them to establish the baselines
          
          EOF
          else
            cat >> visual_test_comment.md << 'EOF'
          
          ðŸŽ‰ **No visual differences detected!**
          
          All visual regression tests passed. Your UI changes maintain visual consistency.
          
          EOF
          fi
          
          cat >> visual_test_comment.md << 'EOF'
          
          ### ðŸ› ï¸ Troubleshooting
          
          If you encounter issues:
          - Check the [Visual Testing Guide](../docs/ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆå®Ÿè£…ã‚¬ã‚¤ãƒ‰.md)
          - Review the detailed logs in `visual-test-logs-${{ github.run_number }}` artifact
          - Ensure your stories are properly configured with vis tags
          
          ---
          
          _Generated by GitHub Actions â€¢ Visual Testing Workflow_
          EOF
          
          # PRã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
          gh pr comment ${{ github.event.number }} --body-file visual_test_comment.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # ãƒ†ã‚¹ãƒˆå¤±æ•—æ™‚ã®è©³ç´°æƒ…å ±å‡ºåŠ›
      - name: Display test failure details
        if: steps.visual-test.outcome == 'failure'
        run: |
          echo "::error title=Visual Regression Test Failed::Visual regression tests detected UI changes"
          echo "::notice title=Next Steps::Review the visual differences and update baselines if changes are intentional"
          echo ""
          echo "Detailed failure information:"
          echo "- Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "- Diff images: ${{ env.DIFF_COUNT }}"
          echo "- New baselines: ${{ env.NEW_BASELINE_COUNT }}"
          echo ""
          echo "To fix failing tests:"
          echo "1. Download and review the visual-test-results artifact"
          echo "2. If changes are intentional, update baselines locally"
          echo "3. Commit the updated baseline images"
      
      # æœ€çµ‚çš„ãªãƒ†ã‚¹ãƒˆçµæžœã®åˆ¤å®š
      - name: Final test result
        if: steps.visual-test.outcome == 'failure'
        run: |
          echo "Visual regression tests failed. Please review the differences."
          exit 1