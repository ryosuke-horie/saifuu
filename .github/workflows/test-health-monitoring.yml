name: Test Health Monitoring

on:
  # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§è‡ªå‹•å®Ÿè¡Œ
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'frontend/**'
      - 'api/**'
      - 'scripts/monitor-test-ratio*.js'
      - '.github/workflows/test-health-monitoring.yml'
  # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®pushã§å®Ÿè¡Œ
  push:
    branches:
      - main
  # å®šæœŸå®Ÿè¡Œï¼ˆæ¯é€±æœˆæ›œæ—¥ã®æœ9æ™‚ï¼‰
  schedule:
    - cron: '0 0 * * 1'
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:

jobs:
  test-metrics:
    name: Test Health Metrics
    runs-on: self-hosted
    timeout-minutes: 20
    
    permissions:
      contents: read
      pull-requests: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '22'
      
      # ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰æ¯”ç‡ã®ç›£è¦–
      - name: Check test code ratio
        id: test_ratio
        run: |
          echo "## ğŸ” ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰æ¯”ç‡åˆ†æ" > test_ratio_report.md
          echo "" >> test_ratio_report.md
          
          # ãƒ†ã‚¹ãƒˆæ¯”ç‡ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
          node scripts/monitor-test-ratio-simple.js >> test_ratio_output.txt 2>&1 || true
          
          # çµæœã‚’ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã«æ•´å½¢
          if grep -q "âŒ åŸºæº–é•åãƒ•ã‚¡ã‚¤ãƒ«" test_ratio_output.txt; then
            echo "### âš ï¸ ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰æ¯”ç‡ã®åŸºæº–é•åãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ" >> test_ratio_report.md
            echo "" >> test_ratio_report.md
            echo "ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ãŒéå‰°ã«ãªã£ã¦ã„ã¾ã™ï¼š" >> test_ratio_report.md
            echo "" >> test_ratio_report.md
            echo "\`\`\`" >> test_ratio_report.md
            grep -A 4 "åŸºæº–é•åãƒ•ã‚¡ã‚¤ãƒ«" test_ratio_output.txt | tail -n +2 | head -20 >> test_ratio_report.md
            echo "\`\`\`" >> test_ratio_report.md
            echo "violation_found=true" >> $GITHUB_OUTPUT
          else
            echo "### âœ… ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰æ¯”ç‡åŸºæº–å†…ã§ã™" >> test_ratio_report.md
            echo "violation_found=false" >> $GITHUB_OUTPUT
          fi
          
          # å…¨ä½“çµ±è¨ˆã‚’è¿½åŠ 
          echo "" >> test_ratio_report.md
          echo "### ğŸ“Š å…¨ä½“çµ±è¨ˆ" >> test_ratio_report.md
          grep -A 5 "å…¨ä½“çµ±è¨ˆ" test_ratio_output.txt >> test_ratio_report.md
      
      # Frontend ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚é–“ã®è¨ˆæ¸¬
      - name: Measure Frontend test execution time
        working-directory: frontend
        run: |
          echo "## â±ï¸ Frontend ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚é–“" > frontend_test_time.md
          echo "" >> frontend_test_time.md
          
          # ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          npm ci
          
          # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚é–“ã‚’è¨ˆæ¸¬
          START_TIME=$(date +%s)
          npm run test:unit -- --reporter=json > test_results.json 2>&1 || true
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          
          echo "- **å®Ÿè¡Œæ™‚é–“**: ${DURATION}ç§’" >> frontend_test_time.md
          
          # ãƒ†ã‚¹ãƒˆæ•°ã‚’æŠ½å‡º
          if [ -f test_results.json ]; then
            TEST_COUNT=$(jq -r '.numTotalTests // 0' test_results.json 2>/dev/null || echo "0")
            PASS_COUNT=$(jq -r '.numPassedTests // 0' test_results.json 2>/dev/null || echo "0")
            echo "- **ãƒ†ã‚¹ãƒˆç·æ•°**: ${TEST_COUNT}" >> frontend_test_time.md
            echo "- **æˆåŠŸæ•°**: ${PASS_COUNT}" >> frontend_test_time.md
          fi
          
          # å®Ÿè¡Œæ™‚é–“ã®è­¦å‘Šé–¾å€¤ï¼ˆ60ç§’ï¼‰
          if [ $DURATION -gt 60 ]; then
            echo "" >> frontend_test_time.md
            echo "âš ï¸ **è­¦å‘Š**: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚é–“ãŒ60ç§’ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚ãƒ†ã‚¹ãƒˆã®æœ€é©åŒ–ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚" >> frontend_test_time.md
          fi
      
      # API ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚é–“ã®è¨ˆæ¸¬
      - name: Measure API test execution time
        working-directory: api
        run: |
          echo "## â±ï¸ API ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚é–“" > api_test_time.md
          echo "" >> api_test_time.md
          
          # ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          npm ci
          
          # ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚é–“ã‚’è¨ˆæ¸¬
          START_TIME=$(date +%s)
          npm run test:unit -- --reporter=json > unit_test_results.json 2>&1 || true
          END_TIME=$(date +%s)
          UNIT_DURATION=$((END_TIME - START_TIME))
          
          echo "### ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ" >> api_test_time.md
          echo "- **å®Ÿè¡Œæ™‚é–“**: ${UNIT_DURATION}ç§’" >> api_test_time.md
          
          # çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚é–“ã‚’è¨ˆæ¸¬
          START_TIME=$(date +%s)
          npm run test:integration -- --reporter=json > integration_test_results.json 2>&1 || true
          END_TIME=$(date +%s)
          INTEGRATION_DURATION=$((END_TIME - START_TIME))
          
          echo "" >> api_test_time.md
          echo "### çµ±åˆãƒ†ã‚¹ãƒˆ" >> api_test_time.md
          echo "- **å®Ÿè¡Œæ™‚é–“**: ${INTEGRATION_DURATION}ç§’" >> api_test_time.md
          
          TOTAL_DURATION=$((UNIT_DURATION + INTEGRATION_DURATION))
          echo "" >> api_test_time.md
          echo "### åˆè¨ˆ" >> api_test_time.md
          echo "- **ç·å®Ÿè¡Œæ™‚é–“**: ${TOTAL_DURATION}ç§’" >> api_test_time.md
          
          # å®Ÿè¡Œæ™‚é–“ã®è­¦å‘Šé–¾å€¤ï¼ˆ90ç§’ï¼‰
          if [ $TOTAL_DURATION -gt 90 ]; then
            echo "" >> api_test_time.md
            echo "âš ï¸ **è­¦å‘Š**: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚é–“ãŒ90ç§’ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚ãƒ†ã‚¹ãƒˆã®æœ€é©åŒ–ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚" >> api_test_time.md
          fi
      
      # PRã‚³ãƒ¡ãƒ³ãƒˆã®ä½œæˆ
      - name: Create PR comment
        if: github.event_name == 'pull_request'
        run: |
          {
            echo "# ğŸ“‹ ãƒ†ã‚¹ãƒˆãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãƒ¬ãƒãƒ¼ãƒˆ"
            echo ""
            cat test_ratio_report.md
            echo ""
            echo "---"
            echo ""
            cat frontend/frontend_test_time.md
            echo ""
            echo "---"
            echo ""
            cat api/api_test_time.md
            echo ""
            echo "---"
            echo ""
            echo "_ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯ãƒ†ã‚¹ãƒˆã®å¥å…¨æ€§ã‚’ç›£è¦–ã—ã€é–‹ç™ºåŠ¹ç‡ã®å‘ä¸Šã‚’æ”¯æ´ã—ã¾ã™ã€‚_"
            echo ""
            echo "_Generated by Test Health Monitoring workflow_"
          } > health_report.md
          
          # PRã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
          node .github/scripts/update-pr-comment.js "TEST_HEALTH_REPORT" "$(cat health_report.md)"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # å®šæœŸå®Ÿè¡Œæ™‚ã¯ã‚µãƒãƒªãƒ¼ã‚’Artifactã¨ã—ã¦ä¿å­˜
      - name: Save periodic report
        if: github.event.schedule
        uses: actions/upload-artifact@c7d193f32edcb7bfad88892161225aeda64e9392 # v4.0.0
        with:
          name: test-health-report-${{ github.run_id }}
          path: |
            test_ratio_output.txt
            frontend/test_results.json
            api/unit_test_results.json
            api/integration_test_results.json
          retention-days: 30