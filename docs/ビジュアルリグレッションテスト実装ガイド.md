# ビジュアルリグレッションテスト実装ガイド

## 概要

storybook-addon-vis + Vitestを使用したビジュアルリグレッションテストの実装手順を記載したドキュメントです。

本ガイドは既存のVitest v3.2.4、Storybook v8.6.14環境への統合を前提としています。

## 前提条件

### 必要な既存環境
- **Node.js**: 22.x（miseで管理）
- **Storybook**: v8.6.14（設定済み）
- **Vitest**: v3.2.4（設定済み）
- **Playwright**: v1.53.1（設定済み）

### プロジェクト構造
本ガイドは一般的なNext.js + Storybook + Vitest構成のプロジェクトを前提としています。

## 実装手順

### ステップ1: 必要パッケージのインストール

`storybook-addon-vis`と`@storybook/addon-vitest`をdevDependenciesとしてインストールします。

### ステップ2: Vitest設定の拡張

`vitest.config.ts`に以下の要素を追加します：
- `storybookTest`プラグインのインポートと設定
- `storybookVis`プラグインのインポートと設定
- Browser Modeの有効化（provider: 'playwright', name: 'chromium'）
- スナップショット保存ディレクトリ設定（CIとローカルを分離）
- coverage設定で`__vis__/**`を除外対象に追加

### ステップ3: Vitestセットアップファイル拡張

`vitest.setup.ts`に以下の要素を追加します：
- `vis`、`visAnnotations`のインポート
- `setProjectAnnotations`でStorybookのプロジェクト設定を適用
- `vis.setup()`でビジュアルテストのライフサイクル設定
- `beforeAll`でプロジェクト設定を初期化

### ステップ4: Storybook設定の拡張

`.storybook/main.ts`のaddons配列に以下を2つを追加します：
- `"storybook-addon-vis"`
- `"@storybook/addon-vitest"`

### ステップ5: ストーリーでのビジュアルテスト有効化

コンポーネントのストーリーに`tags: ['snapshot']`を追加します。
デフォルトエクスポートに追加するとすべてのストーリーで有効になり、個別のストーリーに追加するとそのストーリーでのみ有効になります。

### ステップ6: package.jsonスクリプト追加

`package.json`のscriptsセクションに以下を3つのスクリプトを追加します：
- `test:visual`: ビジュアルテスト一回実行
- `test:visual:watch`: ビジュアルテストウォッチモード
- `test:visual:ui`: Vitest UIでのビジュアルテスト

### ステップ7: .gitignoreの更新

`.gitignore`にビジュアルテスト成果物の設定を追加します。
`__vis__/`ディレクトリを除外し、ベースラインスナップショットのみをGit管理対象とします。

## テスト実行方法

### コマンドラインからの実行

上記で追加した3つのスクリプトを使用してテストを実行します。

### Storybook UIからの実行

1. Storybookを起動
2. コンポーネントのストーリーを選択
3. ビジュアルテストウィジェットからテスト実行

### スナップショットの更新

意図的な変更時は`--update-snapshots`オプションを使用してスナップショットを更新します。


## 運用上の考慮事項

### スナップショット管理
- **初回実行**: ベースラインスナップショットの生成
- **更新**: 意図的な変更時の`--updateSnapshot`実行
- **レビュー**: 差分画像の目視確認プロセス

### CI/CD統合
- **並列実行**: テスト時間短縮のためのシャーディング
- **アーティファクト**: 失敗時の差分画像保存
- **通知**: Slack/Teams連携での結果通知

### チーム運用
- **ベースライン承認**: プルリクエストでの差分レビュープロセス
- **デザイナー連携**: 視覚的変更の事前承認ワークフロー
- **ドキュメント**: スナップショット更新の手順書

## パフォーマンス考慮事項

- GitHub Actions無料枠制約下でのテスト対象ストーリーの選別
- セルフホストランナーでの実行時間最適化
- キャッシュ戦略（現在無効だが将来的な検討）

## トラブルシューティング

### よくある問題と解決方法

#### 1. スナップショットが生成されない
- **原因**: `snapshot`タグが設定されていない
- **解決**: ストーリーに`tags: ['snapshot']`を追加

#### 2. Browser Modeでエラーが発生
- **原因**: Playwrightが正しくインストールされていない
- **解決**: `npx playwright install chromium`を実行

#### 3. スナップショットの差分が頻繁に発生
- **原因**: フォントやレンダリングの環境差
- **解決**: `snapshotRootDir`設定でCI環境とローカルを分離

#### 4. テスト実行が遅い
- **原因**: ブラウザ起動のオーバーヘッド
- **解決**: テスト対象コンポーネントを絞る、並列実行を検討

---

---

**作成日**: 2025年7月6日  
**更新日**: 2025年7月6日  
**対象Issue**: #32  
**ブランチ**: issue-32  
**関連ドキュメント**:
- [docs/ビジュアルリグレッションテスト技術選定.md](./ビジュアルリグレッションテスト技術選定.md)
- [docs/ビジュアルリグレッションテスト実装計画.md](./ビジュアルリグレッションテスト実装計画.md)