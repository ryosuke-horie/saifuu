# ビジュアルリグレッションテスト実装ガイド

## 概要

storybook-addon-vis + Vitestを使用したビジュアルリグレッションテストの実装手順を記載したドキュメントです。

本ガイドは既存のVitest v3.2.4、Storybook v8.6.14環境への統合を前提としています。

## 前提条件

### 必要な既存環境
- **Node.js**: 22.x（miseで管理）
- **Storybook**: v8.6.14（設定済み）
- **Vitest**: v3.2.4（設定済み）
- **Playwright**: v1.53.1（設定済み）

### プロジェクト構造
本ガイドは以下のプロジェクト構造を前提としています：
```
プロジェクトルート/
├── app/                   # アプリケーションコード
├── .storybook/            # Storybook設定
├── vitest.config.ts       # Vitest設定
├── vitest.setup.ts        # Vitestセットアップ
└── package.json
```

## 実装手順

### ステップ1: 必要パッケージのインストール

```bash
npm install --save-dev storybook-addon-vis @storybook/addon-vitest
```

### ステップ2: Vitest設定の拡張

`vitest.config.ts`を以下のように拡張します：

```typescript
// vitest.config.ts
import { storybookTest } from '@storybook/addon-vitest/vitest-plugin'
import { storybookVis } from 'storybook-addon-vis/vitest-plugin'
import { defineConfig } from 'vitest/config'
import path from "node:path"
import react from "@vitejs/plugin-react"

export default defineConfig({
  plugins: [
    react(),
    storybookTest(),
    storybookVis({
      snapshotRootDir: ({ ci }) => ci ? '__vis__/ci' : '__vis__/local',
    })
  ],
  resolve: {
    alias: { "@": path.resolve(__dirname, "./src") },
  },
  test: {
    environment: "jsdom",
    browser: {
      enabled: true,
      provider: 'playwright',
      name: 'chromium',
    },
    setupFiles: ['./vitest.setup.ts'],
    globals: false,
    include: ["src/**/*.{test,spec}.{js,mjs,cjs,ts,mts,cts,jsx,tsx}"],
    exclude: ["tests/**", "node_modules/**", ".next/**"],
    // 既存のcoverage設定を継承
    coverage: {
      provider: "v8",
      reporter: ["text", "json", "json-summary", "html"],
      exclude: [
        "node_modules/**",
        "tests/**",
        "**/*.test.{js,mjs,cjs,ts,mts,cts,jsx,tsx}",
        "**/*.spec.{js,mjs,cjs,ts,mts,cts,jsx,tsx}",
        "**/*.stories.{js,mjs,cjs,ts,mts,cts,jsx,tsx}",
        "**/*.config.{js,mjs,cjs,ts,mts,cts}",
        "**/types/**",
        "**/*.d.ts",
        ".next/**",
        "storybook-static/**",
        "__vis__/**", // Visual test snapshots
      ],
      include: ["src/**/*.{js,mjs,cjs,ts,mts,cts,jsx,tsx}"],
      thresholds: {
        global: {
          branches: 80,
          functions: 80,
          lines: 80,
          statements: 80,
        },
      },
    },
  },
});
```

### ステップ3: Vitestセットアップファイル拡張

`vitest.setup.ts`に以下を追加します：

```typescript
// vitest.setup.ts（既存設定に追加）
import { beforeAll } from 'vitest'
import { setProjectAnnotations } from '@storybook/react'
import { vis, visAnnotations } from 'storybook-addon-vis/vitest-setup'
import * as projectAnnotations from './.storybook/preview'

// Apply Storybook project annotations
const project = setProjectAnnotations([
  visAnnotations, // Add visual testing annotations
  projectAnnotations
])

// Setup vis lifecycle
vis.setup()

beforeAll(project.beforeAll)
```

### ステップ4: Storybook設定の拡張

`.storybook/main.ts`にアドオンを追加します：

```typescript
// .storybook/main.ts
import type { StorybookConfig } from "@storybook/nextjs";

const config: StorybookConfig = {
  stories: ["../src/**/*.mdx", "../src/**/*.stories.@(js|jsx|mjs|ts|tsx)"],
  addons: [
    "@storybook/addon-essentials",
    "@storybook/addon-a11y",
    "@storybook/addon-viewport",
    "msw-storybook-addon",
    "storybook-addon-vis",      // 追加
    "@storybook/addon-vitest",  // 追加
  ],
  framework: {
    name: "@storybook/nextjs",
    options: {},
  },
  staticDirs: ["../public"],
};
export default config;
```

### ステップ5: ストーリーでのビジュアルテスト有効化

コンポーネントのストーリーに`snapshot`タグを追加します：

```typescript
// 例: src/components/ui/Dialog.stories.tsx
export default {
  title: 'Components/ui/Dialog',
  component: Dialog,
  // すべてのストーリーでビジュアルテストを有効化
  tags: ['snapshot'],
}

// または個別ストーリーで有効化
export const Default = {
  tags: ['snapshot'],
  args: {
    // ... existing args
  },
}
```

### ステップ6: package.jsonスクリプト追加

`package.json`にビジュアルテスト用スクリプトを追加します：

```json
{
  "scripts": {
    "test:visual": "vitest run --browser", 
    "test:visual:watch": "vitest --browser",
    "test:visual:ui": "vitest --ui --browser"
  }
}
```

### ステップ7: .gitignoreの更新

ビジュアルテスト成果物を`.gitignore`に追加します：

```gitignore
# Visual regression test artifacts
__vis__/
!__vis__/ci/__baselines__
!__vis__/local/__baselines__
```

## テスト実行方法

### コマンドラインからの実行

```bash
# ビジュアルテスト実行（一度だけ）
npm run test:visual

# ビジュアルテストウォッチモード
npm run test:visual:watch

# Vitest UIでのビジュアルテスト
npm run test:visual:ui
```

### Storybook UIからの実行

1. Storybookを起動: `npm run storybook`
2. コンポーネントのストーリーを選択
3. ビジュアルテストウィジェットからテスト実行

### スナップショットの更新

```bash
# スナップショットを更新（意図的な変更時）
npm run test:visual -- --update-snapshots
```


## 運用上の考慮事項

### スナップショット管理
- **初回実行**: ベースラインスナップショットの生成
- **更新**: 意図的な変更時の`--updateSnapshot`実行
- **レビュー**: 差分画像の目視確認プロセス

### CI/CD統合
- **並列実行**: テスト時間短縮のためのシャーディング
- **アーティファクト**: 失敗時の差分画像保存
- **通知**: Slack/Teams連携での結果通知

### チーム運用
- **ベースライン承認**: プルリクエストでの差分レビュープロセス
- **デザイナー連携**: 視覚的変更の事前承認ワークフロー
- **ドキュメント**: スナップショット更新の手順書

## セキュリティ・パフォーマンス考慮事項

### セキュリティ
- スナップショットに機密情報が含まれないよう注意
- モックデータの利用徹底
- Secrets管理（API key等の適切な管理）

### パフォーマンス
- 無料枠制約下でのテスト対象ストーリーの選別
- セルフホストランナーでの実行時間最適化
- キャッシュ戦略（現在無効だが将来的な検討）

## トラブルシューティング

### よくある問題と解決方法

#### 1. スナップショットが生成されない
- **原因**: `snapshot`タグが設定されていない
- **解決**: ストーリーに`tags: ['snapshot']`を追加

#### 2. Browser Modeでエラーが発生
- **原因**: Playwrightが正しくインストールされていない
- **解決**: `npx playwright install chromium`を実行

#### 3. スナップショットの差分が頻繁に発生
- **原因**: フォントやレンダリングの環境差
- **解決**: `snapshotRootDir`設定でCI環境とローカルを分離

#### 4. テスト実行が遅い
- **原因**: ブラウザ起動のオーバーヘッド
- **解決**: テスト対象コンポーネントを絞る、並列実行を検討

---

---

**作成日**: 2025年7月6日  
**更新日**: 2025年7月6日  
**対象Issue**: #32  
**ブランチ**: issue-32  
**関連ドキュメント**:
- [docs/ビジュアルリグレッションテスト技術選定.md](./ビジュアルリグレッションテスト技術選定.md)
- [docs/ビジュアルリグレッションテスト実装計画.md](./ビジュアルリグレッションテスト実装計画.md)