# ビジュアルリグレッションテスト実装ガイド

## 概要

issue-32「Storybookを活用したコンポーネント回帰テストのsetup」に関する調査結果と実装方針をまとめたドキュメントです。

現在のプロジェクトでは既にStorybook v8.6.14、Playwright v1.53.1、@storybook/test v8.6.14が設定済みであり、これらの既存インフラストラクチャを活用してビジュアルリグレッションテストを実装できます。

## 現在のプロジェクト状況

### 既存設定
- **Storybook**: v8.6.14（インタラクションテスト対応）
- **Playwright**: v1.53.1（現在ローカル専用、CI無効）
- **@storybook/test**: v8.6.14（インタラクションテスト対応）
- **MSW**: v2.10.2（APIモック）
- **Vitest**: v3.2.4（ユニットテスト）

### CI/CD状況
- GitHub Actionsのセットアップが必要（`.github`ディレクトリ未存在）
- E2Eテストは無料枠節約のため現在無効化
- セルフホストランナー使用（キャッシュ無効設定）

## 実装アプローチ比較

## Vitestベース（統合環境重視）

現在のテストフレームワークがVitestベースのため、以下のVitest統合アプローチを優先的に検討します。

### 1. 🚀 【NEW推奨】storybook-addon-vis + Vitest

#### メリット
- ✅ **Vitest統合**: 既存のVitest環境と完全統合
- ✅ **現代的**: 2025年の最新アプローチ、TypeScript完全対応
- ✅ **自動スナップショット**: `snapshot`タグで自動ビジュアルテスト実行
- ✅ **Storybook UI**: Storybookの視覚的テストウィジェットで直接実行・確認
- ✅ **ブラウザモード**: Vitest Browser Modeで実ブラウザテスト
- ✅ **コスト**: 完全無料のオープンソース

#### デメリット
- ❌ **実験的**: 比較的新しいアドオンのため、実績が少ない
- ❌ **依存関係**: Vitest Browser Mode（実験的機能）に依存
- ❌ **学習コスト**: 新しいツールチェーンの習得が必要

#### 手動設定要件
1. `storybook-addon-vis` パッケージのインストール
2. `@storybook/addon-vitest` パッケージのインストール（Storybook Test用）
3. Vitest設定の拡張（Browser Mode + vis plugin）
4. Storybookメイン設定への両アドオン追加
5. ストーリーへの`snapshot`タグ付与

#### 実装例
```typescript
// vitest.config.ts（拡張版）
import { storybookTest } from '@storybook/addon-vitest/vitest-plugin'
import { storybookVis } from 'storybook-addon-vis/vitest-plugin'
import { defineConfig } from 'vitest/config'
import path from "node:path"
import react from "@vitejs/plugin-react"

export default defineConfig({
  plugins: [
    react(),
    storybookTest(),
    storybookVis({
      snapshotRootDir: ({ ci }) => ci ? '__vis__/ci' : '__vis__/local',
    })
  ],
  resolve: {
    alias: { "@": path.resolve(__dirname, "./src") },
  },
  test: {
    environment: "jsdom", // または browser mode
    browser: {
      enabled: true,
      provider: 'playwright',
      name: 'chromium',
    },
    setupFiles: ['./vitest.setup.ts'],
    globals: false,
    // 既存設定を継承
  },
})
```

```typescript
// vitest.setup.ts（拡張版）
import { beforeAll } from 'vitest'
import { setProjectAnnotations } from '@storybook/react'
import { vis, visAnnotations } from 'storybook-addon-vis/vitest-setup'
import * as projectAnnotations from './.storybook/preview'

const project = setProjectAnnotations([
  visAnnotations,
  projectAnnotations
])

vis.setup()
beforeAll(project.beforeAll)
```

```typescript
// .storybook/main.ts（拡張版）
import type { StorybookConfig } from "@storybook/nextjs";

const config: StorybookConfig = {
  stories: ["../src/**/*.mdx", "../src/**/*.stories.@(js|jsx|mjs|ts|tsx)"],
  addons: [
    "@storybook/addon-essentials",
    "@storybook/addon-a11y",
    "@storybook/addon-viewport",
    "msw-storybook-addon",
    "storybook-addon-vis",      // 追加
    "@storybook/addon-vitest",  // 追加
  ],
  framework: {
    name: "@storybook/nextjs",
    options: {},
  },
  staticDirs: ["../public"],
};
export default config;
```

---

### 2. 🔧 composeStories + Vitest + Custom Visual Testing

#### メリット
- ✅ **Vitest統合**: 完全にVitest環境で動作
- ✅ **ポータブルストーリー**: 公式のportable stories API活用
- ✅ **カスタマイズ**: 独自のビジュアルテストロジック実装可能
- ✅ **DOM/Visual**: DOMスナップショットから画像スナップショットまで対応

#### デメリット
- ❌ **実装コスト**: カスタムビジュアルテストロジックの実装が必要
- ❌ **保守負荷**: 独自実装のため長期保守が課題
- ❌ **ツール統合**: 画像比較ライブラリの別途統合が必要

#### 実装例
```typescript
// src/__tests__/visual-regression.test.ts
import { render } from '@testing-library/react'
import { composeStories } from '@storybook/react'
import { expect, test, describe } from 'vitest'
import * as ButtonStories from '../components/Button.stories'

const { Primary, Secondary } = composeStories(ButtonStories)

describe('Button Visual Tests', () => {
  test('Primary button visual snapshot', async () => {
    const { container } = render(<Primary />)
    
    // DOMスナップショット
    expect(container.firstChild).toMatchSnapshot()
    
    // TODO: 画像スナップショット（要カスタム実装）
    // const screenshot = await captureElementScreenshot(container.firstChild)
    // expect(screenshot).toMatchImageSnapshot()
  })
})
```

---

### 3. 🎭 Vitest Browser Mode + Playwright Component Testing

#### メリット
- ✅ **実ブラウザ**: 実際のブラウザ環境でのテスト実行
- ✅ **Playwright統合**: 既存Playwright設定の活用
- ✅ **コンポーネントテスト**: E2EとUnit testの中間的アプローチ
- ✅ **高精度**: 実ブラウザでの正確なビジュアル検証

#### デメリット
- ❌ **実験的**: Vitest Browser Modeが実験的機能
- ❌ **複雑性**: 設定とワークフローが複雑
- ❌ **初期化時間**: ブラウザ起動による実行時間の増加

#### 実装例
```typescript
// vitest.config.ts（Browser Mode版）
export default defineConfig({
  test: {
    browser: {
      enabled: true,
      provider: 'playwright',
      name: 'chromium',
    },
    // ...既存設定
  },
})
```

---

## Jestベース（従来アプローチ）

### 4. 🎯 Storybook Test Runner + jest-image-snapshot

#### メリット
- ✅ **既存インフラ活用**: 現在のStorybook設定をそのまま利用
- ✅ **統合しやすさ**: StorybookのTest Runnerと完全統合
- ✅ **コスト**: 完全無料のオープンソース
- ✅ **学習コスト**: 既存のStorybookワークフローから自然な拡張
- ✅ **CI統合**: GitHub Actionsとの親和性が高い
- ✅ **設定の柔軟性**: Jest設定で詳細なカスタマイズ可能

#### デメリット
- ❌ **初期セットアップ**: 設定ファイルの作成とCI環境の準備が必要
- ❌ **保守作業**: ベースライン画像の管理が手動
- ❌ **レビューUI**: 差分確認は基本的にCLIとファイルベース

#### 手動設定要件
1. `@storybook/test-runner`パッケージのインストール
2. `jest-image-snapshot`パッケージのインストール
3. `.storybook/test-runner.ts`設定ファイル作成
4. GitHub Actionsワークフロー設定（`.github/workflows/`）
5. スナップショット保存ディレクトリの設定

#### CI設定例
```typescript
// .storybook/test-runner.ts
import { TestRunnerConfig, waitForPageReady } from '@storybook/test-runner';
import { toMatchImageSnapshot } from 'jest-image-snapshot';

const config: TestRunnerConfig = {
  setup() {
    expect.extend({ toMatchImageSnapshot });
  },
  async postVisit(page, context) {
    await waitForPageReady(page);
    const image = await page.screenshot();
    expect(image).toMatchImageSnapshot({
      customSnapshotsDir: `${process.cwd()}/__snapshots__`,
      customSnapshotIdentifier: context.id,
    });
  },
};
export default config;
```

---

### 2. 🏢 Chromatic（Storybook公式）

#### メリット
- ✅ **公式サポート**: Storybookチームが開発・保守
- ✅ **統合度**: Storybook UIと完全統合
- ✅ **クロスブラウザ**: Chrome、Firefox、Safari、Edgeでの並列テスト
- ✅ **クラウド**: インフラ不要、レビューUIが充実
- ✅ **コラボレーション**: デザイナーとエンジニアの協働が容易

#### デメリット
- ❌ **コスト**: $149/月〜（無料枠: 5,000スクリーンショット/月）
- ❌ **ベンダーロックイン**: Chromatic依存
- ❌ **制約**: Storybookのみ対象（E2E不可）

#### 手動設定要件
1. Chromaticアカウント作成・プロジェクト設定
2. `@chromatic-com/storybook`アドオンのインストール
3. プロジェクトトークンの環境変数設定
4. GitHub Actionsでのchromatic公開設定

---

### 3. 🎭 Playwright Visual Comparisons

#### メリット
- ✅ **既存活用**: 現在のPlaywright設定を拡張
- ✅ **高性能**: 並列実行とヘッドレスモードで高速
- ✅ **柔軟性**: E2E、コンポーネント、ページ全てに対応
- ✅ **精密制御**: スクリーンショット範囲やマスキングの詳細設定

#### デメリット
- ❌ **複雑性**: E2Eとビジュアルテストの設定を分離管理
- ❌ **Storybook統合**: 直接統合には追加設定が必要
- ❌ **CI制約**: 現在無効化されているE2E環境の再有効化が必要

#### 手動設定要件
1. E2E テストワークフローの再有効化検討
2. ビジュアルテスト専用のPlaywright設定
3. GitHub Actions環境での一貫性確保設定

---

### 4. 🔧 BackstopJS

#### メリット
- ✅ **シンプル**: 設定が直感的
- ✅ **無料**: オープンソース
- ✅ **Docker対応**: 環境一貫性の確保が容易
- ✅ **レポート**: HTMLレポート自動生成

#### デメリット
- ❌ **Storybook統合**: 追加設定が複雑
- ❌ **保守**: 長期プロジェクトでのメンテナンス負荷
- ❌ **モダンさ**: 他ツールと比較して機能が限定的

---

### 5. 🚀 Lost Pixel（2025年注目株）

#### メリット
- ✅ **現代的**: TypeScript完全対応、モダンアーキテクチャ
- ✅ **多機能**: Storybook + E2E + ページテストの統合
- ✅ **無料**: オープンソース版で基本機能利用可能
- ✅ **UI**: 有料版でクラウドレビューUI提供
- ✅ **GitHub統合**: GitHub Actions専用アクション提供

#### デメリット
- ❌ **新しさ**: 比較的新しいため事例が少ない
- ❌ **学習**: 新しいツールチェーンの習得が必要
- ❌ **制約**: GitHubのみサポート（GitLab等不可）

#### 手動設定要件
1. `lost-pixel`パッケージインストール
2. `lostpixel.config.ts`設定ファイル作成
3. GitHub Actionsでのlost-pixel/lost-pixel@v3.22.0アクション設定

---

### 6. 💰 クラウドサービス比較（Percy vs Applitools）

#### Percy（by BrowserStack）
**メリット:**
- ✅ 透明な価格設定（無料枠: 5,000スクリーンショット/月）
- ✅ BrowserStackの信頼性とインフラ

**デメリット:**
- ❌ 月額コスト（有料プラン必要）

#### Applitools
**メリット:**
- ✅ AI駆動の高精度diff検出
- ✅ 企業向け機能が充実

**デメリット:**
- ❌ 価格非公開（営業問い合わせ必須）
- ❌ 高コスト（大企業向け）

---

## 推奨実装戦略

### 段階的実装アプローチ

#### フェーズ1: Vitestベース導入（NEW推奨）
1. **storybook-addon-vis + Vitest**を選択
2. 理由：
   - 既存のVitest環境と完全統合
   - 現代的なアプローチで将来性が高い
   - Storybook UIでの直感的なテスト実行
   - 完全無料
   - 実ブラウザでの正確なビジュアル検証

#### フェーズ2: 検証・拡張
- 運用を通じてVitest Browser Modeの安定性確認
- 必要に応じてJestベースアプローチ（Test Runner）への移行検討
- またはChromatic（予算がある場合）への移行検討

#### フェーズ3: 最適化
- CI/CD統合の最適化
- スナップショット管理の自動化
- レビューワークフローの改善

## 実装手順（NEW推奨アプローチ）

### ステップ1: 必要パッケージのインストール
```bash
npm install --save-dev storybook-addon-vis @storybook/addon-vitest
```

### ステップ2: Vitest設定の拡張
```typescript
// vitest.config.ts（既存設定に追加）
import { storybookTest } from '@storybook/addon-vitest/vitest-plugin'
import { storybookVis } from 'storybook-addon-vis/vitest-plugin'
import { defineConfig } from 'vitest/config'
import path from "node:path"
import react from "@vitejs/plugin-react"

export default defineConfig({
  plugins: [
    react(),
    storybookTest(),
    storybookVis({
      snapshotRootDir: ({ ci }) => ci ? '__vis__/ci' : '__vis__/local',
    })
  ],
  resolve: {
    alias: { "@": path.resolve(__dirname, "./src") },
  },
  test: {
    environment: "jsdom",
    browser: {
      enabled: true,
      provider: 'playwright',
      name: 'chromium',
    },
    setupFiles: ['./vitest.setup.ts'],
    globals: false,
    include: ["src/**/*.{test,spec}.{js,mjs,cjs,ts,mts,cts,jsx,tsx}"],
    exclude: ["tests/**", "node_modules/**", ".next/**"],
    // 既存のcoverage設定を継承
    coverage: {
      provider: "v8",
      reporter: ["text", "json", "json-summary", "html"],
      exclude: [
        "node_modules/**",
        "tests/**",
        "**/*.test.{js,mjs,cjs,ts,mts,cts,jsx,tsx}",
        "**/*.spec.{js,mjs,cjs,ts,mts,cts,jsx,tsx}",
        "**/*.stories.{js,mjs,cjs,ts,mts,cts,jsx,tsx}",
        "**/*.config.{js,mjs,cjs,ts,mts,cts}",
        "**/types/**",
        "**/*.d.ts",
        ".next/**",
        "storybook-static/**",
        "__vis__/**", // Visual test snapshots
      ],
      include: ["src/**/*.{js,mjs,cjs,ts,mts,cts,jsx,tsx}"],
      thresholds: {
        global: {
          branches: 80,
          functions: 80,
          lines: 80,
          statements: 80,
        },
      },
    },
  },
});
```

### ステップ3: Vitest セットアップファイル拡張
```typescript
// vitest.setup.ts（既存設定に追加）
import { beforeAll } from 'vitest'
import { setProjectAnnotations } from '@storybook/react'
import { vis, visAnnotations } from 'storybook-addon-vis/vitest-setup'
import * as projectAnnotations from './.storybook/preview'

// Apply Storybook project annotations
const project = setProjectAnnotations([
  visAnnotations, // Add visual testing annotations
  projectAnnotations
])

// Setup vis lifecycle
vis.setup()

beforeAll(project.beforeAll)
```

### ステップ4: Storybook設定の拡張
```typescript
// .storybook/main.ts（既存設定に追加）
import type { StorybookConfig } from "@storybook/nextjs";

const config: StorybookConfig = {
  stories: ["../src/**/*.mdx", "../src/**/*.stories.@(js|jsx|mjs|ts|tsx)"],
  addons: [
    "@storybook/addon-essentials",
    "@storybook/addon-a11y",
    "@storybook/addon-viewport",
    "msw-storybook-addon",
    "storybook-addon-vis",      // 追加
    "@storybook/addon-vitest",  // 追加
  ],
  framework: {
    name: "@storybook/nextjs",
    options: {},
  },
  staticDirs: ["../public"],
};
export default config;
```

### ステップ5: ストーリーでのビジュアルテスト有効化
```typescript
// 例: src/components/ui/Dialog.stories.tsx
export default {
  title: 'Components/ui/Dialog',
  component: Dialog,
  // すべてのストーリーでビジュアルテストを有効化
  tags: ['snapshot'],
}

// または個別ストーリーで有効化
export const Default = {
  tags: ['snapshot'],
  args: {
    // ... existing args
  },
}
```

### ステップ6: package.json スクリプト追加
```json
{
  "scripts": {
    "test:visual": "vitest run --browser", 
    "test:visual:watch": "vitest --browser",
    "test:visual:ui": "vitest --ui --browser"
  }
}
```

### ステップ7: .gitignoreの更新
```gitignore
# Visual regression test artifacts
__vis__/
!__vis__/ci/__baselines__
!__vis__/local/__baselines__
```

## 運用上の考慮事項

### スナップショット管理
- **初回実行**: ベースラインスナップショットの生成
- **更新**: 意図的な変更時の`--updateSnapshot`実行
- **レビュー**: 差分画像の目視確認プロセス

### CI/CD統合
- **並列実行**: テスト時間短縮のためのシャーディング
- **アーティファクト**: 失敗時の差分画像保存
- **通知**: Slack/Teams連携での結果通知

### チーム運用
- **ベースライン承認**: プルリクエストでの差分レビュープロセス
- **デザイナー連携**: 視覚的変更の事前承認ワークフロー
- **ドキュメント**: スナップショット更新の手順書

## セキュリティ・パフォーマンス考慮事項

### セキュリティ
- スナップショットに機密情報が含まれないよう注意
- モックデータの利用徹底
- Secrets管理（API key等の適切な管理）

### パフォーマンス
- 無料枠制約下でのテスト対象ストーリーの選別
- セルフホストランナーでの実行時間最適化
- キャッシュ戦略（現在無効だが将来的な検討）

## 結論

現在のプロジェクト状況（Vitest v3.2.4ベースのテスト環境）を考慮すると、**storybook-addon-vis + Vitest**による実装が最適解です。

### 選定理由
1. **テスト統合**: 既存のVitestテスト環境と完全統合
2. **現代性**: 2025年の最新アプローチで将来性が高い
3. **Storybook統合**: Storybook UIでの直感的なテスト実行・確認
4. **実ブラウザ**: Vitest Browser Modeによる正確なビジュアル検証
5. **コスト効率**: 完全無料で運用可能
6. **段階的導入**: 小さく始めて徐々に拡張可能

### フォールバック案
もしVitest Browser Mode（実験的機能）の安定性に懸念がある場合は、従来の**Storybook Test Runner + jest-image-snapshot**アプローチも有効です。

### Next Steps
1. **Phase 1**: storybook-addon-visによるVitest統合実装
2. **Phase 2**: 少数のコンポーネント（Dialog, Button等）でのPoC実施  
3. **Phase 3**: チームレビューと運用プロセスの確立
4. **Phase 4**: 段階的な対象コンポーネント拡大
5. **Phase 5**: CI統合とワークフロー最適化

### 技術的優位性
- **統一環境**: ユニットテスト・ビジュアルテストを同一のVitestフレームワークで実行
- **開発効率**: Storybookでのテスト実行とVitest UIでの結果確認が可能
- **保守性**: 単一のテストフレームワークによる設定・依存関係の簡素化

---

**作成日**: 2025年7月6日  
**対象Issue**: #32  
**ブランチ**: issue-32  
**調査実施者**: Claude Code