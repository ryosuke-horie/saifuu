# ビジュアルリグレッションテスト実装ガイド

## 概要

issue-32「Storybookを活用したコンポーネント回帰テストのsetup」に関する調査結果と実装方針をまとめたドキュメントです。

現在のプロジェクトでは既にStorybook v8.6.14、Playwright v1.53.1、@storybook/test v8.6.14が設定済みであり、これらの既存インフラストラクチャを活用してビジュアルリグレッションテストを実装できます。

## 現在のプロジェクト状況

### 既存設定
- **Storybook**: v8.6.14（インタラクションテスト対応）
- **Playwright**: v1.53.1（現在ローカル専用、CI無効）
- **@storybook/test**: v8.6.14（インタラクションテスト対応）
- **MSW**: v2.10.2（APIモック）
- **Vitest**: v3.2.4（ユニットテスト）

### CI/CD状況
- GitHub Actionsのセットアップが必要（`.github`ディレクトリ未存在）
- E2Eテストは無料枠節約のため現在無効化
- セルフホストランナー使用（キャッシュ無効設定）

## 実装アプローチ比較

### 1. 🎯 【推奨】Storybook Test Runner + jest-image-snapshot

#### メリット
- ✅ **既存インフラ活用**: 現在のStorybook設定をそのまま利用
- ✅ **統合しやすさ**: StorybookのTest Runnerと完全統合
- ✅ **コスト**: 完全無料のオープンソース
- ✅ **学習コスト**: 既存のStorybookワークフローから自然な拡張
- ✅ **CI統合**: GitHub Actionsとの親和性が高い
- ✅ **設定の柔軟性**: Jest設定で詳細なカスタマイズ可能

#### デメリット
- ❌ **初期セットアップ**: 設定ファイルの作成とCI環境の準備が必要
- ❌ **保守作業**: ベースライン画像の管理が手動
- ❌ **レビューUI**: 差分確認は基本的にCLIとファイルベース

#### 手動設定要件
1. `@storybook/test-runner`パッケージのインストール
2. `jest-image-snapshot`パッケージのインストール
3. `.storybook/test-runner.ts`設定ファイル作成
4. GitHub Actionsワークフロー設定（`.github/workflows/`）
5. スナップショット保存ディレクトリの設定

#### CI設定例
```typescript
// .storybook/test-runner.ts
import { TestRunnerConfig, waitForPageReady } from '@storybook/test-runner';
import { toMatchImageSnapshot } from 'jest-image-snapshot';

const config: TestRunnerConfig = {
  setup() {
    expect.extend({ toMatchImageSnapshot });
  },
  async postVisit(page, context) {
    await waitForPageReady(page);
    const image = await page.screenshot();
    expect(image).toMatchImageSnapshot({
      customSnapshotsDir: `${process.cwd()}/__snapshots__`,
      customSnapshotIdentifier: context.id,
    });
  },
};
export default config;
```

---

### 2. 🏢 Chromatic（Storybook公式）

#### メリット
- ✅ **公式サポート**: Storybookチームが開発・保守
- ✅ **統合度**: Storybook UIと完全統合
- ✅ **クロスブラウザ**: Chrome、Firefox、Safari、Edgeでの並列テスト
- ✅ **クラウド**: インフラ不要、レビューUIが充実
- ✅ **コラボレーション**: デザイナーとエンジニアの協働が容易

#### デメリット
- ❌ **コスト**: $149/月〜（無料枠: 5,000スクリーンショット/月）
- ❌ **ベンダーロックイン**: Chromatic依存
- ❌ **制約**: Storybookのみ対象（E2E不可）

#### 手動設定要件
1. Chromaticアカウント作成・プロジェクト設定
2. `@chromatic-com/storybook`アドオンのインストール
3. プロジェクトトークンの環境変数設定
4. GitHub Actionsでのchromatic公開設定

---

### 3. 🎭 Playwright Visual Comparisons

#### メリット
- ✅ **既存活用**: 現在のPlaywright設定を拡張
- ✅ **高性能**: 並列実行とヘッドレスモードで高速
- ✅ **柔軟性**: E2E、コンポーネント、ページ全てに対応
- ✅ **精密制御**: スクリーンショット範囲やマスキングの詳細設定

#### デメリット
- ❌ **複雑性**: E2Eとビジュアルテストの設定を分離管理
- ❌ **Storybook統合**: 直接統合には追加設定が必要
- ❌ **CI制約**: 現在無効化されているE2E環境の再有効化が必要

#### 手動設定要件
1. E2E テストワークフローの再有効化検討
2. ビジュアルテスト専用のPlaywright設定
3. GitHub Actions環境での一貫性確保設定

---

### 4. 🔧 BackstopJS

#### メリット
- ✅ **シンプル**: 設定が直感的
- ✅ **無料**: オープンソース
- ✅ **Docker対応**: 環境一貫性の確保が容易
- ✅ **レポート**: HTMLレポート自動生成

#### デメリット
- ❌ **Storybook統合**: 追加設定が複雑
- ❌ **保守**: 長期プロジェクトでのメンテナンス負荷
- ❌ **モダンさ**: 他ツールと比較して機能が限定的

---

### 5. 🚀 Lost Pixel（2025年注目株）

#### メリット
- ✅ **現代的**: TypeScript完全対応、モダンアーキテクチャ
- ✅ **多機能**: Storybook + E2E + ページテストの統合
- ✅ **無料**: オープンソース版で基本機能利用可能
- ✅ **UI**: 有料版でクラウドレビューUI提供
- ✅ **GitHub統合**: GitHub Actions専用アクション提供

#### デメリット
- ❌ **新しさ**: 比較的新しいため事例が少ない
- ❌ **学習**: 新しいツールチェーンの習得が必要
- ❌ **制約**: GitHubのみサポート（GitLab等不可）

#### 手動設定要件
1. `lost-pixel`パッケージインストール
2. `lostpixel.config.ts`設定ファイル作成
3. GitHub Actionsでのlost-pixel/lost-pixel@v3.22.0アクション設定

---

### 6. 💰 クラウドサービス比較（Percy vs Applitools）

#### Percy（by BrowserStack）
**メリット:**
- ✅ 透明な価格設定（無料枠: 5,000スクリーンショット/月）
- ✅ BrowserStackの信頼性とインフラ

**デメリット:**
- ❌ 月額コスト（有料プラン必要）

#### Applitools
**メリット:**
- ✅ AI駆動の高精度diff検出
- ✅ 企業向け機能が充実

**デメリット:**
- ❌ 価格非公開（営業問い合わせ必須）
- ❌ 高コスト（大企業向け）

---

## 推奨実装戦略

### 段階的実装アプローチ

#### フェーズ1: 基础導入（推奨）
1. **Storybook Test Runner + jest-image-snapshot**を選択
2. 理由：
   - 既存のStorybook設定を最大活用
   - 学習コストが最小
   - 完全無料
   - 将来的に他手法への移行も可能

#### フェーズ2: 検証・拡張
- 運用を通じてボトルネックや改善点を特定
- 必要に応じてChromatic（予算がある場合）やLost Pixel（高機能が必要な場合）への移行検討

#### フェーズ3: 最適化
- CI/CD統合の最適化
- スナップショット管理の自動化
- レビューワークフローの改善

## 実装手順（推奨アプローチ）

### ステップ1: 必要パッケージのインストール
```bash
npm install --save-dev @storybook/test-runner jest-image-snapshot
```

### ステップ2: Test Runner設定
```typescript
// .storybook/test-runner.ts
import { TestRunnerConfig, waitForPageReady } from '@storybook/test-runner';
import { toMatchImageSnapshot } from 'jest-image-snapshot';

const customSnapshotsDir = `${process.cwd()}/__snapshots__`;

const config: TestRunnerConfig = {
  setup() {
    expect.extend({ toMatchImageSnapshot });
  },
  async postVisit(page, context) {
    await waitForPageReady(page);
    const image = await page.screenshot();
    expect(image).toMatchImageSnapshot({
      customSnapshotsDir,
      customSnapshotIdentifier: context.id,
      threshold: 0.2, // 閾値調整可能
      failureThreshold: 0.01,
      failureThresholdType: 'percent',
    });
  },
};
export default config;
```

### ステップ3: package.json スクリプト追加
```json
{
  "scripts": {
    "test:visual": "test-storybook",
    "test:visual:ci": "concurrently -k -s first -n \"SB,TEST\" -c \"magenta,blue\" \"yarn build-storybook --quiet && npx http-server storybook-static --port 6006 --silent\" \"wait-on tcp:6006 && yarn test-storybook --ci\""
  }
}
```

### ステップ4: GitHub Actions設定
```yaml
# .github/workflows/visual-regression.yml
name: Visual Regression Tests
on: [push, pull_request]

jobs:
  visual-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build Storybook
        run: npm run build-storybook
      
      - name: Run visual regression tests
        run: npm run test:visual:ci
      
      - name: Upload screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: visual-regression-diffs
          path: __snapshots__
```

### ステップ5: .gitignoreの更新
```gitignore
# Visual regression test artifacts
__snapshots__/**/__diff_output__
__snapshots__/**/__received_output__
```

## 運用上の考慮事項

### スナップショット管理
- **初回実行**: ベースラインスナップショットの生成
- **更新**: 意図的な変更時の`--updateSnapshot`実行
- **レビュー**: 差分画像の目視確認プロセス

### CI/CD統合
- **並列実行**: テスト時間短縮のためのシャーディング
- **アーティファクト**: 失敗時の差分画像保存
- **通知**: Slack/Teams連携での結果通知

### チーム運用
- **ベースライン承認**: プルリクエストでの差分レビュープロセス
- **デザイナー連携**: 視覚的変更の事前承認ワークフロー
- **ドキュメント**: スナップショット更新の手順書

## セキュリティ・パフォーマンス考慮事項

### セキュリティ
- スナップショットに機密情報が含まれないよう注意
- モックデータの利用徹底
- Secrets管理（API key等の適切な管理）

### パフォーマンス
- 無料枠制約下でのテスト対象ストーリーの選別
- セルフホストランナーでの実行時間最適化
- キャッシュ戦略（現在無効だが将来的な検討）

## 結論

現在のプロジェクト状況を考慮すると、**Storybook Test Runner + jest-image-snapshot**による実装が最適解です。

### 選定理由
1. **既存インフラ活用**: Storybook v8.6.14の設定を最大限活用
2. **コスト効率**: 完全無料で運用可能
3. **段階的導入**: 小さく始めて徐々に拡張可能
4. **学習コスト**: 既存のStorybookワークフローの自然な拡張
5. **移行容易性**: 将来的な他手法への移行も可能

### Next Steps
1. 上記手順に従った実装の開始
2. 少数のコンポーネントでのPoC実施
3. チームレビューと運用プロセスの確立
4. 段階的な対象コンポーネント拡大

---

**作成日**: 2025年7月6日  
**対象Issue**: #32  
**ブランチ**: issue-32  
**調査実施者**: Claude Code