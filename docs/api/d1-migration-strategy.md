# Drizzle ORM + Cloudflare D1 ç§»è¡Œæˆ¦ç•¥æ›¸

## ğŸ” ç¾åœ¨ã®å•é¡Œ

### æ ¹æœ¬åŸå› 
- **better-sqlite3**ãŒVite + Cloudflare Workersç’°å¢ƒã§å‹•ä½œã—ãªã„
- `__filename is not defined`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿï¼ˆCloudflare Workersç’°å¢ƒã§ã¯Node.jsã‚°ãƒ­ãƒ¼ãƒãƒ«ãŒä½¿ç”¨ä¸å¯ï¼‰
- é–‹ç™ºç’°å¢ƒã§APIã‚µãƒ¼ãƒãƒ¼ãŒ500ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™

### å½±éŸ¿ç¯„å›²
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆlocalhost:3000/subscriptionsï¼‰ã§APIãƒ‡ãƒ¼ã‚¿å–å¾—ä¸å¯
- useSubscriptionsãƒ»useCategories ãƒ•ãƒƒã‚¯ãŒã‚¨ãƒ©ãƒ¼
- ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†ç”»é¢ãŒæ©Ÿèƒ½åœæ­¢

## ğŸ“‹ æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ã®ç¾çŠ¶åˆ†æ

### ç¾åœ¨ã®æ§‹æˆ
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ¬ã‚¤ãƒ¤ãƒ¼        â”‚ ç¾åœ¨ã®æŠ€è¡“       â”‚ å•é¡Œç‚¹          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯  â”‚ Hono + Vite      â”‚ âœ… å•é¡Œãªã—     â”‚
â”‚ ORM             â”‚ Drizzle ORM      â”‚ âœ… å•é¡Œãªã—     â”‚
â”‚ é–‹ç™ºDB          â”‚ better-sqlite3   â”‚ âŒ Workersä¸å¯¾å¿œâ”‚
â”‚ æœ¬ç•ªDB          â”‚ Cloudflare D1    â”‚ âœ… å•é¡Œãªã—     â”‚
â”‚ ãƒãƒ³ãƒ‰ãƒ©ãƒ¼      â”‚ @cloudflare/vite â”‚ âœ… å•é¡Œãªã—     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Drizzleã®DBã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼æ¦‚å¿µ
Drizzleã¯DBã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã®ã‚³ã‚¢è¨­è¨ˆã‚’æ¡ç”¨ï¼š
- `drizzle-orm/better-sqlite3` - Node.jsç’°å¢ƒç”¨
- `drizzle-orm/d1` - Cloudflare Workersç”¨
- `drizzle-orm/sqlite-proxy` - HTTP APIç”¨

## ğŸ¯ è§£æ±ºæˆ¦ç•¥

### ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ1: ç’°å¢ƒåˆ¥ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼åˆ†å²ï¼ˆæ¨å¥¨ï¼‰
```typescript
// é–‹ç™ºç’°å¢ƒ: wranglerã®ãƒ­ãƒ¼ã‚«ãƒ«D1ã‚’ä½¿ç”¨
// æœ¬ç•ªç’°å¢ƒ: Cloudflare D1ã‚’ä½¿ç”¨
function createDatabase(env?: any) {
  if (process.env.NODE_ENV === 'development') {
    // wranglerãŒä½œæˆã™ã‚‹ãƒ­ãƒ¼ã‚«ãƒ«D1ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½¿ç”¨
    return drizzle(env.DB, { schema });
  } else {
    // æœ¬ç•ªã®Cloudflare D1ã‚’ä½¿ç”¨
    return drizzle(env.DB, { schema });
  }
}
```

### ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ2: Wrangler devã®å®Œå…¨æ´»ç”¨
- `.wrangler/state/v3/d1/miniflare-D1DatabaseObject/*.sqlite` ã‚’åˆ©ç”¨
- drizzle-kit studioã§ã®å¯è¦–åŒ–å¯¾å¿œ
- ç’°å¢ƒåˆ†å²ãªã—ã§çµ±ä¸€çš„ãªD1ã‚¢ã‚¯ã‚»ã‚¹

## ğŸ”§ å®Ÿè£…è¨ˆç”»

### Phase 1: åŸºç›¤è¨­å®š
1. **wrangler.jsonc ã® D1è¨­å®šç¢ºèª/ä¿®æ­£**
   ```json
   {
     "d1_databases": [{
       "binding": "DB",
       "database_name": "saifuu-dev",
       "database_id": "your-database-id",
       "migrations_dir": "drizzle/migrations"
     }]
   }
   ```

2. **drizzle.config.ts ã®ç’°å¢ƒåˆ†å²è¨­å®š**
   ```typescript
   export default process.env.LOCAL_DB_PATH ? {
     schema: './src/db/schema.ts',
     dialect: 'sqlite',
     dbCredentials: { url: process.env.LOCAL_DB_PATH }
   } : defineConfig({
     schema: './src/db/schema.ts',
     dialect: 'sqlite',
     driver: 'd1-http',
     // ...
   });
   ```

3. **package.json ã‚¹ã‚¯ãƒªãƒ—ãƒˆè¿½åŠ **
   ```json
   {
     "scripts": {
       "db:studio": "LOCAL_DB_PATH=$(find .wrangler/state/v3/d1 -name '*.sqlite' -type f | head -n 1) drizzle-kit studio",
       "db:migrate:local": "wrangler d1 migrations apply saifuu-dev --local",
       "db:migrate:remote": "wrangler d1 migrations apply saifuu-dev --remote"
     }
   }
   ```

### Phase 2: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šä¿®æ­£
1. **src/db/index.ts ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°**
   - better-sqlite3ä¾å­˜ã‚’é™¤å»
   - drizzle/d1 ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã®ã¿ä½¿ç”¨
   - ç’°å¢ƒå¤‰æ•°ãƒ™ãƒ¼ã‚¹ã®åˆ†å²ãƒ­ã‚¸ãƒƒã‚¯

2. **src/index.tsx ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ä¿®æ­£**
   - ç’°å¢ƒåˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã®æ›´æ–°
   - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ”¹å–„

### Phase 3: æ¤œè¨¼ã¨ãƒ†ã‚¹ãƒˆ
1. **ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã§ã®å‹•ä½œç¢ºèª**
   - wrangler dev ã§ã®èµ·å‹•
   - API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆ
   - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é€£æºç¢ºèª

2. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**
   - æ—¢å­˜ã‚¹ã‚­ãƒ¼ãƒã®ç§»è¡Œ
   - ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®æŠ•å…¥

3. **çµ±åˆãƒ†ã‚¹ãƒˆã®æ›´æ–°**
   - D1ç’°å¢ƒã§ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
   - CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®èª¿æ•´

## ğŸ“Š æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

### âœ… è§£æ±ºã•ã‚Œã‚‹å•é¡Œ
- better-sqlite3ã®Cloudflare Workerséå¯¾å¿œå•é¡Œ
- é–‹ç™ºç’°å¢ƒã§ã®API 500ã‚¨ãƒ©ãƒ¼
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼

### âš¡ è¿½åŠ ã®åˆ©ç‚¹
- **çµ±ä¸€ã•ã‚ŒãŸé–‹ç™ºä½“é¨“**: æœ¬ç•ªã¨åŒã˜D1ç’°å¢ƒã§ã®é–‹ç™º
- **Drizzle Studioå¯¾å¿œ**: GUIã§ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†
- **å‹å®‰å…¨æ€§ã®å‘ä¸Š**: Drizzle ORMã®å…¨æ©Ÿèƒ½æ´»ç”¨
- **ãƒ‡ãƒ—ãƒ­ã‚¤ã®ç°¡ç´ åŒ–**: ç’°å¢ƒå·®ç•°ã®æœ€å°åŒ–

## ğŸš¨ æ³¨æ„ç‚¹ã¨ãƒªã‚¹ã‚¯

### ãƒªã‚¹ã‚¯è©•ä¾¡
- **ä½ãƒªã‚¹ã‚¯**: Drizzle ORMã®ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼å¤‰æ›´ã®ã¿
- **ä¸­ãƒªã‚¹ã‚¯**: æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ç§»è¡Œä½œæ¥­
- **å¯¾ç­–**: æ®µéšçš„ãªç§»è¡Œã¨ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨ˆç”»

### ç§»è¡Œæ™‚ã®è€ƒæ…®äº‹é …
1. **ãƒ‡ãƒ¼ã‚¿äº’æ›æ€§**: ç¾åœ¨ã®SQLiteãƒ‡ãƒ¼ã‚¿ã®ç§»è¡Œ
2. **ãƒ†ã‚¹ãƒˆç’°å¢ƒ**: E2E ãƒ†ã‚¹ãƒˆã§ã®D1å¯¾å¿œ
3. **CI/CD**: GitHub Actions ã§ã®wranglerè¨­å®š

## ğŸ“… å®Ÿè£…ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³

```
Week 1: Phase 1 (åŸºç›¤è¨­å®š)
â”œâ”€â”€ Day 1-2: wrangler.jsonc + drizzle.config.ts
â”œâ”€â”€ Day 3-4: package.json scripts
â””â”€â”€ Day 5: åˆæœŸå‹•ä½œç¢ºèª

Week 2: Phase 2 (ã‚³ã‚¢ä¿®æ­£)
â”œâ”€â”€ Day 1-3: db/index.ts ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
â”œâ”€â”€ Day 4-5: ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ä¿®æ­£
â””â”€â”€ Weekend: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

Week 3: Phase 3 (æ¤œè¨¼ãƒ»æœ€é©åŒ–)
â”œâ”€â”€ Day 1-2: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é€£æºãƒ†ã‚¹ãƒˆ
â”œâ”€â”€ Day 3-4: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
â””â”€â”€ Day 5: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°
```

## ğŸ”„ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨ˆç”»

ç·Šæ€¥æ™‚ã®å¾©æ—§æ‰‹é †ï¼š
1. `vite.config.ts` ã‚’å…ƒã«æˆ»ã™
2. `src/db/index.ts` ã®better-sqlite3ç‰ˆã‚’å¾©å…ƒ
3. `.env` è¨­å®šã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å…ˆã‚’æŒ‡å®š

---

ã“ã®æˆ¦ç•¥ã«ã‚ˆã‚Šã€Cloudflare D1ã‚’æ´»ç”¨ã—ãŸå®‰å®šã—ãŸé–‹ç™ºç’°å¢ƒã‚’æ§‹ç¯‰ã—ã€æœ¬ç•ªç’°å¢ƒã¨ã®ä¸€è²«æ€§ã‚’ä¿ã¡ãªãŒã‚‰é–‹ç™ºåŠ¹ç‡ã‚’å‘ä¸Šã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚