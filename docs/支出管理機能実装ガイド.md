# 支出管理機能実装ガイド

## 概要

Saifuuの支出管理機能は、ユーザーが収入・支出を記録、編集、分析できる中核機能です。本ガイドでは、開発者向けに実装の詳細と開発方法を解説します。

## アーキテクチャ概要

### 技術スタック

- **フロントエンド**: Next.js 15 + React 19 + TypeScript
- **バックエンド**: Hono + Drizzle ORM
- **データベース**: Cloudflare D1（SQLite）
- **スタイリング**: Tailwind CSS v4
- **テスト**: Vitest + React Testing Library + Playwright

### 主要コンポーネント構造

```
frontend/
├── src/
│   ├── app/expenses/          # 支出管理ページ
│   ├── components/expenses/   # 支出管理関連コンポーネント
│   ├── hooks/                 # カスタムフック（useExpenses）
│   ├── lib/api/              # APIクライアント（transactions.ts）
│   └── types/                # 型定義（expense.ts）

api/
├── src/
│   ├── routes/transactions.ts # 取引APIエンドポイント
│   └── db/schema.ts          # データベーススキーマ
```

## フロントエンド実装

### 1. ページコンポーネント

#### `/app/expenses/page.tsx`

支出管理のメインページです。以下の要素で構成されています：

```typescript
// 主要な構成要素
- ExpenseStats      // 統計情報表示
- ExpenseFilters    // フィルタリング機能
- ExpenseList       // 取引一覧表示
- NewExpenseButton  // 新規登録ボタン
```

### 2. 主要コンポーネント

#### ExpenseForm

支出・収入の登録/編集フォームコンポーネント。

**主な機能:**
- クライアントサイドバリデーション
- 作成・編集両モードに対応
- アクセシビリティ対応
- エラーハンドリング

**バリデーション項目:**
- 金額: 正の数値、上限1,000,000円
- 日付: 必須項目
- カテゴリ: 選択必須
- 説明: 最大255文字

#### ExpenseList

取引一覧を表示するコンポーネント。

**主な機能:**
- 日付降順での表示
- インライン編集機能
- 削除機能（確認ダイアログ付き）
- レスポンシブデザイン

#### ExpenseStats

統計情報を表示するコンポーネント。

**表示項目:**
- 総支出額
- 総収入額
- 収支バランス
- 期間設定（月/年）

#### ExpenseFilters

一覧表示のフィルタリング機能。

**フィルタ項目:**
- 取引種別（収入/支出/全て）
- カテゴリ
- 期間（開始日・終了日）

### 3. カスタムフック

#### useExpenses

支出データの取得とCRUD操作を管理するカスタムフック。

```typescript
const {
  expenses,        // 取引データ配列
  loading,         // ローディング状態
  error,          // エラー状態
  stats,          // 統計情報
  fetchExpenses,  // データ再取得
  createExpense,  // 新規作成
  updateExpense,  // 更新
  deleteExpense,  // 削除
} = useExpenses(filters);
```

### 4. APIクライアント

#### `/lib/api/transactions.ts`

バックエンドAPIとの通信を担当するモジュール。

**主な関数:**
- `getTransactions()` - 取引一覧取得
- `getTransactionStats()` - 統計情報取得
- `createTransaction()` - 新規作成
- `updateTransaction()` - 更新
- `deleteTransaction()` - 削除

## バックエンド実装

### 1. APIエンドポイント

#### `/api/src/routes/transactions.ts`

取引データのCRUD操作を提供するAPIエンドポイント。

**エンドポイント一覧:**

| メソッド | パス | 説明 |
|---------|------|------|
| GET | `/api/transactions` | 取引一覧取得 |
| GET | `/api/transactions/stats` | 統計情報取得 |
| GET | `/api/transactions/:id` | 取引詳細取得 |
| POST | `/api/transactions` | 新規作成 |
| PUT | `/api/transactions/:id` | 更新 |
| DELETE | `/api/transactions/:id` | 削除 |

### 2. データベーススキーマ

#### transactionsテーブル

```sql
CREATE TABLE transactions (
  id TEXT PRIMARY KEY,
  amount REAL NOT NULL,
  type TEXT NOT NULL CHECK(type IN ('income', 'expense')),
  category_id TEXT NOT NULL,
  description TEXT,
  date TEXT NOT NULL,
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL,
  FOREIGN KEY (category_id) REFERENCES categories(id)
);
```

### 3. バリデーション

APIレベルでのバリデーション処理：

```typescript
// 金額のバリデーション
if (amount <= 0 || amount > 1000000) {
  return c.json({ error: '金額は1円から1,000,000円の範囲で入力してください' }, 400);
}

// 種別のバリデーション
if (!['income', 'expense'].includes(type)) {
  return c.json({ error: '種別はincomeまたはexpenseである必要があります' }, 400);
}
```

## テスト戦略

### 1. ユニットテスト

**対象:**
- バリデーション関数
- ユーティリティ関数
- カスタムフック
- 個別コンポーネント

**実行方法:**
```bash
npm run test:unit
```

### 2. Storybookテスト

**対象:**
- UIコンポーネントの表示確認
- インタラクションテスト
- レスポンシブデザイン確認

**実行方法:**
```bash
npm run storybook
```

### 3. E2Eテスト

**対象:**
- 正常系の主要フロー（登録・編集・削除）
- 統計情報の表示

**実行方法:**
```bash
cd e2e && npm run test:e2e
```

## 開発フロー

### 1. 新機能追加時

1. **型定義の追加/修正** (`/types/expense.ts`)
2. **APIクライアントの実装** (`/lib/api/transactions.ts`)
3. **コンポーネントの実装**
4. **テストの作成**（ユニット・Storybook）
5. **E2Eテストの追加**（必要に応じて）

### 2. バグ修正時

1. **再現テストの作成**
2. **修正の実施**
3. **テストの確認**
4. **リグレッションテスト**

### 3. リファクタリング時

1. **既存テストの確認**
2. **段階的な変更**
3. **テストの継続的実行**
4. **パフォーマンス確認**

## パフォーマンス最適化

### 1. フロントエンド

- **遅延読み込み**: 大量データの仮想スクロール
- **メモ化**: React.memo, useMemoの活用
- **状態管理**: 不要な再レンダリングの防止

### 2. バックエンド

- **クエリ最適化**: 必要なカラムのみ取得
- **インデックス**: 検索頻度の高いカラムにインデックス設定
- **キャッシュ**: 統計情報の適切なキャッシュ

## トラブルシューティング

### よくある問題と解決方法

#### 1. カテゴリが表示されない

**原因**: カテゴリとのJOINが正しく行われていない
**解決**: LEFT JOINを使用し、カテゴリが削除されても取引が表示されるようにする

#### 2. 日付のタイムゾーン問題

**原因**: クライアントとサーバーのタイムゾーン差
**解決**: ISO8601形式で統一し、表示時にローカライズ

#### 3. 大量データでのパフォーマンス低下

**原因**: 全件取得による負荷
**解決**: ページネーションまたは仮想スクロールの実装

## セキュリティ考慮事項

### 1. 入力検証

- **SQLインジェクション対策**: Drizzle ORMのプリペアドステートメント使用
- **XSS対策**: Reactの自動エスケープ機能
- **CSRF対策**: 将来的なトークンベース認証の準備

### 2. データアクセス制御

- **現在**: 単一ユーザー前提
- **将来**: ユーザーIDベースのアクセス制御実装予定

## 今後の拡張予定

### 1. 機能拡張

- **予算管理機能**: 月別予算の設定と監視
- **定期取引**: 自動登録機能
- **データエクスポート**: CSV/PDF出力

### 2. 技術的改善

- **GraphQL導入**: より柔軟なデータ取得
- **リアルタイム同期**: WebSocketによる複数デバイス対応
- **PWA対応**: オフライン機能の実装

## 関連ドキュメント

- [支出管理画面要件定義書](./支出管理画面要件定義書.md)
- [支出管理機能使用方法](./支出管理機能使用方法.md)
- [APIドキュメント](./API開発/README.md)
- [テストガイド](./テストガイド.md)

---

**作成日**: 2025年7月13日  
**更新日**: 2025年7月13日  
**関連Issue**: #99, #80, #90-#97