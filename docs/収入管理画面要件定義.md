# 収入管理画面要件定義

## 1. 概要

本ドキュメントは、Saifuu家計管理アプリケーションにおける収入管理機能の要件を定義します。
既存の支出管理機能のパターンを踏襲し、収入の記録・管理・分析機能を提供します。

## 2. 機能要件

### 2.1 基本機能（CRUD操作）

- **収入登録**: 新規収入データの登録
  - 金額（必須、正の数値のみ）
  - 日付（必須、カレンダー選択）
  - カテゴリ（必須、ドロップダウン選択）
  - 説明・メモ（任意、最大500文字）
  - 定期収入フラグ（任意、トグルスイッチ）

- **収入編集**: 登録済み収入データの修正
- **収入削除**: 不要な収入データの削除（確認ダイアログ表示）
- **収入一覧**: 登録済み収入の一覧表示
  - ページネーション対応
  - ソート機能（日付、金額）

### 2.2 フィルタリング機能

- **期間フィルタ**
  - 今月
  - 先月
  - 今年
  - カスタム期間（開始日・終了日指定）

- **カテゴリフィルタ**
  - 全カテゴリ
  - 個別カテゴリ選択

- **金額範囲フィルタ**
  - 最小金額・最大金額指定

### 2.3 統計・分析機能

- **収入統計カード**
  - 今月の収入合計
  - 先月の収入合計
  - 前月比増減率
  - 今年の収入合計

- **カテゴリ別内訳**
  - 円グラフまたは棒グラフ表示
  - カテゴリ別収入額・割合

### 2.4 収入固有機能

- **定期収入管理**
  - 毎月の給与等、定期的な収入の自動記録設定
  - 定期収入の一時停止・再開機能

- **源泉徴収対応**
  - 手取り額と総支給額の管理
  - 源泉徴収税額の記録（オプション）

- **賞与管理**
  - 賞与の個別登録
  - 年間賞与合計の表示

### 2.5 支出機能との統合

- **収支バランス表示**
  - ダッシュボードでの収入・支出の対比表示
  - 月別・年別の純利益（収入 - 支出）計算

- **統合レポート**
  - 収入・支出・貯蓄率の包括的な分析
  - トレンドグラフ表示

## 3. UI/UX要件

### 3.1 画面構成

- **ルーティング**: `/income` （支出管理の `/expenses` と並列）
- **ナビゲーション**: ヘッダーに「収入管理」メニュー追加（アイコン: 💰）
- **レイアウト**: 3セクション構成
  1. 収入統計カード（上部）
  2. フィルタリングコントロール（中部）
  3. 収入一覧テーブル（下部）

### 3.2 収入カテゴリ

| カテゴリID | カテゴリ名 | 説明 | color |
|-----------|-----------|------|-------|
| 101 | 給与 | 毎月の給与所得 | #10b981 |
| 102 | ボーナス | 賞与・特別手当 | #059669 |
| 103 | 副業 | 副業による収入 | #34d399 |
| 104 | 投資収益 | 株式配当・利息等 | #6ee7b7 |
| 105 | その他 | その他の収入 | #a7f3d0 |

**注記**: アイコンは既存の支出カテゴリパターンに合わせ、`color` プロパティとして色コードで定義します。

### 3.3 ビジュアルデザイン

- **カラースキーム**: 緑系統（text-green-600、bg-green-50）
  - 支出の赤系統と明確に区別
- **アイコン**: プラス記号（+）、上向き矢印（↑）
- **グラデーション**: green-to-emerald

### 3.4 レスポンシブデザイン

- モバイルファースト設計
- 既存の支出管理と同様のレスポンシブパターン
- タッチフレンドリーなボタン配置

## 4. データモデル要件

### 4.1 スキーマ変更

```typescript
// transactions テーブルの type enum を拡張
type: ['expense', 'income'] // 現在は ['expense'] のみ
```

#### マイグレーション手順

1. **新しいマイグレーションファイルの作成**
   ```bash
   cd api
   pnpm run db:generate
   ```

2. **マイグレーションSQL例**
   ```sql
   -- 既存データに影響を与えずにenum値を追加
   ALTER TABLE transactions 
   MODIFY COLUMN type TEXT CHECK(type IN ('expense', 'income'));
   ```

3. **マイグレーションの適用**
   ```bash
   pnpm run db:migrate:dev  # 開発環境
   pnpm run db:migrate:prod # 本番環境
   ```

4. **ロールバック戦略**
   - マイグレーション前のバックアップを取得
   - 問題発生時は前のマイグレーションバージョンに戻す
   - 既存の'expense'データは影響を受けないため、安全にロールバック可能

### 4.2 収入カテゴリ定義

```typescript
// shared/config/categories.ts の型定義を拡張
export type CategoryType = 'expense' | 'income'; // 現在は 'expense' のみ

// 既存の空配列 INCOME_CATEGORIES を以下の内容で更新
export const INCOME_CATEGORIES = [
  { id: 'salary', name: '給与', type: 'income' as CategoryType, color: '#10b981', numericId: 101 },
  { id: 'bonus', name: 'ボーナス', type: 'income' as CategoryType, color: '#059669', numericId: 102 },
  { id: 'side_business', name: '副業', type: 'income' as CategoryType, color: '#34d399', numericId: 103 },
  { id: 'investment', name: '投資収益', type: 'income' as CategoryType, color: '#6ee7b7', numericId: 104 },
  { id: 'other_income', name: 'その他', type: 'income' as CategoryType, color: '#a7f3d0', numericId: 105 },
];
```

### 4.3 バリデーションルール

- 金額: 正の数値のみ（収入の場合）
- カテゴリID: 101-105の範囲（収入カテゴリ）
- タイプ: 'income' 必須

## 5. API要件

### 5.1 エンドポイント

既存の `/api/transactions` エンドポイントを拡張:

- `GET /api/transactions?type=income` - 収入一覧取得
- `POST /api/transactions` - 収入登録（type: 'income'）
- `PUT /api/transactions/:id` - 収入更新
- `DELETE /api/transactions/:id` - 収入削除

### 5.2 統計エンドポイント

- `GET /api/transactions/stats?type=income` - 収入統計取得

### 5.3 API設計の詳細

#### バリデーション戦略

1. **共通バリデーション**
   - 日付フォーマット検証
   - カテゴリID存在確認
   - 説明文字数制限

2. **収入固有バリデーション**
   ```typescript
   // 収入の場合のバリデーションルール
   if (type === 'income') {
     // 金額は正の値のみ
     if (amount <= 0) throw new Error('収入金額は0より大きい必要があります');
     
     // 源泉徴収額チェック（オプション）
     if (withholdingTax && withholdingTax > grossAmount) {
       throw new Error('源泉徴収額は総支給額を超えることはできません');
     }
   }
   ```

#### エラーレスポンス仕様

```typescript
// 収入固有のエラーコード
const INCOME_ERROR_CODES = {
  INVALID_INCOME_AMOUNT: '収入金額が不正です',
  WITHHOLDING_TAX_EXCEEDS_GROSS: '源泉徴収額が総支給額を超えています',
  INVALID_INCOME_CATEGORY: '無効な収入カテゴリです',
};
```

#### 後方互換性の保持

- 既存の支出管理APIは変更なし
- `type` パラメータ省略時は従来通り 'expense' として扱う
- レスポンス形式は支出・収入で統一

## 6. 実装方針

### 6.1 再利用コンポーネント

以下の既存コンポーネントを収入用に拡張:
- `ExpenseForm` → `IncomeForm`
- `ExpenseList` → `IncomeList`
- `ExpenseStats` → `IncomeStats`
- `ExpenseFilters` → `IncomeFilters`

### 6.2 共通化

- トランザクション型の統一（TransactionType）
- フォームバリデーションスキーマの共通化
- APIクライアントの共通化

### 6.3 段階的実装

#### Phase 1: 基本的なCRUD機能
**実装範囲**:
- 収入の登録・編集・削除・一覧表示
- 基本的なバリデーション
- シンプルな一覧表示（ページネーションなし）

**技術的マイルストーン**:
- DBスキーマ変更（type enum拡張）
- 基本APIエンドポイント実装
- 最小限のUIコンポーネント

**前提条件**: なし

#### Phase 2: フィルタリング・統計機能
**実装範囲**:
- 期間・カテゴリ・金額範囲フィルタ
- 統計カード表示
- ページネーション実装

**技術的マイルストーン**:
- インデックス追加（date, categoryId, type）
- 集計クエリの最適化
- フィルタUIコンポーネント

**前提条件**: Phase 1完了、基本的なデータ構造確定

#### Phase 3: 支出との統合・分析機能
**実装範囲**:
- 収支バランス表示
- 統合レポート
- 共通コンポーネント化

**技術的マイルストーン**:
- 収入・支出共通の抽象化層実装
- 統合ダッシュボード開発
- パフォーマンス最適化

**前提条件**: Phase 2完了、十分なテストデータ

**既存機能への影響**:
- Phase 1: 影響なし（独立した機能追加）
- Phase 2: categories.tsの更新が必要
- Phase 3: ダッシュボードUIの変更

## 7. テスト要件

### 7.1 ユニットテスト

**テスト項目**:
- バリデーションロジック
  - 正の金額チェック
  - カテゴリID範囲チェック（101-105）
  - 源泉徴収額の妥当性
- 金額計算ロジック
  - 手取り額計算
  - 統計集計
- フィルタリング機能
  - 期間フィルタ
  - カテゴリフィルタ
  - 金額範囲フィルタ

### 7.3 統合テスト

**テスト項目**:
- API エンドポイント
  - 収入CRUD操作の正常系・異常系
  - フィルタリングクエリ
  - 統計API
- 支出機能との連携
  - 収支バランス計算
  - カテゴリマスタ参照

### 7.4 E2Eテスト（最小限）

**正常系フローのみ**:
- 収入登録 → 一覧確認 → 編集 → 削除
- ブラウザ: Chromiumのみ（CI環境）
- 実行時間目標: 30秒以内

## 8. 非機能要件

### 8.1 パフォーマンス

- 収入一覧の表示: 2秒以内
- フィルタリング応答: 500ms以内

### 8.2 セキュリティ

- 金額の改ざん防止
- SQLインジェクション対策

### 8.3 アクセシビリティ

- キーボード操作対応
- スクリーンリーダー対応
- 適切なARIAラベル

## 9. 今後の拡張性

- CSVエクスポート機能
- 確定申告用データ出力
- 収入予測・目標設定機能
- 複数通貨対応

## 10. 参考資料

- [支出管理機能の実装](./プロジェクト概要.md#主要機能)
- [技術スタック](./技術スタック.md)
- [データベース設計](./プロジェクト構造.md#データベース)