# シード処理ガイド

## 概要と目的

Saifuuアプリケーションにおけるシード処理は、開発環境での効率的なデータベース操作を実現するための重要な機能です。主な目的は以下の通りです：

- **開発環境の標準化**: 全開発者が同じテストデータで作業できる環境を提供
- **機能テストの効率化**: カテゴリーマスターデータとサンプルサブスクリプションによる機能確認
- **デバッグの迅速化**: 予測可能なデータ構造により問題の特定を容易化
- **新機能開発の加速**: 現実的なデータパターンでの開発環境構築

技術的背景として、本シード処理はSQLiteベースのローカル開発環境（`dev.db`）とCloudflare D1ローカル環境の双方をサポートし、冪等性を保証する設計になっています。

## 実行コマンドと処理フロー

### 主要コマンド一覧

#### 1. 完全シード処理（推奨）
```bash
npm run db:seed
```
**処理内容**: DBクリア → マイグレーション → シード投入
**対象**: Cloudflare D1 ローカル環境
**所要時間**: 約30-60秒

#### 2. 開発環境セットアップ（推奨）
```bash
npm run db:setup:dev
```
**処理内容**: マイグレーション → シード投入
**対象**: 開発環境（dev.db）
**所要時間**: 約15-30秒

#### 3. 開発環境リセット
```bash
npm run db:reset:dev
```
**処理内容**: DBファイル削除 → マイグレーション → シード投入
**対象**: 開発環境（dev.db）
**特徴**: 完全なクリーンアップ

#### 4. 個別操作コマンド
```bash
# データクリアのみ
npm run db:clear:local

# シードデータ投入のみ
npm run db:seed:data

# 開発環境シードのみ
npm run db:seed:dev
```

### 処理フローの詳細

#### 完全シード処理フロー（`pnpm run db:seed`）
1. **前処理**: 既存テーブルのクリア
2. **マイグレーション**: スキーマ適用
3. **シード投入**: マスターデータ・サンプルデータ投入
4. **検証**: 投入結果の確認

#### 開発環境セットアップフロー（`pnpm run db:setup:dev`）
1. **バックアップ**: 既存dev.dbの自動バックアップ（タイムスタンプ付き）
2. **マイグレーション**: Drizzle Kitによるスキーマ適用
3. **シード投入**: SQLite直接実行によるデータ投入
4. **接続テスト**: テーブル作成確認

### オプション設定

#### SKIP_SEEDオプション
```bash
SKIP_SEED=true npm run db:migrate:dev
```
**用途**: マイグレーションのみ実行したい場合
**適用場面**: スキーマ変更のテスト時など

## データ構造の説明

### カテゴリーマスターデータ（11件）

カテゴリは設定ファイル（`shared/config/categories.ts`）で管理されており、以下の支出カテゴリが利用可能です：

| カテゴリ名 | 用途 | カラーコード | 想定用途 |
|-----------|------|-------------|----------|
| 家賃・水道・光熱・通信費 | 支出 | #D35400 | 家賃、電気、ガス、水道、インターネット、携帯電話 |
| 住居費 | 支出 | #4ECDC4 | 家賃、光熱費、住居関連費用 |
| 食費 | 支出 | #FF6B6B | 食材、外食、飲食代 |
| 交通費 | 支出 | #3498DB | 電車、バス、タクシー、ガソリン代 |
| 仕事・ビジネス | 支出 | #8E44AD | 開発費、ツール、サービス、ビジネス関連 |
| システム関係費 | 支出 | #9B59B6 | システム利用料、サブスクリプション費用 |
| 書籍代 | 支出 | #1E8BC3 | 書籍、電子書籍、雑誌 |
| 健康・フィットネス | 支出 | #96CEB4 | 医療費、薬代、ジム、スポーツ |
| 買い物 | 支出 | #F39C12 | 衣類、日用品、雑貨 |
| その他 | 支出 | #FFEAA7 | その他の支出 |
| 娯楽 | 支出 | #E67E22 | 映画、ゲーム、音楽、趣味などのエンターテイメント関連支出 |

**設計意図**: 個人の家計管理において頻出する支出パターンを網羅し、UIでの視認性を向上させる色分けを実装。

**注**: カテゴリは設定ファイルベースで管理されているため、データベースへの直接投入は行われません。

### サブスクリプションサンプルデータ（5件）

実際のサブスクリプションサービスを模したテストデータ：

| サービス名 | 月額料金 | 課金サイクル | 次回課金日 | カテゴリ | 状態 |
|-----------|----------|-------------|-----------|----------|------|
| GitHub Pro | 600円 | 月次 | +15日後 | 開発費 | 有効 |
| Netflix | 1,490円 | 月次 | +7日後 | 娯楽 | 有効 |
| Spotify Premium | 980円 | 月次 | +22日後 | 娯楽 | 有効 |
| Adobe Creative Cloud | 28,776円 | 年次 | +120日後 | 開発費 | 有効 |
| ChatGPT Plus | 3,000円 | 月次 | +3日後 | 開発費 | 無効 |

**設計意図**: 
- 月次・年次・週次の課金サイクルパターンを網羅
- 現実的な価格設定によるUIテスト
- 有効・無効状態によるフィルタリング機能のテスト
- 異なる課金日設定によるソート・アラート機能のテスト

### テーブル構造詳細

#### categoriesテーブル
```sql
CREATE TABLE categories (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    type TEXT NOT NULL CHECK (type IN ('income', 'expense')),
    color TEXT,
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL
);
```

#### subscriptionsテーブル
```sql
CREATE TABLE subscriptions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    amount REAL NOT NULL,
    billing_cycle TEXT NOT NULL CHECK (billing_cycle IN ('monthly', 'yearly', 'weekly')),
    next_billing_date TEXT NOT NULL,
    category_id INTEGER REFERENCES categories(id),
    description TEXT,
    is_active INTEGER NOT NULL DEFAULT 1,
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL
);
```

## トラブルシューティング

### よくあるエラーと解決方法

#### 1. "sqlite3 command not found"
**原因**: SQLiteコマンドがインストールされていない
**解決策**:
```bash
# macOS (Homebrew)
brew install sqlite

# Ubuntu/Debian
sudo apt-get install sqlite3

# CentOS/RHEL
sudo yum install sqlite3
```

#### 2. "Permission denied"
**原因**: プロジェクトディレクトリへの書き込み権限不足
**解決策**:
```bash
# 権限確認
ls -la dev.db

# 権限修正（必要に応じて）
chmod 644 dev.db
```

#### 3. "Database is locked"
**原因**: 他のプロセスがデータベースを使用中
**解決策**:
```bash
# 開発サーバーを停止
pkill -f "vite"

# DBスタジオを停止
pkill -f "drizzle-kit"

# 再実行
npm run db:setup:dev
```

#### 4. "Table already exists"
**原因**: マイグレーションとシードの競合
**解決策**:
```bash
# 完全リセット
npm run db:reset:dev

# またはマイグレーションのみ実行
SKIP_SEED=true npm run db:migrate:dev
```

#### 5. Node.jsバージョンエラー
**原因**: Node.js 22以外のバージョンを使用
**解決策**:
```bash
# miseでバージョン確認
mise current

# 正しいバージョンのインストール
mise install nodejs@22
```

### データ不整合の修復方法

#### 1. 部分的なデータ修復
```bash
# カテゴリーマスターのみ再投入
sqlite3 dev.db "DELETE FROM categories;"
sqlite3 dev.db < drizzle/seed.sql
```

#### 2. 外部キー制約エラー
```bash
# 外部キー制約を一時的に無効化
sqlite3 dev.db "PRAGMA foreign_keys = OFF;"
# データクリア・再投入
sqlite3 dev.db "DELETE FROM subscriptions; DELETE FROM categories;"
sqlite3 dev.db < drizzle/seed.sql
# 外部キー制約を再有効化
sqlite3 dev.db "PRAGMA foreign_keys = ON;"
```

#### 3. バックアップからの復元
```bash
# 最新のバックアップファイルを確認
ls -la dev.db.backup.*

# 復元
cp dev.db.backup.2025-07-06T07-15-10-094Z dev.db
```

## 開発環境での使用方法

### 初回セットアップ手順

#### 1. 環境確認
```bash
# Node.jsバージョン確認（22系必須）
node --version

# SQLiteインストール確認
sqlite3 --version

# 依存関係インストール
npm ci
```

#### 2. データベース初期化
```bash
# 開発環境セットアップ（推奨）
npm run db:setup:dev

# またはD1ローカル環境
npm run db:seed
```

#### 3. 動作確認
```bash
# DBスタジオで確認
npm run db:studio:dev

# テーブル一覧確認
sqlite3 dev.db ".tables"

# データ確認
sqlite3 dev.db "SELECT * FROM categories;"
```

### 日常的な開発での使用パターン

#### 1. 朝の作業開始時
```bash
# 開発環境の状態確認
npm run db:studio:dev

# 必要に応じてデータリセット
npm run db:reset:dev
```

#### 2. 機能開発中
```bash
# スキーマ変更後のマイグレーション
npm run db:migrate:dev

# テストデータが必要な場合
npm run db:seed:dev
```

#### 3. デバッグ時
```bash
# 既存データを保持してシード追加
npm run db:seed:data

# 完全リセット
npm run db:reset:dev
```

#### 4. 作業終了時
```bash
# 状態確認（必要に応じて）
sqlite3 dev.db "SELECT COUNT(*) FROM categories;"
```

### 環境別コマンド選択指針

| 環境 | 推奨コマンド | 用途 |
|------|-------------|------|
| 初回セットアップ | `npm run db:setup:dev` | 開発環境構築 |
| 機能開発 | `npm run db:seed:dev` | テストデータ投入 |
| デバッグ | `npm run db:reset:dev` | 完全リセット |
| CI/CD | `npm run db:seed` | D1ローカル環境 |
| スキーマ変更 | `SKIP_SEED=true npm run db:migrate:dev` | マイグレーションのみ |

## 注意事項

### 1. 環境分離の重要性
- **開発環境**: `dev.db`（SQLite）
- **テスト環境**: D1ローカル（Cloudflare Workers）
- **本番環境**: D1リモート（Cloudflare Workers）

各環境でのデータ混在を避けるため、適切なコマンドを選択してください。

### 2. バックアップの自動管理
`npm run db:migrate:dev`実行時、既存の`dev.db`は自動的にタイムスタンプ付きでバックアップされます。古いバックアップファイルは定期的に削除することを推奨します。

### 3. 本番環境での使用禁止
本シード処理は開発・テスト環境専用です。本番環境では絶対に実行しないでください。

### 4. 性能への影響
大量のテストデータが必要な場合、シード処理の実行時間が長くなる可能性があります。その際は、必要最小限のデータに調整することを検討してください。