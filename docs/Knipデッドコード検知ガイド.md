# Knipデッドコード検知ガイド

## 概要

Knipは、TypeScript/JavaScriptプロジェクトにおけるデッドコード（未使用のコード、依存関係、ファイル等）を検出するツールです。このガイドでは、Saifuuプロジェクトにおけるフロントエンド側のKnip設定と使用方法について説明します。

## 設定の特徴

### 保守的な設定

誤検知による必要なコードの削除を防ぐため、すべてのルールを`warn`（警告）レベルに設定しています。これにより、デッドコードの可能性がある箇所を警告として表示しつつ、開発者が慎重に判断できるようにしています。

### Next.js App Router対応

Next.js 15のApp Routerパターンに完全対応し、以下のファイルをエントリーポイントとして認識します：

- `page.tsx` - ページコンポーネント
- `layout.tsx` - レイアウトコンポーネント
- `error.tsx` - エラーバウンダリ
- `not-found.tsx` - 404ページ
- `loading.tsx` - ローディング状態
- `global-error.tsx` - グローバルエラー
- `route.ts` - API Route

### テスト・開発ツール対応

以下のファイル・ディレクトリは自動的に除外されます：

- テストファイル（`*.test.ts`, `*.test.tsx`）
- テストユーティリティ
- MSWモック
- 各種設定ファイル

## 使用方法

### 基本的な使用

```bash
# フロントエンドディレクトリに移動
cd frontend

# 基本的なデッドコード検知
pnpm run knip

# 本番環境向けの厳密な検知
pnpm run knip:production

# 自動修正付き検知
pnpm run knip:fix

# 型チェック・リント・テスト・デッドコード検知を一括実行
pnpm run check:knip
```

### 結果の解釈

Knipは以下の種類の問題を検出します：

1. **未使用ファイル** - プロジェクト内で参照されていないファイル
2. **未使用の依存関係** - package.jsonに記載されているが使用されていないパッケージ
3. **未使用のエクスポート** - exportされているが他のファイルでimportされていない関数・変数
4. **重複した依存関係** - 複数のバージョンが存在するパッケージ

### 警告への対処方法

1. **確認** - 警告が正しいか確認する
2. **削除** - 本当に不要な場合は削除する
3. **除外** - 必要だが警告される場合は、knip.jsonの`ignore`または`ignoreDependencies`に追加する

## トラブルシューティング

### よくある誤検知

#### 動的インポート

動的にインポートされるファイルが未使用として検出される場合：

```typescript
// このようなコードは誤検知される可能性がある
const module = await import(`./modules/${moduleName}`);
```

対処法：該当ファイルをknip.jsonの`entry`に追加する

#### 型定義ファイル

型定義のみのファイルが未使用として検出される場合：

対処法：`*.d.ts`ファイルは自動的に除外されるように設定済み

#### ビルドツールの依存関係

Next.js、Tailwind CSSなどのフレームワーク・ツールが未使用として検出される場合：

対処法：`ignoreDependencies`に追加済み

### 設定のカスタマイズ

プロジェクトの成長に応じて、knip.jsonを調整できます：

```json
{
  "rules": {
    "files": "error",  // 警告から、を厳密なエラーに変更
    "dependencies": "error"
  }
}
```

## 段階的導入の推奨

1. **初期段階** - 現在の`warn`設定で運用し、誤検知のパターンを把握
2. **安定期** - 誤検知が減ったら、重要なルールを`error`に変更
3. **成熟期** - CI/CDパイプラインに組み込み、自動チェック

## 関連リンク

- [Knip公式ドキュメント](https://knip.dev/)
- [Next.js App Router](https://nextjs.org/docs/app)
- [プロジェクトのコマンドリファレンス](./コマンドリファレンス.md)