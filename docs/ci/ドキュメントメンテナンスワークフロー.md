# ドキュメントメンテナンスワークフロー

## 概要

mainブランチへのマージ後に自動的にドキュメントのメンテナンスを行うGitHub Actionsワークフローです。

## 動作原理

### トリガー条件

- `push`イベントで`main`ブランチにプッシュされた場合
- ただし、以下のパスの変更のみの場合は除外:
  - `docs/**`
  - `*.md`
  - `README.md`
  - `CLAUDE.md`

### 実行フロー

1. **変更ファイルの検出**
   - `git diff`を使用して前回のコミットから変更されたファイルを検出
   - 変更されたファイルのリストを取得

2. **Issue番号の抽出**
   - 最新のコミットメッセージから Issue番号を抽出
   - 抽出パターン: `#123` または `issue-123`
   - 見つからない場合は `auto-{timestamp}` を使用

3. **ドキュメント更新の必要性判定**
   - 以下の変更があった場合にドキュメント更新が必要と判定:
     - `api/` - API関連の変更
     - `frontend/` - フロントエンド関連の変更
     - `e2e/` - E2Eテスト関連の変更
     - `.github/` - CI/CD関連の変更
     - 設定ファイル (package.json, CLAUDE.md, .env.*, tsconfig, biome.json, wrangler.jsonc)

4. **ドキュメントブランチの作成**
   - 形式: `docs/issue-{issue_number}`
   - 例: `docs/issue-298`

5. **Claude Code Actionの実行**
   - 変更されたファイルの内容を分析
   - 関連するドキュメントの特定
   - 必要に応じてドキュメントの更新
   - 更新した内容をコミットしてPRを作成

## 設定方法

### 1. ワークフローファイルの配置

プロジェクトルートに作成された `docs-maintenance-workflow.yml` を `.github/workflows/` ディレクトリに配置してください。

```bash
mkdir -p .github/workflows/
mv docs-maintenance-workflow.yml .github/workflows/docs-maintenance.yml
```

### 2. 権限設定

ワークフローには以下の権限が必要です:

- `contents: write` - ファイルの読み書き
- `pull-requests: write` - PR作成
- `issues: read` - Issue情報の読み取り
- `id-token: write` - Claude Code Action用

### 3. シークレットの設定

リポジトリの設定で以下のシークレットが必要です:

- `CLAUDE_CODE_OAUTH_TOKEN` - Claude Code Action用のトークン

## 実行結果

### 成功パターン

1. **ドキュメント更新あり**
   - 新しいブランチ `docs/issue-{number}` が作成される
   - 関連するドキュメントが更新される
   - 変更内容がコミットされる
   - PRが自動作成される

2. **ドキュメント更新不要**
   - 変更がドキュメントに影響しない場合
   - 正常終了として処理される
   - 新しいブランチやPRは作成されない

### 失敗パターン

- Git操作の失敗
- Claude Code Actionの実行エラー
- 権限不足によるエラー

## 対象となるドキュメント

以下のドキュメントが自動メンテナンスの対象となります:

- **API開発** (`docs/API開発/`)
- **フロントエンド開発** (`docs/フロントエンド開発/`)
- **テスト** (`docs/テスト/`)
- **CI/CD** (`docs/ci/`)
- **開発環境** (`docs/開発環境/`)
- **データベース** (`docs/データベース/`)
- **ロギング** (`docs/ロギング/`)
- **アーキテクチャ決定記録** (`docs/adr/`)

## 注意事項

### 制約事項

- セルフホストランナーでのみ実行可能
- ドキュメントのみの変更では実行されない
- Issue番号が抽出できない場合はタイムスタンプが使用される

### 運用上の注意

- 生成されたPRは手動でレビューしてからマージしてください
- 大量の変更が発生する場合は、手動でのドキュメント更新を検討してください
- ワークフローの実行時間は変更の規模に依存します

## トラブルシューティング

### よくある問題

1. **権限エラー**
   - `CLAUDE_CODE_OAUTH_TOKEN` の設定を確認
   - リポジトリの権限設定を確認

2. **ブランチ作成エラー**
   - 既存のブランチ名と重複していないか確認
   - リポジトリの書き込み権限を確認

3. **Claude Code Actionエラー**
   - API制限に達していないか確認
   - プロンプトの内容を確認

### ログの確認

GitHub Actionsのログから以下の情報を確認できます:

- 変更されたファイルの一覧
- 抽出されたIssue番号
- ドキュメント更新の必要性判定結果
- Claude Code Actionの実行結果

## 関連ドキュメント

- [PRコメント駆動CI実装ガイド](./PRコメント駆動CI実装ガイド.md)
- [GitHub Actions ワークフロー](../../.github/workflows/)
- [Claude Code Action](https://github.com/anthropics/claude-code-action)