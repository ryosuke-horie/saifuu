# ビジュアルリグレッションテスト技術選定

## 概要

issue-32「Storybookを活用したコンポーネント回帰テストのsetup」に関する技術調査結果と選定理由をまとめたドキュメントです。

## 現在のプロジェクト状況

### 既存設定
- **Storybook**: v8.6.14（インタラクションテスト対応）
- **Playwright**: v1.53.1（現在ローカル専用、CI無効）
- **@storybook/test**: v8.6.14（インタラクションテスト対応）
- **MSW**: v2.10.2（APIモック）
- **Vitest**: v3.2.4（ユニットテスト）

### CI/CD状況
- GitHub Actionsのセットアップが必要（`.github`ディレクトリ未存在）
- E2Eテストは無料枠節約のため現在無効化
- セルフホストランナー使用（キャッシュ無効設定）

## 採用技術: storybook-addon-vis + Vitest

### メリット
- ✅ **Vitest統合**: 既存のVitest環境と完全統合
- ✅ **現代的**: 2025年の最新アプローチ、TypeScript完全対応
- ✅ **自動スナップショット**: `snapshot`タグで自動ビジュアルテスト実行
- ✅ **Storybook UI**: Storybookの視覚的テストウィジェットで直接実行・確認
- ✅ **ブラウザモード**: Vitest Browser Modeで実ブラウザテスト
- ✅ **コスト**: 完全無料のオープンソース

### デメリット
- ❌ **実験的**: 比較的新しいアドオンのため、実績が少ない
- ❌ **依存関係**: Vitest Browser Mode（実験的機能）に依存
- ❌ **学習コスト**: 新しいツールチェーンの習得が必要

## その他の検討したアプローチ（不採用）

### 1. composeStories + Vitest + Custom Visual Testing
- 独自実装が必要で保守負荷が高い

### 2. Vitest Browser Mode + Playwright Component Testing
- 設定が複雑で、Storybook統合が弱い

### 3. Storybook Test Runner + jest-image-snapshot（Jestベース）
- VitestではなくJestベースのため、現在のテスト環境と分離する

### 4. Chromatic（クラウドサービス）
- $149/月〜のコストがかかる（無料枠5,000スクリーンショット/月）

### 5. Playwright Visual Comparisons
- 現在無効化されているE2E環境の再有効化が必要

### 6. その他のツール（BackstopJS、Lost Pixel、Percy、Applitools）
- Storybookとの統合が弱く、コストがかかるものも多い

## 選定理由

### 主要な選定基準
1. **既存環境との統合**: Vitestベースのテスト環境との統合を重視
2. **コスト**: GitHub Actions無料枠制約下でのコストゼロ運用
3. **Storybook統合**: 既存のStorybook環境との親和性
4. **将来性**: 2025年の最新技術トレンドに適合

### 技術的優位性
- **統一環境**: ユニットテスト・ビジュアルテストを同一のVitestフレームワークで実行
- **開発効率**: Storybookでのテスト実行とVitest UIでの結果確認が可能
- **保守性**: 単一のテストフレームワークによる設定・依存関係の簡素化
- **コスト**: 完全無料のOSSソリューション

## フォールバック案

### Storybook Test Runner + jest-image-snapshot
もしVitest Browser Mode（実験的機能）の安定性に懸念がある場合の代替案：

**メリット**:
- 既存Storybookワークフローからの自然な拡張
- 安定したJestベースの実装
- GitHub Actionsとの親和性が高い

**デメリット**:
- 現在のVitestテスト環境と分離
- 設定ファイルの作成とCI環境準備が必要

## 段階的実装アプローチ

### フェーズ1: Vitestベース導入（推奨）
1. **storybook-addon-vis + Vitest**を選択
2. 理由：
   - 既存のVitest環境と完全統合
   - 現代的なアプローチで将来性が高い
   - Storybook UIでの直感的なテスト実行
   - 完全無料
   - 実ブラウザでの正確なビジュアル検証

### フェーズ2: 検証・拡張
- 運用を通じてVitest Browser Modeの安定性確認
- 必要に応じてJestベースアプローチ（Test Runner）への移行検討
- またはChromatic（予算がある場合）への移行検討

### フェーズ3: 最適化
- CI/CD統合の最適化
- スナップショット管理の自動化
- レビューワークフローの改善

## 結論

現在のプロジェクト状況（Vitest v3.2.4ベースのテスト環境）を考慮すると、**storybook-addon-vis + Vitest**による実装が最適解です。

### 最終選定理由
1. **テスト統合**: 既存のVitestテスト環境と完全統合
2. **現代性**: 2025年の最新アプローチで将来性が高い
3. **Storybook統合**: Storybook UIでの直感的なテスト実行・確認
4. **実ブラウザ**: Vitest Browser Modeによる正確なビジュアル検証
5. **コスト効率**: 完全無料で運用可能
6. **段階的導入**: 小さく始めて徐々に拡張可能

---

**作成日**: 2025年7月6日  
**対象Issue**: #32  
**ブランチ**: issue-32  
**調査実施者**: Claude Code