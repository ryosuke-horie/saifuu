# 環境変数設定ガイド

## 概要

Saifuuプロジェクトでは、Next.js + Cloudflare Workersの環境で動作するため、環境変数の設定方法が通常のNext.jsアプリケーションとは異なります。このドキュメントでは、正しい環境変数の設定方法を説明します。

## 重要な原則

### ビルド時と実行時の違い

1. **ビルド時（Next.js）**
   - `NEXT_PUBLIC_` プレフィックスを持つ環境変数はビルド時にクライアントサイドのコードに埋め込まれます
   - これらの値は `.env*` ファイルから読み込まれます
   - `wrangler.jsonc` の設定は**読み込まれません**

2. **実行時（Cloudflare Workers）**
   - `wrangler.jsonc` や Cloudflare ダッシュボードで設定した環境変数はサーバーサイドでのみ利用可能
   - クライアントサイドからはアクセスできません

## 環境変数の設定方法

### クライアントサイド用（NEXT_PUBLIC_）

#### 開発環境
`.env.local` ファイルに設定：
```
NEXT_PUBLIC_API_URL=http://localhost:5173/api
```

#### 本番環境
`.env.production` ファイルに設定：
```
NEXT_PUBLIC_API_URL=https://saifuu-api.ryosuke-horie37.workers.dev/api
```

### サーバーサイド用

#### 開発環境
`wrangler.jsonc` の `vars` セクションに設定：
```jsonc
{
  "vars": {
    "DATABASE_URL": "file:./dev.db"
  }
}
```

#### 本番環境
Cloudflare ダッシュボードまたは `wrangler secret` コマンドで設定：
```bash
npx wrangler secret put API_KEY
```

## デプロイ時の注意事項

### ローカルでのビルド＆デプロイ
```bash
# 1. 本番用環境変数を確認
cat .env.production

# 2. ビルド（.env.production が自動的に読み込まれる）
npm run build

# 3. デプロイ
npm run deploy
```

### CI/CD環境でのビルド
GitHub Actions などでは、シークレットから環境変数を設定：

```yaml
- name: Build Next.js
  env:
    NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
  run: npm run build
```

## トラブルシューティング

### 問題: 本番環境で localhost にアクセスしようとする
**原因**: ビルド時に `NEXT_PUBLIC_API_URL` が設定されていない
**解決策**: `.env.production` ファイルを作成し、正しいURLを設定

### 問題: wrangler.jsonc に設定した NEXT_PUBLIC_ 変数が反映されない
**原因**: `wrangler.jsonc` の設定は実行時のみ有効で、ビルド時には読み込まれない
**解決策**: `.env.production` ファイルに移動

## ベストプラクティス

1. **環境変数の分類を明確に**
   - クライアントサイド: `NEXT_PUBLIC_` プレフィックス → `.env*` ファイル
   - サーバーサイド: プレフィックスなし → `wrangler.jsonc` または Cloudflare Secrets

2. **セキュリティ**
   - APIキーなどの機密情報は絶対に `NEXT_PUBLIC_` プレフィックスを付けない
   - 機密情報は `wrangler secret` コマンドを使用

3. **ドキュメント化**
   - `.env.example` ファイルに必要な環境変数をリスト
   - 各環境変数の用途をコメントで説明