# フロントエンドロガー設計

## 概要

Saifuu家計管理アプリケーションのフロントエンドロギングシステムの設計仕様書です。Next.js 15 + React 19環境での高性能な構造化ログ機能を提供し、開発・運用の効率化とユーザーエクスペリエンスの向上を実現します。

## 設計目標

### 1. React 19 最適化
- 新しいOwner Stack機能を活用したコンポーネント階層デバッグ
- 並行レンダリング機能との適切な統合
- useTransition、Suspenseに対応したログ戦略

### 2. Next.js 15 統合
- SSR/CSR両対応のログ戦略
- クライアントサイド計測（instrumentation-client.js）活用
- ハイドレーション問題の適切な対処

### 3. 開発・運用効率化
- Storybookコンポーネント開発との統合
- APIロガーとの完全なrequestId相関
- 型安全なログ機能
- デバッグとトラブルシューティングの簡素化

### 4. パフォーマンス最適化
- バンドルサイズへの最小限の影響
- ブラウザ実行時パフォーマンスの維持
- メモリ効率的なバッファリング

## アーキテクチャ設計

### 1. コアインターフェース設計

**ログレベル定義**
4段階のログレベル（debug、info、warn、error）により、開発段階と重要度に応じた適切な情報分類を実現します。debugは詳細なデバッグ情報、infoは正常な操作記録、warnは警告レベルの問題、errorは深刻なシステムエラーを表します。

**ログメタデータ構造**
各ログエントリには、requestId、userId、component名、action名、実行時間、エラー情報等の豊富なメタデータを付与できます。これにより、フロントエンド特有のユーザーインタラクション、コンポーネント動作、パフォーマンス情報を包括的に記録できます。

**統一ログエントリ形式**
全てのログは、タイムスタンプ、ログレベル、メッセージ、requestId、環境情報、セッション情報、メタデータを含む統一された構造で記録されます。これにより、一貫性のある分析と検索が可能になります。

**環境別設定システム**
development、production、storybookの3つの環境に対応した設定システムを提供します。各環境でバッファサイズ、フラッシュ間隔、コンソール出力有無、外部API送信先等を適切に調整できます。

**フロントエンド専用機能**
基本的なログ機能に加えて、ユーザーアクション追跡、ページビュー記録、APIコール追跡等のフロントエンド特有の機能を標準装備します。これにより、ユーザーエクスペリエンスの分析とデバッグが効率化されます。

### 2. React統合設計

**Context Provider システム**
Reactアプリケーション全体でロガーインスタンスを共有するため、LoggerProviderコンポーネントを提供します。これにより、アプリケーションの任意の場所からログ機能にアクセスできる一元化された仕組みを構築します。

**基本ロガーフック（useLogger）**
最も基本的なロガーフックとして、全てのログレベル（debug、info、warn、error）とフロントエンド専用機能（ユーザーアクション追跡、ページビュー記録等）へのアクセスを提供します。

**コンポーネント専用ログフック（useComponentLogger）**
コンポーネント名を自動的にログメタデータに含める専用フックです。これにより、どのコンポーネントからログが発生したかを明確に追跡でき、コンポーネントレベルでのデバッグとパフォーマンス分析が容易になります。

**自動ログ付きコールバックフック（useLoggedCallback）**
ユーザーアクションの開始、完了、失敗を自動的にログ記録するフックです。実行時間の計測、エラーハンドリング、メタデータの追加を自動化し、手動でのログ記述を大幅に削減します。

**パフォーマンス最適化**
全てのフックはReactのuseCallbackやuseMemoを適切に活用し、不要な再レンダリングを防ぎ、パフォーマンスへの影響を最小限に抑制します。また、React 19の並行レンダリング機能との互換性を確保します。

### 3. ブラウザ最適化ロガー設計

**高性能バッファリングシステム**
ブラウザ環境でのパフォーマンス影響を最小化するため、ログエントリを内部バッファに蓄積し、一定のサイズや時間間隔で一括処理します。これにより、個別のログ出力による性能低下を防ぎ、ユーザーエクスペリエンスを損なわない設計を実現します。

**インテリジェントログレベル制御**
設定されたログレベルに基づく効率的なフィルタリング機能により、不要なログ処理を事前に除外します。開発環境では詳細なデバッグ情報を、本番環境では警告以上の重要な情報のみを記録し、適切な情報密度を維持します。

**ブラウザイベント連携**
ページの可視性変更（visibilitychange）やページ離脱（beforeunload）等のブラウザイベントと連携し、重要なタイミングでログの確実な記録を保証します。これにより、ユーザーセッション中のログ損失を最小化します。

**フロントエンド特化機能**
標準的なログ機能に加えて、ユーザーアクション追跡、ページビュー記録、APIコール追跡等の機能を専用メソッドとして提供します。各機能は適切なメタデータタグ付けにより、後の分析で容易に識別・分類できます。

**環境適応型出力制御**
開発環境では詳細な構造化情報をブラウザコンソールに出力し、本番環境では外部APIへの送信とコンソール出力の簡素化を行います。また、ログ送信失敗時のフォールバック機能により、情報の確実な記録を保証します。

**セッション管理とメタデータ拡張**
各ユーザーセッションに一意のIDを割り当て、ブラウザ環境情報（URL、ユーザーエージェント等）を自動的にメタデータに追加します。これにより、ログの文脈情報を豊富にし、問題の特定と分析を効率化します。

### 4. エラーバウンダリ強化設計

**構造化エラーキャプチャ機能**
Reactアプリケーション内で発生する予期しないエラーを自動的に捕捉し、エラーメッセージ、スタックトレース、コンポーネントスタック等の詳細情報を構造化された形式でログに記録します。

**自動ログ統合システム**
エラー発生時に、ロガーシステムと自動的に連携してエラー情報を記録します。これにより、開発者が手動でエラーログを記述する必要がなく、一貫性のあるエラー追跡が実現されます。

**ユーザーエクスペリエンス配慮**
エラー発生時には、技術的な詳細を隠したユーザーフレンドリーな代替UIを表示します。開発環境では詳細なエラー情報を、本番環境では適切にマスクされた情報を提示し、環境に応じた適切な情報公開を行います。

**カスタマイズ可能なエラーハンドリング**
標準的なエラー処理に加えて、コンポーネント固有の追加処理を実行できるカスタムエラーハンドラーシステムを提供します。これにより、アプリケーション特有の要件に柔軟に対応できます。

**HOCパターンサポート**
Higher-Order Component（HOC）パターンにより、既存のコンポーネントに対して非侵襲的にエラーバウンダリ機能を追加できます。これにより、レガシーコードへの適用も容易になります。

### 5. API統合とrequestId相関設計

**End-to-Endトレーサビリティ**
フロントエンドで生成した一意のrequestIdを、APIリクエストヘッダーを通じてバックエンドに伝達します。これにより、ユーザーアクションからバックエンド処理まで、完全な処理フローを単一のIDで追跡できるシステムを構築します。

**インターセプターベース統合**
既存のAPIクライアントに対して、リクエスト・レスポンスインターセプターを通じた非侵襲的なログ機能統合を行います。これにより、既存のAPI呼び出しコードを変更することなく、包括的なAPI監視機能を追加できます。

**自動パフォーマンス計測**
各API呼び出しの開始時刻を記録し、レスポンス受信時に実行時間を自動計算してログに記録します。これにより、フロントエンド視点でのAPI応答性能を継続的に監視できます。

**詳細エラー情報収集**
API呼び出し失敗時には、HTTPステータスコード、エラーメッセージ、スタックトレース等の詳細情報を自動的に収集し、構造化されたログとして記録します。これにより、API関連の問題の迅速な特定と解決を支援します。

**バックエンドログとの完全連携**
フロントエンドとバックエンドで同一のrequestIdを使用することで、問題発生時にクライアント・サーバー双方のログを相関させた分析が可能になります。これにより、複雑な分散システムでの問題切り分けが効率化されます。

### 6. Next.js統合設計

**アプリケーション全体での統合**
Next.js 15のApp Routerアーキテクチャに対応し、ルートレイアウトコンポーネントでLoggerProviderとErrorBoundaryを統合します。これにより、アプリケーション全体で一貫したログ機能とエラーハンドリングを提供します。

**ミドルウェアレベルでのrequestId管理**
Next.jsミドルウェア機能を活用し、フロントエンドリクエストに対してrequestIdの生成・管理・ヘッダー追加を自動化します。これにより、サーバーサイドレンダリング（SSR）とクライアントサイドレンダリング（CSR）の両方で一貫したrequestId管理を実現します。

**SSR/CSRハイブリッド対応**
Next.js特有のSSR/CSRハイブリッド環境において、サーバーサイドとクライアントサイドの両方で適切にログ機能が動作するよう設計します。ハイドレーション時の状態継承や、環境間でのログ連続性を保証します。

**クライアントサイド計測統合**
Next.js 15の新機能であるクライアントサイド計測（instrumentation-client.js）と連携し、アプリケーション初期化前からのパフォーマンス監視とログ収集を可能にします。

**App Router最適化**
Next.js App Routerの階層構造とレイアウトシステムに最適化されたログコンテキスト設計により、ページやコンポーネント単位での効率的なログ管理を実現します。

### 7. Storybook統合設計

**コンポーネント開発ワークフロー統合**
Storybookコンポーネント開発環境において、専用のログ設定とロガーインスタンスを提供します。開発者がコンポーネントの動作を詳細に観察し、デバッグできる環境を構築します。

**インタラクション自動ログ機能**
Storybookのアクションアドオンと連携し、コンポーネントとのユーザーインタラクション（クリック、ホバー等）を自動的にログに記録します。これにより、コンポーネントの動作検証とテストケース作成が効率化されます。

**Storybook専用設定最適化**
本番環境や開発環境とは異なる、Storybook専用の最適化された設定を提供します。詳細なデバッグ情報の出力、短いバッファサイズとフラッシュ間隔、コンソール出力の有効化等により、コンポーネント開発に最適な環境を構築します。

**デコレーターパターン統合**
Storybookのデコレーターパターンを活用し、全てのストーリーに対して非侵襲的にログ機能を追加します。既存のストーリーコードを変更することなく、包括的なログ機能を提供します。

**開発者体験向上**
コンポーネント動作の可視化、パフォーマンス分析、エラー追跡等の機能により、コンポーネント開発時の開発者体験を大幅に向上させます。リアルタイムでのログ表示により、即座に問題を特定・解決できます。

### 8. パフォーマンス監視設計

**コンポーネントレベル性能監視**
Reactコンポーネントの描画時間を自動計測するフック機能を提供します。コンポーネントのマウント・アンマウント時に処理時間を測定し、性能問題の早期発見を支援します。

**カスタム操作性能追跡**
任意の処理やユーザーアクションに対して、開始・終了時刻を記録するマーカー機能を提供します。これにより、アプリケーション固有の重要な処理の性能を詳細に監視できます。

**Web Vitals統合監視**
GoogleのCore Web Vitals（CLS、FID、FCP、LCP、TTFB）を自動的に監視・記録する機能を提供します。ユーザーエクスペリエンスに直結する重要な性能指標を継続的に追跡し、UX改善の基礎データを提供します。

**非同期パフォーマンスデータ収集**
ブラウザのPerformance APIを活用し、レンダリング性能、ネットワーク性能、JavaScript実行性能等の詳細な性能データを非同期で収集・記録します。

**性能低下検知アラート**
設定された閾値を超える性能問題を検知した際に、自動的にアラートログを生成する機能を提供します。これにより、性能問題の早期発見と迅速な対応を可能にします。

## 設定システム

### 1. 環境別設定管理

**3環境対応設定システム**
development（開発）、production（本番）、storybook（コンポーネント開発）の3つの環境に対応した設定システムを提供します。各環境の特性に応じて、ログレベル、バッファサイズ、フラッシュ間隔、コンソール出力等を最適化します。

**開発環境最適化**
詳細なデバッグ情報の出力、小さなバッファサイズによる即座の情報表示、短いフラッシュ間隔による迅速なフィードバック、コンソール出力の有効化により、開発効率を最大化します。

**本番環境最適化**
警告レベル以上の重要な情報のみの記録、大きなバッファサイズによる性能向上、長いフラッシュ間隔による効率的な処理、外部API送信機能により、本番環境での適切な監視を実現します。

**Storybook環境特化**
コンポーネント開発に特化した設定として、全てのログレベルの出力、リアルタイムのインタラクション監視、即座のフィードバック等を提供し、コンポーネント開発の効率化を図ります。

### 2. 環境変数管理

**設定可能パラメータ**
ログエンドポイントURL、ログレベル、バッファサイズ、フラッシュ間隔等の主要設定を環境変数で制御可能にします。これにより、デプロイ環境や運用要件に応じた柔軟な設定調整を実現します。

**セキュリティ配慮**
外部API送信先等の機密性のある設定については、適切な環境変数管理とクライアントサイド露出の制御を行い、セキュリティリスクを最小化します。

## テスト戦略

### 1. ユニットテスト戦略

**BrowserLoggerクラスのテスト**
BrowserLoggerクラスの単体テストでは、ログレベル別の出力制御、メタデータの適切な付与、環境別設定の動作確認を行います。開発環境でのコンソール出力検証、ユーザーアクション追跡の正確性、バッファリング機能の動作等を包括的にテストします。

**設定システムのテスト**
環境別設定の適用、環境変数からの設定読み込み、デフォルト値の適用等、設定システムの動作を詳細に検証します。不正な設定値に対するエラーハンドリングやフォールバック機能も含めてテストします。

**エラーハンドリングのテスト**
例外発生時の適切なログ記録、エラー情報の構造化、スタックトレースの取得等、エラーハンドリング機能の動作を検証します。様々なエラーパターンに対する適切な対応を確認します。

### 2. React統合テスト戦略

**React Hooksのテスト**
useLogger、useComponentLogger等のカスタムフックについて、React Testing Libraryを使用したテストを実施します。フック内でのロガーインスタンスの適切な取得、コンポーネント名の自動付与、メタデータの正確な設定を検証します。

**Context Providerのテスト**
LoggerProviderコンポーネントによるロガーインスタンスの配布、子コンポーネントでの適切なアクセス、プロバイダー階層での設定継承等を検証します。

**エラーバウンダリのテスト**
強化されたエラーバウンダリコンポーネントについて、エラー捕捉機能、自動ログ記録、ユーザーフレンドリーな代替UI表示等の動作を検証します。

## 実装フェーズ

### フェーズ1: 基盤構築
**コア機能の実装**
ログレベル、メタデータ構造、ログエントリ形式等の基本的な型定義を実装し、フロントエンドロガーの土台を構築します。BrowserLoggerクラスでは、バッファリング、ログレベル制御、環境別設定等のコア機能を実装します。

**設定管理システム**
開発・本番・Storybook環境に対応した設定システムを構築し、環境変数からの設定読み込み、デフォルト値の適用、セキュリティ配慮等を実装します。

### フェーズ2: React統合
**Context Provider実装**
Reactアプリケーション全体でロガーインスタンスを共有するためのLoggerContextとProviderを実装します。適切なスコープ管理と状態継承を確保します。

**カスタムフック開発**
useLogger、useComponentLogger、useLoggedCallback等のReact専用フックを実装し、開発者体験の向上と利用の簡素化を図ります。

**エラーバウンダリ強化**
既存のエラーバウンダリにログ機能を統合し、構造化されたエラー情報の自動記録と適切なユーザーエクスペリエンスを提供します。

### フェーズ3: 統合とツール連携
**API統合とトレーサビリティ**
既存のAPIクライアントとの統合により、requestId相関、自動パフォーマンス計測、詳細エラー情報収集を実現します。フロントエンドとバックエンドの完全な連携を構築します。

**Next.js統合**
App Routerアーキテクチャ、ミドルウェア、SSR/CSRハイブリッド環境、クライアントサイド計測等、Next.js 15の機能と深く統合します。

**Storybook統合**
コンポーネント開発環境での専用ログ設定、インタラクション自動記録、デコレーターパターン統合により、開発者体験を大幅に向上させます。

### フェーズ4: 最適化と監視
**パフォーマンス監視システム**
コンポーネントレベルの性能監視、カスタム操作の追跡、自動マーカー機能により、詳細なパフォーマンス分析を可能にします。

**Web Vitals統合**
GoogleのCore Web Vitals（CLS、FID、FCP、LCP、TTFB）の自動監視により、ユーザーエクスペリエンスの継続的な改善を支援します。

**本番環境最適化**
バンドルサイズの最小化、実行時パフォーマンスの最適化、メモリ効率の向上等を実施し、本番環境での安定稼働を確保します。

## 今後の拡張

### 1. 高度な分析
- ユーザー行動パターン分析
- パフォーマンス傾向の可視化
- エラー発生パターンの分析

### 2. 外部サービス連携
- LogRocket、Sentry等との統合
- カスタムダッシュボード構築
- アラート機能の実装

### 3. 開発者体験向上
- VSCode拡張機能
- デバッグツール強化
- ログ検索・フィルタリング機能

---

この設計により、SaifuuアプリケーションはモダンなReact開発環境に最適化された包括的なフロントエンドログ機能を獲得し、開発・運用の効率化とユーザーエクスペリエンスの向上を実現します。