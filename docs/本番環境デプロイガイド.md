# 本番環境デプロイガイド

## 概要

このドキュメントでは、Saifuu APIを本番環境（Cloudflare Workers）にデプロイする手順を説明します。

## 前提条件

1. Cloudflare APIトークンが設定されていること
2. Node.js 22がインストールされていること
3. wranglerがインストールされていること

## デプロイ方法

### 方法1: 自動デプロイ（推奨）

マイグレーションを含む完全なデプロイを実行します：

```bash
cd api
npm run deploy:production
```

このスクリプトは以下を自動実行します：
1. アプリケーションのビルド
2. マイグレーション状態の確認
3. 必要なマイグレーションの適用
4. Cloudflare Workersへのデプロイ
5. デプロイ結果の確認

### 方法2: 手動デプロイ

個別にステップを実行する場合：

```bash
# 1. ビルド
npm run build

# 2. マイグレーション確認
wrangler d1 migrations list saifuu-db --remote

# 3. マイグレーション適用（必要な場合）
npm run db:migrate:remote

# 4. デプロイ
npm run deploy:manual
```

## 環境変数の設定

### Cloudflare APIトークン

```bash
export CLOUDFLARE_API_TOKEN="your-api-token"
```

トークンの作成方法：
1. https://dash.cloudflare.com/profile/api-tokens にアクセス
2. "Create Token"をクリック
3. "Custom token"を選択
4. 以下の権限を付与：
   - Account:Cloudflare Workers Scripts:Edit
   - Account:D1:Edit

## デプロイ後の確認

### APIヘルスチェック

```bash
curl https://saifuu-api.ryosuke-horie37.workers.dev/api/health
```

期待されるレスポンス：
```json
{
  "status": "ok",
  "database": "connected"
}
```

### カテゴリ一覧の取得

```bash
curl https://saifuu-api.ryosuke-horie37.workers.dev/api/categories
```

## トラブルシューティング

### マイグレーションエラー

```
Error: D1_ERROR: no such table: categories
```

→ マイグレーションが適用されていません。`npm run db:migrate:remote`を実行してください。

### 認証エラー

```
Error: Authentication required
```

→ `CLOUDFLARE_API_TOKEN`が正しく設定されているか確認してください。

### ビルドエラー

```
Error: Build failed
```

→ 依存関係が最新か確認：`npm ci`

## セキュリティ考慮事項

1. APIトークンは環境変数で管理し、コードにハードコードしない
2. デプロイ前にテストを実行する
3. 本番環境へのデプロイは慎重に行う

## ロールバック手順

Cloudflare Workersは自動的に以前のバージョンを保持しています。

1. Cloudflareダッシュボードにログイン
2. Workers & Pages → saifuu-api を選択
3. Deployments タブを開く
4. 以前の安定版を選択し、"Rollback"をクリック

## 関連ドキュメント

- [本番環境D1マイグレーション手順](./本番環境D1マイグレーション手順.md)
- [API開発ガイド](./API開発/README.md)