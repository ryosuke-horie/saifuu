# カテゴリマイグレーションガイド

## 概要

このドキュメントは、Saifuuのカテゴリ管理システムがデータベースベースから設定ファイルベースに移行された際のマイグレーション手順と、既存データの取り扱いについて説明します。

## 変更内容

### 1. カテゴリ管理方式の変更
- **変更前**: データベースの`categories`テーブルでカテゴリを管理
- **変更後**: `shared/config/categories.ts`の設定ファイルでカテゴリを管理

### 2. カテゴリIDマッピング

既存のデータベースにあるトランザクションやサブスクリプションは、以下のカテゴリIDを参照しています：

| numericId | カテゴリ名 | タイプ | 状態 |
|-----------|-----------|---------|------|
| 1 | 家賃・水道・光熱・通信費 | expense | 維持 |
| 2 | 住居費 | expense | 維持 |
| 3 | 食費 | expense | 維持 |
| 4 | 交通費 | expense | 維持 |
| 5 | 仕事・ビジネス | expense | 維持 |
| 6 | システム関係費（旧：システム関係日） | expense | 名称変更 |
| 7 | 学習・教育 | expense | **削除** |
| 8 | 書籍代 | expense | 維持 |
| 9 | エンターテイメント | expense | **削除** |
| 10 | 健康・フィットネス | expense | 維持 |
| 11 | 買い物 | expense | 維持 |
| 12 | その他 | expense | 維持 |
| 13 | 給与 | income | **削除** |
| 14 | 副業・フリーランス | income | **削除** |
| 15 | 投資・資産運用 | income | **削除** |
| 16 | 贈与・お祝い | income | **削除** |
| 17 | その他（収入） | income | **削除** |

## 既存データの取り扱い

### 1. 削除されたカテゴリを参照しているデータ

以下のカテゴリIDを参照しているトランザクションやサブスクリプションは、APIレスポンスで`category: null`として返されます：
- ID 7: 学習・教育
- ID 9: エンターテイメント
- ID 13-17: すべての収入カテゴリ

### 2. 影響を受けるテーブル
- `transactions`テーブル: `categoryId`カラム
- `subscriptions`テーブル: `categoryId`カラム

## マイグレーション手順

### 手動でのデータ更新（推奨）

削除されたカテゴリを使用しているレコードを、適切な新しいカテゴリに更新することを推奨します。

```sql
-- 例: 学習・教育（ID:7）を書籍代（ID:8）に移行
UPDATE transactions 
SET categoryId = 8 
WHERE categoryId = 7;

UPDATE subscriptions 
SET categoryId = 8 
WHERE categoryId = 7;

-- 例: エンターテイメント（ID:9）をその他（ID:12）に移行
UPDATE transactions 
SET categoryId = 12 
WHERE categoryId = 9;

UPDATE subscriptions 
SET categoryId = 12 
WHERE categoryId = 9;

-- 収入カテゴリ（ID:13-17）のデータがある場合は、個別に対応を検討
-- 例: すべてその他（ID:12）に移行
UPDATE transactions 
SET categoryId = 12 
WHERE categoryId IN (13, 14, 15, 16, 17);
```

### APIレスポンスの変更

削除されたカテゴリを参照しているデータは、以下のようなレスポンスになります：

```json
{
  "id": 123,
  "amount": 1000,
  "categoryId": 7,
  "category": null,  // カテゴリが見つからない場合
  // その他のフィールド
}
```

## 注意事項

1. **numericIdは絶対に変更しない**: 既存データとの整合性を保つため、`numericId`は一度設定したら変更しないでください。

2. **新しいカテゴリの追加**: 新しいカテゴリを追加する場合は、既存の最大ID（現在は17）より大きい値を使用してください。

3. **削除したIDの再利用禁止**: 削除されたカテゴリID（7, 9, 13-17）は、将来的にも再利用しないでください。

4. **フロントエンドの対応**: フロントエンドでは`category: null`の場合の表示処理を適切に行う必要があります。

## トラブルシューティング

### Q: カテゴリが表示されない
A: 以下を確認してください：
- 対象のカテゴリIDが設定ファイルに存在するか
- `numericId`が正しく設定されているか
- カテゴリタイプ（expense/income）が正しいか

### Q: 既存データのカテゴリをどう移行すべきか
A: ビジネス要件に応じて適切なカテゴリに移行してください。不明な場合は「その他（ID:12）」への移行を推奨します。

## 関連ファイル

- カテゴリ設定: `shared/config/categories.ts`
- APIルート: `api/src/routes/categories.ts`
- フロントエンドAPI: `frontend/src/lib/api/categories/api.ts`