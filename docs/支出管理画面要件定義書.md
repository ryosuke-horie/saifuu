# 支出管理画面要件定義書

## プロジェクト概要

家計管理アプリケーション「Saifuu」における支出管理画面の実装要件を定義します。本機能により、ユーザーは収入・支出の記録、編集、分析を効率的に行えるようになります。

## 現状分析

### 実装済み機能
- **データベース**: transactionsテーブル完全定義済み
- **フロントエンドAPIサービス**: transactions.ts完全実装済み
- **型定義**: TypeScript型定義完備
- **カテゴリ機能**: バックエンドAPI完了、フロントエンドUI未実装
- **サブスクリプション機能**: 参考実装として完全実装済み

### 未実装機能
- **バックエンドAPI**: transactions用APIルート未実装
- **フロントエンドUI**: 支出管理用コンポーネント未実装
- **支出管理ページ**: `/expenses`ルート未実装

## 機能要件

### 1. 基本機能

#### 1.1 支出・収入の記録
- **機能**: 新しい取引を登録する
- **入力項目**:
  - 金額 (必須) - 数値入力、正の値のみ
  - 種別 (必須) - income/expense選択
  - カテゴリ (必須) - 既存カテゴリから選択
  - 説明 (任意) - 自由記述
  - 日付 (必須) - 日付選択、デフォルト今日
- **バリデーション**:
  - 金額: 正の数値、上限1,000,000円
  - 日付: 未来日制限なし
  - カテゴリ: 選択必須
- **UX**: モーダルダイアログ形式で入力

#### 1.2 支出・収入の一覧表示
- **機能**: 登録済み取引を一覧表示
- **表示項目**:
  - 日付
  - 金額（収入は+表示、支出は-表示）
  - カテゴリ名
  - 説明
  - 操作ボタン（編集・削除）
- **並び順**: 日付降順（新しい順）
- **レスポンシブ**: モバイル端末で適切に表示

#### 1.3 支出・収入の編集
- **機能**: 既存取引を編集・削除
- **編集項目**: 記録時と同じ項目
- **削除機能**: 確認ダイアログ付き削除
- **UX**: インライン編集またはモーダル編集

#### 1.4 フィルタリング・検索
- **期間指定**: 月単位、カスタム期間指定
- **カテゴリ絞り込み**: 単一・複数カテゴリ選択
- **種別絞り込み**: 収入のみ、支出のみ、両方
- **金額範囲指定**: 最小・最大金額設定

### 2. 統計・分析機能

#### 2.1 基本統計
- **月間収支**: 当月の収入・支出・差額
- **カテゴリ別内訳**: 円グラフまたは棒グラフ
- **期間比較**: 前月比、昨年同月比
- **日別推移**: 当月の日別収支グラフ

#### 2.2 要約情報
- **今月の統計**: 総収入、総支出、収支差額
- **主要カテゴリ**: 最大支出カテゴリ、最大収入カテゴリ
- **平均値**: 日平均支出、月平均支出

### 3. カテゴリ管理機能

#### 3.1 カテゴリ一覧
- **機能**: 収入・支出カテゴリの一覧表示
- **表示項目**: カテゴリ名、種別、色、使用回数
- **並び順**: 使用頻度順

#### 3.2 カテゴリ作成・編集
- **機能**: 新規カテゴリの作成と既存カテゴリの編集
- **入力項目**:
  - カテゴリ名 (必須)
  - 種別 (必須) - income/expense
  - 色 (任意) - UI表示用
- **バリデーション**: 同一種別内でのカテゴリ名重複チェック

## 技術要件

### 1. フロントエンド実装

#### 1.1 ページ構成
```
/expenses
├── ExpensesPage.tsx           # メインページ
├── components/
│   ├── ExpenseForm.tsx        # 取引登録・編集フォーム
│   ├── ExpenseList.tsx        # 取引一覧
│   ├── ExpenseStats.tsx       # 統計表示
│   ├── ExpenseFilters.tsx     # フィルタリング
│   └── CategoryManager.tsx    # カテゴリ管理
└── [id]/
    └── ExpenseDetailPage.tsx  # 取引詳細（将来実装）
```

#### 1.2 コンポーネント設計
- **ExpenseForm**: 既存SubscriptionFormパターンを踏襲
- **ExpenseList**: 既存SubscriptionListパターンを踏襲
- **ExpenseStats**: 新規実装、統計カード表示
- **ExpenseFilters**: 新規実装、フィルタリング機能
- **CategoryManager**: カテゴリCRUD操作

#### 1.3 状態管理
- **フォーム状態**: React Hook Form使用
- **一覧状態**: useStateまたはuseReducer
- **フィルタ状態**: URLパラメータ連携
- **統計状態**: APIから取得、キャッシュ対応

### 2. バックエンド実装

#### 2.1 APIルート実装
**ファイル**: `/api/src/routes/transactions.ts`

```typescript
// 必要なエンドポイント
GET    /api/transactions              # 取引一覧取得
POST   /api/transactions              # 取引作成
GET    /api/transactions/:id          # 取引詳細取得
PUT    /api/transactions/:id          # 取引更新
DELETE /api/transactions/:id          # 取引削除
GET    /api/transactions/stats        # 統計取得
```

#### 2.2 バリデーション
- **Zod**: リクエストボディのバリデーション
- **型安全**: TypeScript型定義との整合性
- **エラー処理**: 適切なHTTPステータスコード

#### 2.3 データベース操作
- **Drizzle ORM**: 既存パターンを踏襲
- **JOIN操作**: categoriesテーブルとの結合
- **集計処理**: 統計情報の効率的な取得

### 3. テスト実装

#### 3.1 ユニットテスト
- **Vitest**: ユーティリティ関数、バリデーション
- **React Testing Library**: コンポーネント単体テスト
- **Coverage**: 80%以上のテストカバレッジ

#### 3.2 Storybookストーリー
- **全コンポーネント**: 各コンポーネントのストーリー実装
- **状態バリエーション**: Default, Loading, Error, Empty
- **レスポンシブ**: Mobile, Tablet, Desktop
- **インタラクション**: ユーザー操作テスト

#### 3.3 E2Eテスト
- **正常系のみ**: 基本的な取引登録・編集フロー
- **Playwright**: 既存テストパターンを踏襲
- **最小限**: GitHub Actions無料枠を考慮

## UI/UX要件

### 1. デザイン要件

#### 1.1 デザインシステム
- **色彩**: 既存のBlue色系統を踏襲
- **タイポグラフィ**: Geist SansとMonoフォント
- **レスポンシブ**: Mobile-first設計
- **アクセシビリティ**: WCAG 2.1 AA準拠

#### 1.2 レイアウト
- **ヘッダー**: 既存Headerコンポーネント拡張
- **ナビゲーション**: 新規「支出管理」項目追加
- **メインコンテンツ**: 3カラムレイアウト（統計・フィルタ・一覧）
- **モーダル**: 取引登録・編集用ダイアログ

### 2. ユーザビリティ

#### 2.1 操作性
- **ワンクリック登録**: 頻繁に使用される項目のショートカット
- **キーボードナビゲーション**: Tab/Enterキーによる操作
- **自動フォーカス**: モーダル開閉時の適切なフォーカス管理

#### 2.2 フィードバック
- **ローディング状態**: 非同期処理中の視覚的フィードバック
- **成功・エラー通知**: 操作結果の明確な表示
- **バリデーションエラー**: リアルタイムエラー表示

### 3. パフォーマンス

#### 3.1 レスポンス時間
- **初期ロード**: 2秒以内
- **操作レスポンス**: 0.5秒以内
- **データ取得**: 1秒以内

#### 3.2 最適化
- **遅延読み込み**: 大量データの効率的な表示
- **キャッシュ**: 統計データの適切なキャッシュ
- **バンドルサイズ**: 最小限のJavaScriptバンドル

## 実装優先度

### Phase 1: 基本機能実装（高優先度）
1. **バックエンドAPI**: transactions.ts実装
2. **基本UIコンポーネント**: ExpenseForm, ExpenseList
3. **メインページ**: ExpensesPage実装
4. **ナビゲーション**: Header拡張

### Phase 2: 統計・分析機能（中優先度）
1. **統計コンポーネント**: ExpenseStats実装
2. **フィルタリング**: ExpenseFilters実装
3. **データ可視化**: グラフ表示機能

### Phase 3: カテゴリ管理（中優先度）
1. **カテゴリ管理UI**: CategoryManager実装
2. **カテゴリ選択**: 改善されたカテゴリ選択UI

### Phase 4: 追加機能（低優先度）
1. **データエクスポート**: CSV/PDF出力
2. **バックアップ**: データの定期バックアップ
3. **詳細分析**: 高度な統計分析

## 品質保証

### 1. テスト戦略
- **TDD**: Test-Driven Developmentアプローチ
- **包括的テスト**: Unit, Integration, E2E
- **継続的統合**: GitHub Actions CI/CD

### 2. コード品質
- **TypeScript**: 厳密な型チェック
- **Biome**: リンター・フォーマッター
- **Code Review**: プルリクエストレビュー

### 3. セキュリティ
- **入力検証**: 全入力項目の適切な検証
- **SQLインジェクション**: Drizzle ORMによる保護
- **認証・認可**: 将来的な多ユーザー対応準備

## 完成基準

### 1. 機能完成基準
- [ ] 取引の登録・編集・削除が正常に動作
- [ ] 一覧表示とフィルタリングが正常に動作
- [ ] 統計情報が正確に表示される
- [ ] カテゴリ管理が正常に動作
- [ ] レスポンシブデザインが適切に機能

### 2. 品質基準
- [ ] ユニットテストカバレッジ80%以上
- [ ] 全コンポーネントのStorybookストーリー実装
- [ ] E2Eテストの正常系パス
- [ ] アクセシビリティ基準適合
- [ ] パフォーマンス基準達成

### 3. 運用基準
- [ ] CI/CDパイプラインの成功
- [ ] 本番環境での動作確認
- [ ] ドキュメント整備完了
- [ ] 運用マニュアル作成完了

## 今後の展開

### 1. 拡張機能
- **予算管理**: 月別予算設定と監視
- **定期取引**: 定期的な収入・支出の自動登録
- **レポート**: 月次・年次レポート生成
- **アラート**: 予算超過時の通知機能

### 2. 技術的改善
- **PWA**: Progressive Web Appの対応
- **オフライン**: オフライン利用サポート
- **同期**: 複数デバイス間のデータ同期
- **API最適化**: GraphQL導入検討

### 3. ユーザビリティ向上
- **ダークモード**: UI theme切り替え
- **カスタマイズ**: ユーザー設定のカスタマイズ
- **インポート**: 銀行データのインポート機能
- **AI機能**: 支出パターンの自動分析

---

**作成日**: 2025年7月6日  
**更新日**: 2025年7月6日  
**作成者**: Claude Code  
**レビュー**: 要レビュー