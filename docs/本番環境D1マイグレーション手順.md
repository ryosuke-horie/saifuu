# 本番環境D1マイグレーション適用手順

## 問題の概要

本番環境のD1データベース（saifuu-db）にマイグレーションが適用されていない状態です。これにより、本番環境でスキーマが存在せず、APIが正常に動作していない可能性があります。

## 現在の状況

### マイグレーションファイル
1. `0000_unknown_lilith.sql` - 初期テーブル作成（timestampはinteger型）
2. `0001_neat_tiger_shark.sql` - timestamp型をtext型に変更

### スキーマ状態
- **開発環境**: マイグレーション適用済み（text型のtimestamp）
- **本番環境**: マイグレーション未適用（テーブルが存在しない）

## 本番環境へのマイグレーション適用手順

### 1. 事前確認

```bash
# プロジェクトディレクトリに移動
cd /Users/r-horie/private/saifuu/saifuu-main/api

# 現在のマイグレーション状態を確認
wrangler d1 migrations list saifuu-db --remote
```

### 2. マイグレーションファイルの確認

```bash
# マイグレーションファイルの内容を確認
cat drizzle/migrations/0000_unknown_lilith.sql
cat drizzle/migrations/0001_neat_tiger_shark.sql
```

### 3. 本番環境へのマイグレーション適用

```bash
# 本番環境にマイグレーションを適用
npm run db:migrate:remote
# または
wrangler d1 migrations apply saifuu-db --remote
```

### 4. 適用結果の確認

```bash
# マイグレーションが適用されたことを確認
wrangler d1 migrations list saifuu-db --remote

# テーブルが作成されたことを確認（Cloudflareダッシュボードで確認推奨）
```

### 5. 動作確認

1. 本番環境のAPIエンドポイントにアクセスして正常に動作することを確認
   - https://saifuu-api.ryosuke-horie37.workers.dev/api/health
   - https://saifuu-api.ryosuke-horie37.workers.dev/api/categories

2. フロントエンドから本番APIへの接続が正常に行われることを確認

## 注意事項

1. **バックアップ**: 本番データベースにデータが存在する場合は、事前にバックアップを取得することを推奨
2. **段階的適用**: マイグレーションは順番に適用されるため、エラーが発生した場合は途中で停止します
3. **ロールバック**: D1はマイグレーションのロールバック機能を提供していないため、慎重に実行してください

## トラブルシューティング

### 認証エラーが発生する場合

```bash
# Cloudflare API トークンを設定
export CLOUDFLARE_API_TOKEN="your-api-token"
```

### マイグレーションエラーが発生する場合

1. エラーメッセージを確認
2. マイグレーションファイルのSQL構文を確認
3. D1データベースのクォータ制限を確認

## 実行後の確認項目

- [ ] マイグレーションが正常に適用された
- [ ] APIエンドポイントが正常に動作する
- [ ] フロントエンドからAPIへの接続が正常
- [ ] エラーログがない

## 関連ファイル

- `/api/wrangler.jsonc` - D1データベース設定
- `/api/drizzle/migrations/` - マイグレーションファイル
- `/api/src/db/schema.ts` - スキーマ定義