<!--
tags: #テスト #モニタリング #CI #品質保証 #自動化 #オーバーテスト防止 #パフォーマンス
category: 品質保証
priority: 高
status: 実装済み
last_updated: 2025-07-19
related_issues: [300, 309, 310, 311, 312, 313]
-->

# テストヘルスモニタリング

## 概要

テストコードの健全性を継続的に監視し、過剰なテストによる開発効率の低下を防ぐためのモニタリングシステムです。

## 監視項目

### 1. テストコード比率

コンポーネントの複雑度に応じて、適切なテストコード量を維持しているかを監視します。

#### 基準値

| コンポーネントサイズ | ソースコード行数 | テストコード比率上限 |
|---------------------|----------------|-------------------|
| シンプル | 100行未満 | 1.5倍 |
| 中規模 | 100-300行 | 2.0倍 |
| 大規模 | 300行以上 | 2.5倍 |

### 2. テスト実行時間

テストの実行時間を監視し、開発効率に影響を与える遅いテストを検出します。

#### 警告閾値

- **Frontend**: 60秒以上
- **API（ユニット + 統合）**: 90秒以上

## 実行方法

### ローカル実行

#### テストコード比率チェック

```bash
# シンプル版（外部依存なし）
npm run test:ratio

# 詳細版（globパッケージが必要）
npm run test:ratio:detailed
```

#### 手動実行例

```bash
# プロジェクトルートで実行
node scripts/monitor-test-ratio-simple.js
```

### CI/CD実行

GitHub Actionsワークフロー `test-health-monitoring.yml` により自動実行されます。

#### トリガー条件

1. **プルリクエスト**: frontend/api のコード変更時
2. **mainブランチへのpush**: 継続的な監視
3. **定期実行**: 毎週月曜日朝9時（JST）
4. **手動実行**: GitHub Actions UIから実行可能

## 出力形式

### ローカル実行時

```
=== テストコード比率監視レポート ===

📊 全体統計
  - 分析ファイル数: 44
  - ソースコード総行数: 8,756
  - テストコード総行数: 12,908
  - 全体比率: 1.47x

❌ 基準違反ファイル (22件):

  src/app/global-error.tsx
    カテゴリ: small (73行)
    比率: 3.47x (上限: 1.5x)
    テスト削減推奨: 約143行

✅ すべてのファイルが基準内です！
```

### CI実行時（PRコメント）

PRに以下の形式でコメントが自動投稿されます：

```markdown
# 📋 テストヘルスチェックレポート

## 🔍 テストコード比率分析

### ⚠️ テストコード比率の基準違反が検出されました

以下のファイルでテストコードが過剰になっています：
...

## ⏱️ Frontend テスト実行時間

- **実行時間**: 45秒
- **テスト総数**: 250
- **成功数**: 250

## ⏱️ API テスト実行時間

### ユニットテスト
- **実行時間**: 30秒

### 統合テスト
- **実行時間**: 25秒

### 合計
- **総実行時間**: 55秒
```

## 対応方法

### テストコード比率違反への対応

1. **実装詳細への依存を削除**
   - 内部状態のテストを削除
   - プライベートメソッドのテストを削除
   - DOM構造の詳細なテストを削除

2. **重複テストの統合**
   - 同じ動作の複数テストを統合
   - Storybookでカバーされる視覚的テストを削除

3. **価値の低いテストの削除**
   - サードパーティライブラリのテスト
   - 型で保証される内容のテスト
   - 些末な実装詳細のテスト

### テスト実行時間の改善

1. **テストの並列化**
   - 独立したテストスイートの並列実行
   - テストファイルの分割

2. **モックの活用**
   - 重い外部依存のモック化
   - データベースアクセスの最小化

3. **テストデータの最適化**
   - 必要最小限のテストデータ使用
   - セットアップ・ティアダウンの効率化

## 設定のカスタマイズ

### 比率上限の変更

`scripts/monitor-test-ratio-simple.js` の以下の部分を編集：

```javascript
const RATIO_LIMITS = {
  small: { lines: 100, ratio: 1.5 },
  medium: { lines: 300, ratio: 2.0 },
  large: { lines: Infinity, ratio: 2.5 }
};
```

### 実行時間閾値の変更

`.github/workflows/test-health-monitoring.yml` の以下の部分を編集：

```bash
# Frontend警告閾値
if [ $DURATION -gt 60 ]; then

# API警告閾値
if [ $TOTAL_DURATION -gt 90 ]; then
```

## 継続的改善プロセス

### 1. 定期レビュー（四半期ごと）

- テスト比率の傾向分析
- 実行時間の推移確認
- 基準値の見直し

### 2. チーム共有

- モニタリング結果の共有
- ベストプラクティスの更新
- 改善事例の横展開

### 3. 自動化の拡充

- 新たな監視指標の追加
- アラートの最適化
- レポートの改善

## トラブルシューティング

### スクリプトが動作しない

```bash
# 実行権限の付与
chmod +x scripts/monitor-test-ratio-simple.js

# Node.jsバージョンの確認（22以上推奨）
node --version
```

### CI実行エラー

- GitHub Actionsの権限設定を確認
- `GITHUB_TOKEN` の権限を確認
- ワークフローファイルの構文を確認

### 誤検知への対応

特定のファイルを除外したい場合は、スクリプトの `walkDir` 関数で除外条件を追加：

```javascript
// 除外ディレクトリをスキップ
if (['node_modules', 'dist', 'build', 'coverage', '.next', 'storybook-static', 'your-exclude-dir'].includes(file)) {
  return;
}
```

## 関連ドキュメント

- [テストガイド](./テストガイド.md) - テスト実装の基本方針
- [ADR-001: VRTシステムの削除](../adr/001-remove-vrt-system.md) - テスト戦略の背景
- [コマンドリファレンス](../コマンドリファレンス.md) - 利用可能なコマンド一覧