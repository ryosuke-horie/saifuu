# コマンドリファレンス

## 概要

Saifuuプロジェクトで使用する全コマンドの包括的なリファレンスです。

## プロジェクトセットアップ

### 初回セットアップ

```bash
# Node.js 22のインストール（mise使用）
mise install

# 依存関係のインストール（ルート）
pnpm install

# API依存関係のインストール
cd api && pnpm install

# フロントエンド依存関係のインストール
cd frontend && pnpm install

# 環境変数ファイルの作成
cp api/.env.example api/.env
cp frontend/.env.example frontend/.env

# 開発環境データベースのセットアップ（初回のみ）
cd api && pnpm run db:setup:dev
```

## 開発サーバー

### 通常の開発

```bash
# フロントエンド開発サーバー（ポート3000）
pnpm run dev

# API開発サーバー（ポート5173）
cd api && pnpm run dev

# Node.js版APIサーバー（デバッグ用）
cd api && pnpm run dev:node
```

### E2E開発環境

```bash
# E2E用フロントエンドサーバー（ポート3002）
cd frontend && pnpm run dev:e2e

# E2E用APIサーバー（ポート3003）
cd api && pnpm run dev:e2e
```

### バックグラウンド実行（Ghost使用）

```bash
# 開発サーバーをバックグラウンドで起動
ghost run pnpm run dev

# Storybookをバックグラウンドで起動
ghost run pnpm run storybook

# プロセス管理
ghost list                     # 実行中のプロセス一覧
ghost log <task-id>           # ログ確認
ghost stop <task-id>          # プロセス停止
ghost cleanup --days 7        # 古いタスクのクリーンアップ
```

## ビルド

### プロダクションビルド

```bash
# フロントエンドビルド
pnpm run build

# Cloudflare Workers用ビルド
cd frontend && pnpm run build:cf

# APIビルド
cd api && pnpm run build
```

### プレビュー

```bash
# フロントエンドプレビュー
cd frontend && pnpm run preview

# APIプレビュー
cd api && pnpm run preview
```

## テスト

### ユニットテスト

```bash
# フロントエンドユニットテスト
pnpm run test:unit

# APIユニットテスト
cd api && pnpm run test:unit

# カバレッジ付き実行
pnpm run test:unit:coverage
cd api && pnpm run test:unit:coverage

# ウォッチモード
pnpm run test:watch
cd api && pnpm run test:watch
```

### 統合テスト

```bash
# API統合テスト
cd api && pnpm run test:integration

# 全テスト実行（ユニット＋統合）
cd api && pnpm run test:all
```

### E2Eテスト

```bash
# E2Eテスト実行（自動サーバー起動）
pnpm run test:e2e

# UIモードで実行（デバッグ用）
pnpm run test:e2e:ui

# テスト結果レポート表示
pnpm run test:e2e:report
```

## コード品質

### 統合チェック

```bash
# 型チェック・リント・ユニットテスト
pnpm run check:fix

# API側も同様
cd api && pnpm run check:fix

# CIで使用（修正なし）
pnpm run ci:check
cd api && pnpm run check
```

### デッドコード検知（Knip）

```bash
# 基本的なデッドコード検知
cd frontend && pnpm run knip

# 本番環境向けの厳密な検知
cd frontend && pnpm run knip:production

# 自動修正付き検知
cd frontend && pnpm run knip:fix

# 型チェック・リント・テスト・デッドコード検知を一括実行
cd frontend && pnpm run check:knip
```

### 個別チェック

```bash
# 型チェックのみ
pnpm run typecheck
cd api && pnpm run typecheck

# リント（Biome）
pnpm run lint:biome
pnpm run lint:biome:fix

# フォーマット
pnpm run format
cd api && pnpm run format
```

## データベース管理

### 開発環境

```bash
# マイグレーション実行
cd api && pnpm run db:migrate:dev

# Drizzle Studio起動（DB可視化）
cd api && pnpm run db:studio:dev

# シードデータ投入
cd api && pnpm run db:seed:dev

# データベースリセット
cd api && pnpm run db:reset:dev

# 初回セットアップ（マイグレーション＋シード）
cd api && pnpm run db:setup:dev
```

### 本番環境（Cloudflare D1）

```bash
# リモートマイグレーション
cd api && pnpm run db:migrate:remote

# ローカルD1マイグレーション
cd api && pnpm run db:migrate:local

# ローカルD1シード
cd api && pnpm run db:seed

# ローカルD1リセット
cd api && pnpm run db:reset:local
```

### マイグレーション管理

```bash
# マイグレーションファイル生成
cd api && pnpm run db:generate

# D1 Studio起動
cd api && pnpm run db:studio
```

## コンポーネント開発（Storybook）

```bash
# Storybook開発サーバー（ポート6006）
pnpm run storybook

# Storybookビルド
pnpm run build-storybook
```

## デプロイ

### 自動デプロイ

```bash
# フロントエンドデプロイ
cd frontend && pnpm run deploy

# APIデプロイ
cd api && pnpm run deploy
```

### 手動デプロイ（ビルド付き）

```bash
# フロントエンド手動デプロイ
cd frontend && pnpm run deploy:manual

# API手動デプロイ
cd api && pnpm run deploy:manual
```

## 型生成

```bash
# Cloudflare Workers型生成（フロントエンド）
cd frontend && pnpm run cf-typegen

# Cloudflare Workers型生成（API）
cd api && pnpm run cf-typegen
```

## ポート一覧

| サービス | 開発環境 | E2E環境 |
|---------|---------|---------|
| フロントエンド | 3000 | 3002 |
| API | 5173 | 3003 |
| Storybook | 6006 | - |
| Drizzle Studio | 4983 | - |

## 環境変数

### API環境変数（api/.env）

```bash
# 開発環境用SQLiteデータベースパス
DEV_DB_PATH=./dev.db

# 環境フラグ
NODE_ENV=development
```

### フロントエンド環境変数（frontend/.env）

```bash
# API Base URL
NEXT_PUBLIC_API_URL=http://localhost:5173/api

# API設定
NEXT_PUBLIC_API_TIMEOUT=30000
NEXT_PUBLIC_API_MAX_RETRIES=3
NEXT_PUBLIC_API_RETRY_DELAY=1000
NEXT_PUBLIC_API_PORT=5173
```

## トラブルシューティング

### ポート使用中エラー

```bash
# 使用中のポートを確認
lsof -i :3000
lsof -i :5173

# プロセスを終了
kill -9 <PID>
```

### データベースエラー

```bash
# 開発DBリセット
cd api && pnpm run db:reset:dev

# E2E DBリセット
cd api && rm e2e-test.db
```

### 依存関係エラー

```bash
# クリーンインストール
rm -rf node_modules pnpm-lock.yaml
pnpm install
```

## 注意事項

- **Ghost使用推奨**: 長時間実行プロセスは必ずGhostでバックグラウンド実行
- **環境分離**: 開発・E2E・本番環境は明確に分離
- **型安全性**: 必ず型チェックを通してからコミット
- **テスト実行**: PR作成前に全テストの実行を推奨