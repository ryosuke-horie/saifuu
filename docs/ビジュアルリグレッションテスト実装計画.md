# ビジュアルリグレッションテスト実装計画

## 実装目的と背景

### 目的
- UIコンポーネントの視覚的な回帰テストを自動化し、デザインシステムの品質向上と開発効率の向上を実現する
- 既存のVitest + Storybookテスト環境を拡張し、統一されたテスト戦略を構築する
- 無料のOSSソリューションにより、コストを抑えつつ継続可能な運用を実現する

### 背景
- issue-32「Storybookを活用したコンポーネント回帰テストのsetup」への対応
- 現在のテスト戦略（Unit: Vitest、Component: Storybook、E2E: Playwright）にVisual Regression Testingを統合
- GitHub Actions無料枠制約下での効率的なCI/CD運用の必要性

## 採用技術

**storybook-addon-vis + Vitest**を採用し、既存のVitest環境と統合したビジュアルリグレッションテストを実装します。

技術選定の詳細は[docs/ビジュアルリグレッションテスト技術選定.md](./ビジュアルリグレッションテスト技術選定.md)を参照してください。

## 実装フェーズ

### Phase 1: 基盤構築（Week 1-2）
**目標**: 基本的なビジュアルテスト環境の構築

#### タスク
1. **パッケージインストールと基本設定**
   - `storybook-addon-vis`、`@storybook/addon-vitest`のインストール
   - `vitest.config.ts`の拡張（Browser Mode + vis plugin設定）
   - `vitest.setup.ts`の拡張（vis lifecycle設定）
   - `.storybook/main.ts`へのアドオン追加

2. **初期設定検証**
   - 基本的なコンポーネント（Button）でのPoC実施
   - スナップショット生成・比較の動作確認
   - Storybook UIでのテスト実行確認

3. **プロジェクト設定調整**
   - `.gitignore`更新（`__vis__/`ディレクトリ設定）
   - `package.json`スクリプト追加
   - 開発環境での動作確認

#### 完了条件
- [ ] 1つ以上のコンポーネントでビジュアルテストが正常実行される
- [ ] スナップショットの生成・更新・比較が機能する
- [ ] Storybook UIからテスト実行できる

### Phase 2: コアコンポーネント対応（Week 3-4）
**目標**: 主要UIコンポーネントへのビジュアルテスト適用

#### タスク
1. **対象コンポーネント選定**
   - Button、Dialog、Input、Card等の基本コンポーネント
   - 各コンポーネントのストーリーにsnapshotタグ付与
   - エラー状態、ローディング状態等のパターン網羅

2. **テストケース設計**
   - 正常系・異常系・境界値パターンの定義
   - レスポンシブデザインパターンの検証方法確立
   - インタラクション前後のビジュアル検証

3. **運用ルール策定**
   - スナップショット更新フロー
   - レビュープロセス
   - 差分確認・承認手順

#### 完了条件
- [ ] 5-10個の主要コンポーネントでビジュアルテスト実装
- [ ] 運用ドキュメント作成
- [ ] チーム内での実行手順共有

### Phase 3: CI/CD統合（Week 5-6）
**目標**: GitHub ActionsでのビジュアルテストCI実行

#### タスク
1. **ワークフロー設計**
   - ビジュアルテスト専用ワークフローの作成
   - セルフホストランナーでの実行最適化
   - アーティファクト（差分画像）の保存設定

2. **自動化設定**
   - PR作成時の自動テスト実行
   - ベースライン更新の自動化
   - 失敗時の差分画像表示

3. **パフォーマンス最適化**
   - テスト実行時間短縮
   - 並列実行の設定
   - キャッシュ戦略（制約内での最適化）

#### 完了条件
- [ ] GitHub ActionsでビジュアルテストがCI実行される
- [ ] PR毎のテスト結果が確認できる
- [ ] 失敗時の差分確認フローが確立される

### Phase 4: 拡張・最適化（Week 7-8）
**目標**: 対象範囲拡大と運用最適化

#### タスク
1. **対象拡大**
   - 複合コンポーネント（Form、Navigation等）への適用
   - ページレベルコンポーネントの検討
   - Edge caseの追加

2. **メンテナンス性向上**
   - 共通設定の抽出
   - テストデータの一元管理
   - False positiveの削減

3. **ドキュメント整備**
   - トラブルシューティングガイド
   - ベストプラクティス集
   - 新規メンバー向けオンボーディング

#### 完了条件
- [ ] 20個以上のコンポーネントでビジュアルテスト運用
- [ ] 運用ドキュメント完備
- [ ] メンテナンスコスト最小化

### Phase 5: チーム運用確立（Week 9-10）
**目標**: チーム全体での継続的運用体制確立

#### タスク
1. **教育・トレーニング**
   - チームメンバーへの使用方法レクチャー
   - トラブルシューティング対応研修
   - コードレビュー観点の共有

2. **プロセス統合**
   - 既存開発フローへの組み込み
   - デザインレビュープロセスとの連携
   - リリースフローへの統合

3. **監視・改善**
   - テスト実行状況の監視
   - False positive/negative率の監視
   - 継続的改善プロセスの確立

#### 完了条件
- [ ] チーム全員がビジュアルテストを運用できる
- [ ] 開発フローに完全統合される
- [ ] 継続的改善サイクルが確立される

### Phase 6: 安定運用・フィードバック（Week 11-12）
**目標**: 安定運用と将来改善計画策定

#### タスク
1. **運用実績評価**
   - バグ検出率の測定
   - 開発効率への影響評価
   - コスト効果の分析

2. **将来計画策定**
   - スケールアップ計画
   - 新技術評価（Chromatic等）
   - 他プロジェクトへの展開検討

3. **ナレッジ蓄積**
   - 運用ノウハウの文書化
   - 失敗事例・成功事例の蓄積
   - 改善提案の整理

#### 完了条件
- [ ] 安定運用体制確立
- [ ] 運用実績レポート作成
- [ ] 将来改善計画策定

## スケジュール概要

| フェーズ | 期間 | 主要マイルストーン |
|---------|------|------------------|
| Phase 1 | Week 1-2 | 基盤構築完了 |
| Phase 2 | Week 3-4 | コアコンポーネント対応完了 |
| Phase 3 | Week 5-6 | CI/CD統合完了 |
| Phase 4 | Week 7-8 | 拡張・最適化完了 |
| Phase 5 | Week 9-10 | チーム運用確立 |
| Phase 6 | Week 11-12 | 安定運用・評価完了 |

**総期間**: 約3ヶ月（12週間）

## リスクと対策

### 技術的リスク

#### 1. Vitest Browser Mode（実験的機能）の不安定性
**リスク**: 実験的機能のため、予期しない動作やパフォーマンス問題
**対策**: 
- Phase 1での徹底的な検証実施
- フォールバック案（Storybook Test Runner）の準備
- 定期的なアップデート追跡

#### 2. セルフホストランナーでの実行時間増加
**リスク**: ビジュアルテスト追加によるCI実行時間の大幅増加
**対策**:
- 並列実行によるパフォーマンス最適化
- テスト対象の戦略的選別
- 段階的な導入により影響最小化

### 運用リスク

#### 3. False Positiveの多発
**リスク**: 意図しない差分による頻繁なテスト失敗
**対策**:
- 初期設定での閾値調整
- 動的要素（時刻、アニメーション）の適切なモック
- 段階的なテスト追加による問題早期発見

#### 4. メンテナンス負荷の増加
**リスク**: スナップショット管理やレビューによる工数増加
**対策**:
- 自動化によるメンテナンス工数削減
- 明確な運用ルールとプロセス策定
- 定期的な不要テストの整理

## 成功指標

### 定量指標
- **テストカバレッジ**: コンポーネント数20個以上でビジュアルテスト実装
- **バグ検出率**: UIバグの事前検出率80%以上
- **CI実行時間**: 追加による増加を20%以内に抑制
- **False Positive率**: 月間5%以下に維持

### 定性指標
- チーム全員がツールを理解・運用できている
- 開発フローにスムーズに統合されている
- デザインレビューの効率が向上している
- リリース後のUIバグが減少している

## 必要リソース

### 人的リソース
- **プライマリ開発者**: 1名（全フェーズ対応）
- **レビュアー**: 1名（設定・ドキュメントレビュー）
- **チームメンバー**: 全員（Phase 5での運用習得）

### 技術リソース
- 開発環境: ローカル開発マシン
- CI環境: セルフホストランナー（既存）
- ストレージ: スナップショット保存用（gitリポジトリ内）

### 学習リソース
- storybook-addon-vis公式ドキュメント
- Vitest Browser Mode関連資料
- 関連技術ブログ・事例調査

## 品質保証

### テスト戦略
- Phase 1での小規模PoC実施
- 各フェーズ終了時の動作確認
- 本番環境投入前の総合テスト実施

### レビュープロセス
- 設定ファイル変更時のコードレビュー必須
- ドキュメント更新時のチームレビュー
- 各フェーズ完了時の振り返り実施

## 継続的改善

### モニタリング項目
- テスト実行成功率
- 差分検出精度
- チーム満足度
- 開発効率指標

### 改善サイクル
- 月次: 運用状況レビュー
- 四半期: 大幅改善検討
- 年次: 技術スタック見直し

---

---

**作成日**: 2025年7月6日  
**更新日**: 2025年7月6日  
**対象Issue**: #32  
**ブランチ**: issue-32  
**想定期間**: 3ヶ月（12週間）  
**次のアクション**: Phase 1の実装開始  
**関連ドキュメント**:
- [docs/ビジュアルリグレッションテスト技術選定.md](./ビジュアルリグレッションテスト技術選定.md)
- [docs/ビジュアルリグレッションテスト実装ガイド.md](./ビジュアルリグレッションテスト実装ガイド.md)