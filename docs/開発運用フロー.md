# 開発運用フロー

## 概要

Saifuuプロジェクトの開発から本番リリースまでの運用フローを定義します。このドキュメントは、チーム開発を想定した標準的なGitフローと、CI/CDパイプラインを活用した効率的な開発プロセスを示します。

## ブランチ戦略

### メインブランチ

1. **main**
   - 本番環境にデプロイされるブランチ
   - 直接のコミットは禁止
   - マージはPR経由のみ
   - 常にデプロイ可能な状態を維持

2. **develop**（将来的に検討）
   - 開発の統合ブランチ
   - 次期リリースの機能を集約
   - 現在はmainブランチに直接マージする運用

### 作業ブランチ

作業ブランチは以下の命名規則に従います：

- `feat/issue-{番号}`: 新機能開発
- `fix/issue-{番号}`: バグ修正
- `chore/issue-{番号}`: ビルド・設定変更
- `docs/issue-{番号}`: ドキュメント更新
- `refactor/issue-{番号}`: リファクタリング
- `test/issue-{番号}`: テスト追加・修正

例：`feat/issue-93`、`fix/issue-124`

## 開発フロー

### 1. Issue作成

開発タスクは必ずGitHub Issueとして管理します：

1. **Issue作成**
   - タイトル：簡潔で分かりやすい説明
   - 本文：背景、目的、実装内容を記載
   - ラベル：feature, bug, documentationなど
   - マイルストーン：リリース予定を設定

2. **Issue番号の取得**
   - ブランチ名に使用
   - PRタイトルに含める
   - コミットメッセージで参照

### 2. ローカル開発

```bash
# 1. mainブランチから作業ブランチを作成
git checkout main
git pull origin main
git checkout -b feat/issue-93

# 2. 開発作業
# - コードの実装
# - テストの作成
# - ドキュメントの更新

# 3. 定期的なコミット
git add .
git commit -m "feat: issue-93 支出登録フォームを追加"

# 4. 型チェック・リント・テスト実行
pnpm run check:fix
pnpm run test:unit
pnpm run test:e2e  # ローカルで実行

# 5. リモートへプッシュ
git push origin feat/issue-93
```

### 3. プルリクエスト（PR）

#### PR作成

1. **タイトル**
   ```
   feat: issue-93 支出管理メインページ実装
   ```

2. **説明テンプレート**
   ```markdown
   ## 概要
   Issue #93 の実装です。
   支出管理のメインページを実装しました。

   ## 変更内容
   - [ ] 支出一覧ページの実装
   - [ ] 支出登録フォームの追加
   - [ ] 支出編集・削除機能
   - [ ] テストの追加

   ## テスト
   - [ ] ユニットテスト追加
   - [ ] E2Eテスト実行（ローカル）

   ## スクリーンショット
   （UIの変更がある場合）

   ## 関連Issue
   Closes #93
   ```

#### レビュー対応

1. **CI確認**
   - 全てのCIチェックがパスすることを確認
   - 失敗時は修正してプッシュ

2. **レビュー対応**
   - レビューコメントに返信
   - 修正は追加コミットで対応
   - 必要に応じてコミットをsquash

3. **マージ準備**
   - Approveを得る
   - CIが全てグリーン
   - コンフリクトの解決

### 4. デプロイメント

#### 開発環境

- PRごとにプレビュー環境が自動作成（Cloudflare Workers）
- PRコメントにプレビューURLが投稿される

#### 本番環境

1. **自動デプロイ**（現在は手動）
   ```bash
   # mainブランチへのマージ後
   pnpm run deploy:manual
   ```

2. **将来的な自動化**
   - mainブランチへのマージで自動デプロイ
   - GitHub Actionsでのデプロイワークフロー

## CI/CDパイプライン

### GitHub Actions

現在実装されているワークフロー：

1. **frontend.yaml**
   - トリガー：PR、mainへのプッシュ
   - 実行内容：
     - 依存関係インストール
     - 型チェック（TypeScript）
     - リント（Biome）
     - ユニットテスト（Vitest）
     - カバレッジレポート

2. **api.yaml**
   - トリガー：PR、mainへのプッシュ
   - 実行内容：
     - 依存関係インストール
     - 型チェック
     - テスト実行

### 品質チェック

PRマージの必須条件：

- [ ] 全CIチェックがパス
- [ ] コードレビューのApprove
- [ ] 重要な機能に対する適切なテストの実装
- [ ] コンフリクトなし

## コミュニケーション

### 日次スタンドアップ（チーム開発時）

- 昨日の作業内容
- 今日の予定
- ブロッカーの共有

### PR/Issue運用

1. **ラベル活用**
   - `WIP`: 作業中
   - `ready for review`: レビュー待ち
   - `blocked`: ブロックされている

2. **コメント**
   - 設計意図の説明
   - 実装の選択理由
   - 懸念事項の共有

## トラブルシューティング

### よくある問題

1. **型エラー**
   ```bash
   # 型チェックの実行
   pnpm run check:fix
   ```

2. **テスト失敗**
   ```bash
   # 特定のテストを実行
   pnpm run test:unit -- path/to/test
   ```

3. **マージコンフリクト**
   ```bash
   # mainブランチの最新を取り込む
   git checkout main
   git pull origin main
   git checkout feat/issue-xxx
   git merge main
   # コンフリクトを解決
   ```

## ベストプラクティス

### コード品質

1. **小さなPR**
   - 1つのPRは1つの機能
   - レビューしやすいサイズ
   - 500行以内を目安

2. **テストファースト**
   - TDD（テスト駆動開発）の実践
   - Red → Green → Refactoring

3. **ドキュメント更新**
   - コードと同時にドキュメント更新
   - 設計意図をコメントで記載

### セキュリティ

1. **秘密情報**
   - 環境変数で管理
   - .envファイルはコミットしない
   - wrangler secretで管理

2. **依存関係**
   - 定期的な更新
   - セキュリティアラートへの対応

## 今後の改善計画

1. **自動化の強化**
   - semantic-releaseの導入
   - 自動CHANGELOGの生成
   - デプロイの完全自動化

2. **監視・アラート**
   - エラー監視の導入
   - パフォーマンス監視
   - アラート通知の設定

3. **開発環境の改善**
   - DevContainerの活用
   - 統一された開発環境
   - オンボーディングの簡素化