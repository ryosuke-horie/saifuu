# キーボードナビゲーション

Issue #250で実装されたキーボードナビゲーション機能の詳細ドキュメント。

## 概要

アプリケーション全体のキーボードアクセシビリティを向上させるため、以下の機能を実装しました：

1. **フォーカストラップ** - ダイアログ内でのTab/Shift+Tabナビゲーション
2. **フォームショートカット** - Cmd/Ctrl+Enterで送信、Escapeでキャンセル
3. **グローバルショートカット** - アプリケーション全体で使用可能なショートカット

## 実装詳細

### 1. Dialogコンポーネントのフォーカストラップ

`Dialog`コンポーネント内でTabキーを押した際、フォーカスがダイアログ内に留まるように実装しました。

#### 動作仕様
- **Tab**: 次のフォーカス可能な要素へ移動
- **Shift+Tab**: 前のフォーカス可能な要素へ移動
- 最後の要素からTabを押すと最初の要素へ循環
- 最初の要素からShift+Tabを押すと最後の要素へ循環

#### フォーカス可能な要素
- ボタン（`disabled`でないもの）
- リンク（`href`属性があるもの）
- 入力フィールド（`disabled`でないもの）
- セレクトボックス（`disabled`でないもの）
- テキストエリア（`disabled`でないもの）
- `tabindex`が-1でない要素
- `contenteditable`な要素

### 2. フォームのキーボードショートカット

`ExpenseForm`と`SubscriptionForm`に以下のショートカットを実装：

#### ショートカット一覧
- **Cmd+Enter（Mac）/ Ctrl+Enter（Windows/Linux）**: フォームを送信
- **Escape**: フォームをキャンセル（`onEscape`プロップが指定されている場合）

#### 実装方法
```tsx
// ExpenseFormPropsに追加
interface ExpenseFormProps {
  // ... 既存のプロップ
  onEscape?: () => void; // Escapeキー押下時のコールバック
}
```

### 3. グローバルキーボードショートカット

`useKeyboardShortcuts`フックで以下のショートカットを利用可能：

#### ショートカット一覧
- **Cmd/Ctrl+N**: 新規作成
- **Cmd/Ctrl+K**: 検索
- **Cmd/Ctrl+S**: 保存
- **Escape**: キャンセル
- **?（Shift+/）**: ヘルプ

#### 使用方法
```tsx
import { useKeyboardShortcuts } from '@/hooks/useKeyboardShortcuts';

function MyComponent() {
  useKeyboardShortcuts({
    onNewItem: () => console.log('新規作成'),
    onSearch: () => console.log('検索'),
    onSave: () => console.log('保存'),
    onCancel: () => console.log('キャンセル'),
    onHelp: () => console.log('ヘルプ'),
    enabled: true // ショートカットの有効/無効
  });
}
```

#### 注意事項
- 入力フィールドにフォーカスがある場合、Escape以外のショートカットは無効
- ブラウザのデフォルト動作（Cmd/Ctrl+Sでの保存ダイアログなど）は防止される

## 技術的実装

### ユーティリティ関数

#### keyboard.ts
- `getFocusableElements()`: フォーカス可能な要素を取得
- `handleFocusTrap()`: フォーカストラップの実装
- `isInputFocused()`: 入力フィールドにフォーカスがあるか判定
- `isModifierPressed()`: Cmd/Ctrlキーが押されているか判定

#### form-keyboard.ts
- `handleFormKeyboardShortcuts()`: フォーム用ショートカットの処理
- `createTouchAllFields()`: フィールドのタッチ状態を管理するユーティリティ

### 型安全性

Matt Pocock氏の推奨パターンに従い、以下の型安全性を確保：

- `satisfies`演算子による型推論の改善
- `as const`による厳密な型定義
- ジェネリクスによる型の再利用性
- 型ガードによる実行時の型チェック

## テスト

以下のテストを実装：

1. **Dialog.keyboard.test.tsx**: フォーカストラップのテスト
2. **ExpenseForm.keyboard.test.tsx**: フォームショートカットのテスト
3. **SubscriptionForm.keyboard.test.tsx**: フォームショートカットのテスト
4. **useKeyboardShortcuts.test.tsx**: グローバルショートカットのテスト

## 今後の拡張

- より多くのグローバルショートカットの追加
- ショートカットのカスタマイズ機能
- ショートカット一覧の表示機能
- アクセシビリティのさらなる向上