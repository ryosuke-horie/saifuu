# API型定義整理プラン

## 現状分析

### 既存のファイル構成
```
api/src/types/
├── api.ts                # 共通API型定義（TransactionResponse, StatsResponse, ErrorResponse）
├── subscription.ts       # サブスクリプション関連の詳細な型定義
├── subscription-utils.ts # サブスクリプション変換・バリデーション関数
└── index.ts             # エクスポート統合
```

### 発見された課題

1. **型定義の重複と不整合**
   - カテゴリ型が複数箇所で定義されている（subscription.ts, subscription-utils.ts, routes内）
   - エラーレスポンス型が複数存在（api.ts: ErrorResponse, subscription.ts: ApiErrorResponse）
   - TransactionWithCategory型がutils/transaction-utils.tsに分離されている

2. **命名規則の不統一**
   - プレフィックスの混在：Api〜、Db〜、無し
   - Response/Requestの使用が不統一

3. **Zodスキーマとの分離**
   - 型定義とバリデーションロジックが分離されている
   - shared/src/validation/zod-schemasとの整合性が不明確

4. **エクスポート方法の不統一**
   - index.tsでは一部の型のみエクスポート
   - 実際のroutesでは型をインポートせず、ローカルに定義している

## 整理方針

### 1. ディレクトリ構造の改善
```
api/src/types/
├── common/              # 共通型定義
│   ├── index.ts        # 基本型（ID、日付、ページネーション等）
│   ├── errors.ts       # エラーレスポンス型
│   └── category.ts     # カテゴリ型（統一版）
├── transaction/         # 取引関連
│   ├── index.ts        # 取引型定義
│   ├── requests.ts     # リクエスト型
│   ├── responses.ts    # レスポンス型
│   └── utils.ts        # 変換・バリデーション関数
├── subscription/        # サブスクリプション関連（既存を整理）
│   ├── index.ts        # 基本型定義
│   ├── requests.ts     # リクエスト型
│   ├── responses.ts    # レスポンス型
│   └── utils.ts        # 変換・バリデーション関数
└── index.ts            # 統合エクスポート
```

### 2. 命名規則の統一

#### プレフィックスルール
- **リクエスト型**: `〜Request`（例：CreateTransactionRequest）
- **レスポンス型**: `〜Response`（例：TransactionResponse）
- **データベース型**: `Db〜`（例：DbTransaction）
- **API変換後の型**: プレフィックスなし（例：Transaction）

#### 共通型の命名
- ID型: `EntityId<T>` (ジェネリック型として定義)
- 日付型: `ISODateString` (string型のブランド型)
- ページネーション: `PaginationParams`, `PaginatedResponse<T>`

### 3. Zodスキーマとの統合

- 各リクエスト型に対応するZodスキーマを同じファイルで定義
- 型とバリデーションの一貫性を保証
- z.inferを使用して型の重複定義を避ける

### 4. 実装手順

1. **共通型定義の作成**（common/）
   - 基本型、エラー型、カテゴリ型を統一
   - 型ガード関数も同じファイルに配置

2. **取引型定義の整理**（transaction/）
   - 現在routesに散在している型を集約
   - api.tsから移動

3. **サブスクリプション型の整理**（subscription/）
   - 既存のファイルを新構造に再編成
   - 重複削除と命名統一

4. **統合エクスポートの更新**（index.ts）
   - すべての型を適切にエクスポート
   - 使いやすいパス構造を提供

5. **既存コードの更新**
   - routes/以下のファイルを新しい型定義を使用するよう更新
   - ローカル型定義を削除

## 期待される効果

1. **型の再利用性向上**
   - 統一されたカテゴリ型により、コードの重複を削減
   - 共通型により、一貫性のあるAPI設計が可能

2. **保守性の向上**
   - 明確な構造により、型の場所が予測可能
   - 命名規則により、型の用途が明確

3. **フロントエンドとの型共有準備**
   - 整理された型定義により、将来的な型共有が容易
   - API契約の明確化

4. **開発効率の向上**
   - インポートパスの簡略化
   - 型とバリデーションの統合により、実装ミスを削減

## リスクと対策

- **破壊的変更**: 段階的な移行とテストにより対応
- **ビルドエラー**: 型チェックを都度実行して確認
- **パフォーマンス**: 型定義の分割により、必要な型のみインポート可能