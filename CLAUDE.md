# Saifuu - 家計管理アプリケーション

## プロジェクト概要

完全個人用の家計管理アプリケーション。支出・収入の記録と分析、サブスクリプション管理を行うためのWebアプリケーション。

## 機能

- 支出/収入を登録/編集/一覧するインターフェース
- 支出/収入を中心にデータベースに保存
- サブスクの管理

## 技術スタック

### フレームワーク・ランタイム

#### フロントエンド
- **Next.js v15** - フルスタックWebフレームワーク
- **React 19** - UIライブラリ
- **Cloudflare Workers** - エッジランタイム環境
- **TypeScript** - 型安全な開発

#### バックエンド
- **hono** - API用フレームワーク
- **drizzle** - D1へアクセスするORM

### スタイリング・UI
- **Tailwind CSS v4** - ユーティリティファーストCSSフレームワーク

### 開発ツール
- **Vite** - 高速なビルドツール
- **Biome** - コードフォーマッター・リンター
- **npm** - パッケージマネージャー

### テスト・開発ツール
- **Playwright** - E2Eテストフレームワーク（専用ディレクトリで開発環境のみ実行）
- **Vitest** - ユニットテストフレームワーク
- **React Testing Library** - Reactコンポーネントテスト
- **Storybook** - コンポーネント開発・テスト環境
- **MSW (Mock Service Worker)** - APIモック

### データベース・状態管理
- **Cloudflare D1** - SQLiteベースのエッジデータベース（予定）
- **Zod** - スキーマバリデーション

## 開発ルール

### 1. コメント規約
- コメントは必ず日本語で記載する
- 設計意図を明確に記載する
- なぜその実装を選択したのか、代替案は何かを記載する

```typescript
// 例: 
// この関数は支出データを集計するために使用される
// 月単位での集計を行い、カテゴリ別の内訳を返す
// 代替案: 日次集計も検討したが、UIの要件から月次で十分と判断
```

### 2. 型チェック・リント
- 何か追加・修正する前や修正後、Commit前に適宜ローカルで `npm run check:fix` を実行し型エラーやフォーマットを検証する
- 必ず `npm run check:fix` を実行してから作業を終える
- 型エラーとリントエラーを放置しない
- Biomeの設定に従う

### 3. コミット規約
- 頻繁にコミットする（機能の小さな単位で）
- コミットメッセージは以下のプレフィックスを使用し、日本語で記載する：
  - `feat:` 新機能
  - `fix:` バグ修正
  - `chore:` ビルドプロセスや補助ツールの変更
  - `docs:` ドキュメントの変更
  - `style:` コードの意味に影響しない変更（空白、フォーマット等）
  - `refactor:` バグ修正や機能追加を伴わないコードの変更
  - `test:` テストの追加や既存テストの修正

```bash
# 例:
git commit -m "feat: 支出登録フォームを追加"
git commit -m "fix: 収入一覧の表示バグを修正"
git commit -m "chore: ESLintからBiomeに移行"
```

### 4. 署名設定
- コミット時の署名は必ず `ryosuke-horie` のみとする
- Co-Authoredは設定しない

### 5. テスト

- t-wadaやKent C dodds. の提唱するTDDに従って実装を進めます。
- Red, Green, refacotring
- E2Eテストは基本的に正常系の最小限のテストケースを実装します。
- DBが中心ですが外部のI/Oに関連するようなテストケースは統合テストを実装します。
- テスト環境のDBと開発環境のDBと本番環境のDBは明確に分割する必要があります。
- Unitテストは基本的に8割以上のカバレッジを目標に実装し、手厚く書きます。
- Playwright, MSWやVitest, Storybookを利用します。
- タスクが進むごとに細かくテストを実施し検証します。特にPRを更新する前に確認します。
- PRはテストが失敗する限りマージされることはありません。

#### テスト戦略（2025年1月〜）

VRT(Visual Regression Testing)システムを削除し、以下の3層構造による効率的な品質担保に移行：

- **Storybookコンポーネントテスト**: UIの状態・インタラクション確認
- **ユニットテスト**: ロジック・バリデーション・エラーハンドリング
- **最小限のE2Eテスト**: 正常系の主要ユーザーフロー

**詳細**: [ADR-001: VRTシステムの削除](./docs/adr/001-remove-vrt-system.md)、[テストガイド](./docs/テストガイド.md)

### 6. 技術スタックに関連した最新情報の取得

- Context7 MCPを利用して最新情報を取得する
- 特にNextjs, React, Drizzle, Cloudflare, honoは更新が早いため最新情報からデータを取得する必要がある。

### 7. ドキュメント作成規約

**重要**: すべてのプロジェクトドキュメントは**日本語ファイル名のMarkdownファイル**として**docs/ディレクトリ以下**に作成する

- **配置場所**: すべてのプロジェクトドキュメントは `docs/` ディレクトリ以下に配置する
- **ファイル形式**: Markdownファイル（`.md` 拡張子）を使用する
- **ファイル名**: 日本語でのファイル名を使用し、内容が明確に分かる名前をつける
- **構成**: 機能や目的に応じてサブディレクトリに分類する

```
docs/
├── テストガイド.md           # テスト全般の方針とガイド
├── テストケース分析.md       # テストケースの分析結果
├── 開発環境エラー修正プラン.md # 開発環境のトラブルシューティング
├── api/                      # API関連ドキュメント
│   ├── README.md
│   └── setup.md
└── storybook/                # Storybook関連ドキュメント
    ├── 実装詳細.md
    └── 使用方法ガイド.md
```

- **内容**: 日本語で記載し、技術的な背景や設計意図を含める
- **更新**: ドキュメントは実装と同時に更新し、常に最新状態を保つ
- **禁止事項**: `frontend/docs/`、`api/docs/`、`.storybook/`等の分散配置は行わない

## 開発環境セットアップ

### 1. 前提条件
- **mise** - Node.jsバージョン管理ツール
- プロジェクトルートに `.mise.toml` でNode.js 22を固定

### 2. 初回セットアップ
```bash
# mise経由でNode.js 22をインストール
mise install

# 依存関係のインストール
npm ci
```

### 3. 開発環境の確認
```bash
# Node.jsバージョンの確認（22系であることを確認）
node --version
```

## スクリプト

```bash
# 開発サーバー起動(あなた(=Claude)は開発サーバーの起動を行うと他の作業ができなくなるため、ユーザー(=開発者)に別セッションでの起動を依頼すること。)
npm run  dev

# 型チェックとリント修正
npm run check:fix

# ビルド
npm run build

# Storybook起動
npm run storybook

# Storybookビルド
npm run build-storybook

# E2Eテスト（e2eディレクトリで実行）
npm run test:e2e

# E2EテストUI付き実行
npm run test:e2e:ui

# E2Eテストレポート表示
npm run test:e2e:report

# ユニットテスト
npm run test:unit

# デプロイ（Cloudflare Workers）
# 注意: Workers Build自動化との競合を避けるため、手動デプロイスクリプトは deploy:manual に変更されています
npm run deploy:manual
```

## プロジェクト構造

```
saifuu/
├── api/                   # APIアプリケーション
│   ├── src/              # APIソースコード
│   │   ├── routes/       # APIエンドポイント
│   │   ├── db/           # データベース設定
│   │   └── __tests__/    # APIテスト
│   ├── drizzle/          # データベースマイグレーション
│   └── package.json      # API依存関係
├── frontend/             # フロントエンドアプリケーション
│   ├── src/              # フロントエンドソースコード
│   │   ├── app/          # Next.jsアプリディレクトリ
│   │   ├── components/   # 共通コンポーネント
│   │   │   ├── **/*.stories.tsx  # Storybookストーリー
│   │   │   └── **/*.tsx  # コンポーネント本体
│   │   ├── hooks/        # カスタムフック
│   │   ├── lib/          # ライブラリ・ユーティリティ
│   │   └── types/        # 型定義
│   ├── .storybook/       # Storybook設定
│   │   ├── main.ts       # Storybook設定ファイル
│   │   ├── preview.tsx   # グローバル設定・デコレーター
│   │   └── mocks/        # MSWモックファイル
│   ├── public/           # 静的ファイル
│   └── package.json      # フロントエンド依存関係
├── e2e/                  # E2Eテスト専用ディレクトリ
│   ├── homepage.spec.ts  # ホームページE2Eテスト
│   ├── subscriptions.spec.ts # サブスクリプションE2Eテスト
│   ├── playwright.config.ts  # Playwright設定
│   └── package.json      # E2E専用依存関係
├── docs/                 # プロジェクトドキュメント
│   ├── テストガイド.md  # テスト全般の方針
│   └── api/              # API関連ドキュメント
└── CLAUDE.md            # このファイル
```

## Storybook コンポーネント開発

### 概要
Storybookを使用したコンポーネント駆動開発により、UIコンポーネントの品質向上と開発効率化を実現します。

### 基本方針
- **コンポーネント分離開発** - アプリケーションロジックから独立したコンポーネント開発
- **ストーリー駆動設計** - 使用パターンを明確化したストーリー作成
- **MSWによるAPIモック** - 実際のAPIに依存しない開発環境
- **包括的テストパターン** - 正常系・異常系・エッジケースの網羅

### ストーリー作成ガイドライン

#### 1. ファイル配置
```bash
# ストーリーファイルはコンポーネントと同じディレクトリに配置
app/components/[category]/[component-name].stories.tsx
```

#### 2. 基本的なストーリー構造
```typescript
// app/components/example/example.stories.tsx
import type { Meta, StoryObj } from "@storybook/react";
import { ExampleComponent } from "./example";

const meta: Meta<typeof ExampleComponent> = {
  title: "Components/ExampleComponent",
  component: ExampleComponent,
  parameters: {
    layout: "padded",
    docs: {
      description: {
        component: "コンポーネントの説明とユースケース"
      }
    }
  },
  argTypes: {
    // プロパティ制御の定義
  },
  args: {
    // デフォルト値
  },
  tags: ["autodocs"],
};

export default meta;
type Story = StoryObj<typeof meta>;

// 基本ストーリー
export const Default: Story = {};

// バリエーション
export const Loading: Story = { ... };
export const Error: Story = { ... };
export const Empty: Story = { ... };
```

#### 3. 必須ストーリーパターン
- **Default**: 基本的な使用状態
- **Loading**: ローディング状態（該当する場合）
- **Error**: エラー状態（該当する場合）
- **Empty**: 空データ状態（該当する場合）
- **Edge Cases**: 境界値・特殊ケース

#### 4. APIモックの使用
```typescript
// MSWを使用したAPIモック
export const WithApiData: Story = {
  parameters: {
    msw: {
      handlers: [
        http.get("/api/endpoint", () => {
          return HttpResponse.json({ data: "mock data" });
        }),
      ],
    },
  },
};
```

#### 5. インタラクションテスト
```typescript
import { expect, userEvent, within } from "@storybook/test";

export const InteractionTest: Story = {
  play: async ({ canvasElement }) => {
    const canvas = within(canvasElement);
    
    // ユーザー操作
    await userEvent.click(canvas.getByRole("button"));
    
    // 結果検証
    await expect(canvas.getByText("期待される結果")).toBeInTheDocument();
  },
};
```

### コンポーネント分類

#### Components/ (汎用コンポーネント)
- **Forms/** - フォーム関連コンポーネント
- **Display/** - 表示専用コンポーネント
- **Navigation/** - ナビゲーション関連
- **Feedback/** - フィードバック・通知

#### [Feature]/ (機能固有コンポーネント)
- **Dashboard/** - ダッシュボード固有
- **Transactions/** - 取引機能固有
- **Subscriptions/** - サブスク機能固有

### テスト戦略

#### 1. テストピラミッド統合
```
E2Eテスト (Playwright)          # 正常系のみ・最小限
    ↑
ストーリーテスト (Storybook)      # コンポーネントテスト  
    ↑
ユニットテスト (Vitest)          # 単体テスト・エラー系
```

#### 2. 責務分担
- **Vitest**: ロジック・ユーティリティ関数・バリデーション・エラーハンドリング
- **Storybook**: コンポーネント表示・インタラクション・レスポンシブ
- **Playwright**: 正常系の主要ユーザーフローのみ

#### 3. E2Eテスト制限方針（重要）
GitHub Actions無料枠を効率的に使用するため、E2Eテストは最小限に制限：

- **対象**: 正常系の主要ユーザーフローのみ
- **ブラウザ**: CI環境ではChromiumのみ（ローカルは複数ブラウザ可）
- **テストケース**: 基本的な取引登録・確認フローのみ
- **除外項目**: エラーハンドリング、レスポンシブ、パフォーマンス

#### 4. E2E以外での品質担保
- **エラーハンドリング**: ユニットテスト・統合テストで検証
- **レスポンシブデザイン**: Storybookでの視覚的確認・ユニットテスト
- **パフォーマンス**: ローカル環境での手動確認・Lighthouse等
- **バリデーション**: ユニットテスト・統合テスト

#### 5. MSWモック戦略
- **共通データ**: `.storybook/mocks/data/` で統一管理
- **ハンドラー分離**: API別にハンドラーを分割
- **エラーパターン**: ネットワーク・サーバーエラーの包括的対応

### 開発ワークフロー

#### 1. 新コンポーネント開発
```bash
1. コンポーネント設計・実装
2. 基本ストーリー作成
3. Storybookで動作確認
4. エッジケース・エラーパターン追加
5. インタラクションテスト追加
6. ドキュメント更新
```

#### 2. 既存コンポーネント修正
```bash
1. 既存ストーリーで影響確認
2. 必要に応じて新ストーリー追加
3. インタラクションテスト更新
4. 全ストーリーで動作確認
```

### ベストプラクティス

#### 1. ストーリー命名
- **意味のある名前**: 状態や用途が明確
- **一貫した命名**: プロジェクト全体で統一
- **階層化**: カテゴリ・サブカテゴリで整理

#### 2. モックデータ設計
- **現実的なデータ**: 実際の使用パターンに即したデータ
- **エッジケース**: 境界値・特殊ケースのカバー
- **パフォーマンス**: 適切なデータ量での動作確認

#### 3. アクセシビリティ
- **a11y アドオン**: 自動アクセシビリティチェック
- **セマンティックHTML**: 適切なHTML要素の使用
- **キーボード操作**: Tab・Enter等での操作確認

### 詳細ドキュメント
- **実装詳細**: `.storybook/IMPLEMENTATION.md`
- **使用方法**: `.storybook/USAGE.md`

## セルフホストランナー運用ルール

### 重要な制約
- **キャッシュ無効**: セルフホストランナーのマシン性能の都合によりNode.js キャッシュは使用しない
- **パフォーマンス優先**: キャッシュによる遅延を避けるため、毎回クリーンインストールを実行
- **複数ランナー対応**: 同一マシンで複数ランナーが同時実行される場合があるため、安全なクリーンアップを実行

### 注意事項
- **複数ランナー同時実行**: 同一マシンで複数ジョブが並行実行される場合、ディレクトリ競合に注意
- **エラー無視**: `|| true` により削除エラーを無視し、ジョブ継続を保証

## E2Eテスト運用方針

### 現在の運用状況
- **ローカル環境専用**: 開発環境でのみE2Eテストを実行
- **専用ディレクトリ**: `e2e/` ディレクトリで独立管理
- **CI環境では無効**: GitHub Actions無料枠節約のためCI実行は行わない

### E2Eテスト実行タイミング
1. **実装完了時**: 新機能やバグ修正の実装完了後
2. **シナリオ変更時**: E2Eテストシナリオを変更した後
3. **PR作成前**: 重要な変更をPRに含める前
4. **定期的な確認**: 開発の節目での動作確認

### E2E実行環境
- **場所**: プロジェクトルート `e2e/` ディレクトリ
- **実行コマンド**: 
  - `npm run test:e2e` - 通常実行
  - `npm run test:e2e:ui` - UI付き実行（デバッグ時）
  - `npm run test:e2e:report` - 結果レポート表示
- **自動サーバー起動**: フロントエンド・API両方を自動起動
- **テストデータ**: E2E専用データベースで独立実行

### 品質担保戦略
- **ユニットテスト**: Vitest によるロジック・ユーティリティのテスト
- **コンポーネントテスト**: Storybook によるUI確認とインタラクションテスト
- **E2Eテスト**: ローカル環境での統合動作確認
- **型チェック・リント**: 自動化されたコード品質チェック

## 開発の進め方

1. 新機能開発時は、まず設計意図をコメントで記載
2. **Storybookでコンポーネント分離開発**
3. 小さな単位で実装し、都度 `npm run check:fix` を実行
4. テストを書く（Storybook・ユニット・E2E）
5. **実装完了時のE2E確認**: 機能実装が完了したら `npm run test:e2e` で動作確認
6. **シナリオ変更時の確認**: E2Eテストシナリオを変更した場合は必ずユーザーに確認を取る
7. 機能の完成度に応じて頻繁にコミット
8. **PR作成前のE2E実行**: 重要な変更がある場合はPR作成前に再度E2E実行
9. プルリクエストを作成してレビュー

### E2Eシナリオ変更時のルール

**重要**: E2Eテストのシナリオ（テストケース、テストデータ、期待動作）を変更する場合は、以下の手順に従う：

1. **変更内容の明確化**: 何をどのように変更するかを明確にする
2. **ユーザーへの確認**: 変更内容をユーザーに説明し、承認を得る
3. **変更理由の記録**: なぜ変更が必要かをコメントまたはコミットメッセージに記載
4. **動作確認**: 変更後に必ず `npm run test:e2e` で全シナリオの動作確認を行う
5. **結果報告**: テスト結果をユーザーに報告する

#### シナリオ変更の例
- テスト対象の画面フロー変更
- 入力データや期待結果の変更
- 新しいテストケースの追加・削除
- テスト環境やセットアップの変更

## 注意事項

- 個人情報や機密情報をコミットしない
- 環境変数は `.env` ファイルで管理し、サンプルは `.env.example` に記載
- Cloudflare Workersのシークレットは `wrangler secret` で管理